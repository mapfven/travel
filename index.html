<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œè¨˜å¸³æœ¬ V8.9a (è³‡æ–™å„²å­˜ä¿®æ­£ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #FFFBEB; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 1rem; 
            padding-top: 100px; 
            padding-bottom: 40px; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: padding-bottom 0.3s;
        }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */
        .btn-big { transition: transform 0.1s; }
        .btn-big:active { transform: scale(0.98); }

        /* å°èˆªæ¬„æ¨£å¼ - è¡Œå‹•é»æ“Šèˆ‡é¡¯ç¤ºå„ªåŒ– */
        .nav-item {
            cursor: pointer; 
            touch-action: manipulation; 
            transition: color 0.2s, transform 0.1s;
        }
        .nav-item.active { color: #4F46E5; font-weight: bold; }
        .nav-item.inactive { color: #9CA3AF; }
        .nav-item:active { transform: scale(0.95); } 
        
        /* é¿å… iOS è¼¸å…¥æ¡†æ”¾å¤§ */
        input, select, textarea {
            font-size: 1rem !important; 
        }

        /* é ‚éƒ¨å°èˆªæ¬„å‹•ç•« */
        #top-nav { 
            transition: transform 0.3s ease-in-out;
            will-change: transform;
            padding-top: env(safe-area-inset-top); 
        }

        /* Modal å‹•ç•« */
        .modal-base {
            transition: opacity 0.2s ease-out, transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-hidden-state { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .modal-visible-state { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* é«˜äº®å‹•ç•« */
        @keyframes highlight-pulse {
            0% { background-color: #dcfce7; }
            100% { background-color: white; }
        }
        .highlight-anim { animation: highlight-pulse 2s ease-out; }
    </style>
</head>

<body onload="init()">
    
    <nav id="top-nav" class="fixed top-0 left-0 right-0 bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 shadow-2xl z-50">
        <div class="max-w-lg mx-auto flex justify-around items-center h-24 text-white"> 
            <button id="tab-members" onclick="switchTab('members')" class="nav-item flex flex-col items-center p-2 pt-3 active text-indigo-400">
                <i class="fa-solid fa-users text-xl"></i>
                <span class="text-xs mt-1">å¤§å®¶</span>
            </button>
            <button id="tab-expenses" onclick="switchTab('expenses')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-white/60">
                <i class="fa-solid fa-receipt text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button id="tab-result" onclick="switchTab('result')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-white/60">
                <i class="fa-solid fa-calculator text-xl"></i>
                <span class="text-xs mt-1">ç®—éŒ¢</span>
            </button>
            <button id="tab-rates" onclick="switchTab('rates')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-white/60">
                <i class="fa-solid fa-money-bill-transfer text-xl"></i>
                <span class="text-xs mt-1">åŒ¯ç‡</span>
            </button>
            <button id="tab-settings" onclick="switchTab('settings')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-white/60">
                <i class="fa-solid fa-cog text-xl"></i>
                <span class="text-xs mt-1">è¨­å®š</span>
            </button>
        </div>
    </nav>
    
    <div class="max-w-lg mx-auto p-4 pt-6">

        <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-6 flex items-center">
            <i class="fa-solid fa-plane-departure text-indigo-600 mr-3"></i> æ—…è¡Œè¨˜å¸³æœ¬
            <div id="rate-warning" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-lg font-bold ml-auto hidden shadow-sm"><i class="fa-solid fa-triangle-exclamation mr-1"></i> åŒ¯ç‡ç•°å¸¸</div>
        </h1>

        <section id="view-members" class="space-y-6 animate-fade-in pb-10">
            
            <div id="rate-settings-container" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-yellow-400">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-3">
                    <i class="fa-solid fa-gear text-yellow-600 mr-2"></i> åŒ¯ç‡åŠŸèƒ½è¨­å®š
                </h3>
                <div class="flex justify-between items-center mb-4">
                    <label for="base-currency-select" class="block text-gray-500 font-bold">åŸºæº–å¹£åˆ¥</label>
                    <select id="base-currency-select" onchange="switchBaseCurrency(this.value)" class="border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                        </select>
                </div>
                <button onclick="fetchLiveRates()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-blue-600">
                    <i class="fa-solid fa-arrow-rotate-right mr-2"></i> æ‰‹å‹•ç¶²è·¯å³æ™‚æ›´æ–°
                </button>
                <div id="calc-rate-info" class="text-center text-sm text-gray-500 mt-2">ä½¿ç”¨å„²å­˜è³‡æ–™</div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-indigo-400">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-user-plus text-indigo-500 mr-2"></i> èª°è¦åŠ å…¥ï¼Ÿ
                </h3>
                <div class="flex gap-3">
                    <input type="text" id="input-member-name" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: é˜¿å…¬)" class="flex-1 border-2 border-gray-300 rounded-xl px-4 text-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" onkeypress="if(event.key === 'Enter') addMember()">
                    <button onclick="addMember()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-md btn-big"> åŠ å…¥ </button>
                </div>
            </div>

            <div class="bg-green-100 p-5 rounded-2xl shadow-lg border-2 border-green-200">
                <h3 class="text-lg font-bold text-green-800 mb-3 flex items-center">
                    <i class="fa-solid fa-money-bill-wave mr-2"></i> å¤§å®¶ä¸€èµ·äº¤å…¬è²»
                </h3>
                <div class="flex flex-col gap-3">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">è¿½åŠ å…¬è²»å¹£åˆ¥ (<span class="current-base-cur">TWD</span>)</label>
                        <input type="number" id="batch-prepaid-amount" placeholder="æ¯äººäº¤å¤šå°‘? (ä¾‹å¦‚ 1000)" step="0.01" inputmode="decimal" class="w-full border-2 border-green-300 rounded-xl px-4 py-3 text-xl font-bold focus:border-green-500">
                    </div>
                    <button onclick="batchAddPrepaid()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center">
                        <i class="fa-solid fa-plus-circle mr-2"></i> ç¢ºå®šï¼æ¯äººéƒ½äº¤éŒ¢
                    </button>
                </div>
            </div>
            <div id="members-section">
                <h3 class="text-lg font-bold text-gray-600 mb-2 pl-2">ç›®å‰æœ‰èª°åœ¨æ—…è¡Œ?</h3>
                <div id="members-list" class="space-y-3">
                    </div>
            </div>

            <div class="bg-yellow-50 p-5 rounded-2xl shadow-lg border-l-8 border-yellow-400">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-coins text-yellow-600 mr-2"></i> å…¬æ¬¾éŒ¢åŒ…è¨­å®š
                </h3>
                <div class="flex justify-between items-center mb-4">
                    <label for="public-fee-collector-select" class="block text-gray-500 font-bold">å…¬æ¬¾ç”±èª°ä»£å¢Š/ä»£æ”¶?</label>
                    <select id="public-fee-collector-select" onchange="switchPublicFeeCollector(this.value)" class="border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-yellow-500">
                        </select>
                </div>
                <div class="flex justify-between items-center">
                    <label class="block text-gray-500 font-bold">å…¬æ¬¾é¤˜é¡ (<span class="current-base-cur">TWD</span>)</label>
                    <p id="public-fee-balance" class="text-2xl font-bold text-green-600">0</p>
                </div>
            </div>

            <div id="tags-setting-section" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-cyan-400">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-tags text-cyan-500 mr-2"></i> è‡ªè¨‚æˆå“¡æ¨™ç±¤
                </h3>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="input-tag-name" placeholder="æ¨™ç±¤åç¨± (ä¾‹å¦‚: å¸æ©Ÿ)" class="flex-1 border-2 border-gray-300 rounded-xl px-4 text-lg focus:border-cyan-500" onkeypress="if(event.key === 'Enter') addCustomTag()">
                    <button onclick="addCustomTag()" class="bg-cyan-500 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-md btn-big"> æ–°å¢ </button>
                </div>
                <div id="custom-tags-list" class="flex flex-wrap gap-2">
                    </div>
            </div>
        </section>

        <section id="view-expenses" class="space-y-6 animate-fade-in pb-10 hidden">
            <div class="bg-white p-6 rounded-3xl shadow-xl border-2 border-indigo-100">
                <h2 class="text-2xl font-bold text-center text-indigo-800 mb-6 flex justify-center items-center">
                    <span class="bg-indigo-100 p-2 rounded-full mr-2"><i class="fa-solid fa-pen"></i></span> è¨˜ä¸€ç­†èŠ±è²»
                </h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-gray-500 font-bold mb-1 ml-1">1. èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ</label>
                        <div class="flex gap-2">
                            <input type="number" id="exp-amount" placeholder="0" inputmode="decimal" step="0.01" class="flex-1 bg-gray-50 border-2 border-gray-300 rounded-2xl px-4 py-4 font-mono font-bold text-4xl text-indigo-700 text-center focus:border-indigo-500">
                            <div class="w-1/3">
                                <select id="exp-currency" class="w-full h-full bg-white border-2 border-gray-300 rounded-2xl px-2 font-bold text-lg text-center">
                                    </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-500 font-bold mb-1 ml-1">2. è²·äº†ä»€éº¼ï¼Ÿ</label>
                        <div class="space-y-2"> <input type="text" id="exp-title" placeholder="è¼¸å…¥åç¨± (ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š)" class="w-full border-2 border-gray-300 rounded-xl px-3 py-1.5 font-bold text-base focus:border-indigo-500" onkeypress="if(event.key === 'Enter') addExpense()">
                            <select id="exp-category" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-base text-center focus:border-indigo-500">
                                <option value="">é¸æ“‡é¡åˆ¥</option>
                                <option value="é¤é£²">ğŸ” é¤é£²</option>
                                <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                <option value="ä½å®¿">ğŸ  ä½å®¿</option>
                                <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option>
                                <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="å…¶ä»–">ğŸ’¡ å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="favorites-list" class="flex flex-wrap gap-2 border-t pt-3 border-gray-100">
                        <button onclick="openFavoriteModal()" class="text-gray-400 hover:text-indigo-500 text-sm font-bold flex items-center">
                            <i class="fa-solid fa-star mr-1"></i> ç·¨è¼¯å¸¸ç”¨æ¸…å–®
                        </button>
                        </div>

                    <div>
                        <label class="block text-gray-500 font-bold mb-1 ml-1">3. èª°å‡ºçš„éŒ¢ï¼Ÿ</label>
                        <div class="flex flex-col gap-2">
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-sm">
                                <label for="is-public-fee" class="flex-1 font-bold text-lg text-gray-700 cursor-pointer">
                                    å…¬æ¬¾æ”¯å‡º
                                </label>
                                <input type="checkbox" id="is-public-fee" onchange="toggleExpenseType(this.checked)" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                            </div>
                            <div id="individual-payer-select-container">
                                <select id="exp-payer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                                    </select>
                            </div>
                        </div>
                    </div>

                    <div id="targets-section">
                        <label class="block text-gray-500 font-bold mb-1 ml-1">4. èª°è¦åˆ†æ”¤ï¼Ÿ</label>
                        <div id="targets-list" class="grid grid-cols-4 gap-2">
                            </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleAllTargets()" class="text-sm text-indigo-500 hover:underline w-full text-right">å…¨é¸ / å–æ¶ˆ</button>
                        </div>
                    </div>
                    
                    <div id="public-fee-note" class="bg-red-50 p-3 rounded-xl text-red-600 text-sm font-bold hidden">
                        <i class="fa-solid fa-circle-info mr-1"></i> é€™ç­†éŒ¢æœƒå¾ã€Œå…¬æ¬¾éŒ¢åŒ…ã€æ‰£é™¤ï¼Œä¸¦ç®—åœ¨æ‰€æœ‰äººçš„å¸³ä¸Šã€‚
                    </div>
                </div>

                <button onclick="addExpense()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg btn-big flex justify-center items-center mt-6">
                    <i class="fa-solid fa-check mr-2"></i> è¨˜ä¸‹ä¾†
                </button>
            </div>

            <div>
                <h3 class="text-xl font-bold text-gray-700 mb-3 ml-2">æœ€è¿‘è¨˜äº†ä»€éº¼?</h3>
                <div id="expenses-list" class="space-y-3 pb-20">
                    </div>
            </div>
        </section>

        <section id="view-result" class="space-y-6 animate-fade-in pb-10 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6 flex justify-center items-center">
                <span class="bg-yellow-100 p-2 rounded-full mr-2"><i class="fa-solid fa-receipt text-yellow-500"></i></span> çµç®—çµæœ (<span class="current-base-cur">TWD</span>)
            </h2>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-red-50 p-4 rounded-2xl shadow-md border-b-4 border-red-400">
                    <p class="text-sm font-medium text-red-500">ç¸½èŠ±è²» (çµç®—å¹£åˆ¥)</p>
                    <p id="total-spend" class="text-2xl font-bold text-red-600 mt-1">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-2xl shadow-md border-b-4 border-green-400">
                    <p class="text-sm font-medium text-green-700">ç¸½é ä»˜/å…¬è²» (çµç®—å¹£åˆ¥)</p>
                    <p id="total-prepaid" class="text-2xl font-bold text-green-700 mt-1">0</p>
                </div>
            </div>

            <div id="member-balance-list" class="space-y-3">
                </div>

            <div>
                <h3 class="text-xl font-bold text-gray-700 mb-3 ml-2 flex items-center">
                    <i class="fa-solid fa-arrow-right-arrow-left text-indigo-500 mr-2"></i> è½‰å¸³çµç®—è¨ˆç•«
                </h3>
                <div id="settlement-plan" class="space-y-3">
                    <div id="plan-loading" class="text-center text-gray-400 py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-lg">
                        <i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨è¨ˆç®—...
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <button onclick="copyReport()" class="bg-gray-800 text-white py-4 rounded-2xl font-bold text-lg shadow hover:bg-black btn-big">
                    <i class="fa-solid fa-copy mr-2"></i> è¤‡è£½ç®—éŒ¢çµæœ (å‚³LINE)
                </button>
            </div>
            
            <div class="h-10"></div>
        </section>

        <section id="view-rates" class="space-y-6 animate-fade-in pb-10 hidden"> 
            
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-indigo-400">
                <div class="flex justify-between items-start mb-2"> 
                    <h3 class="text-xl font-bold text-gray-800 flex items-center"> 
                        <i class="fa-solid fa-calculator text-indigo-500 mr-2"></i> æ›åŒ¯è¨ˆç®—æ©Ÿ 
                    </h3> 
                    <span id="rate-source-badge" class="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded font-bold">è¼‰å…¥ä¸­...</span>
                </div> 
                <div class="flex flex-col gap-3"> 
                    <div class="space-y-2"> 
                        <label for="calc-amount" class="block text-sm font-medium text-gray-700">æ›ç®—é‡‘é¡ (ä¾†æº)</label>
                        <input type="number" id="calc-amount" placeholder="å¤šå°‘éŒ¢?" oninput="updateCalculator()" step="0.01" class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 font-bold text-lg text-gray-700 focus:border-indigo-500"> 
                        <select id="calc-from" onchange="updateCalculator()" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-base text-center focus:border-indigo-500"> 
                            </select> 
                    </div> 
                    <div class="text-center text-gray-500 font-bold text-lg"><i class="fa-solid fa-arrows-up-down"></i></div> 
                    <div class="space-y-2"> 
                        <label for="calc-amount-to" class="block text-sm font-medium text-gray-700">æ›ç®—é‡‘é¡ (ç›®æ¨™)</label>
                        <input type="number" id="calc-amount-to" placeholder="å¤šå°‘éŒ¢?" oninput="updateCalculator(true)" step="0.01" class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 font-bold text-lg text-gray-700 focus:border-indigo-500"> 
                        <select id="calc-to" onchange="updateCalculator()" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-base text-center focus:border-indigo-500"> 
                            </select> 
                    </div>
                </div> 
                <div id="calc-result" class="mt-4 text-center border-t border-gray-100 pt-3"> 
                    <p class="text-gray-500 text-sm">æ›ç®—çµæœ (ç´„)</p> 
                    <p class="text-4xl font-bold text-indigo-600"><span id="calc-result-amount">0</span> <span id="calc-result-cur" class="text-lg">TWD</span></p> 
                </div> 
            </div>
            
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-yellow-400">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-4">
                    <i class="fa-solid fa-cloud-arrow-down text-yellow-600 mr-2"></i> å³æ™‚åŒ¯ç‡åƒè€ƒ (TWD åŸºæº–)
                </h3>
                <div class="text-center">
                    <fxwidget-er inverse="false" amount="100" decimals="2" large="false" shadow="true" symbol="true" flag="true" changes="true" grouping="true" border="false" main-curr="TWD" sel-curr="EUR,USD,CNY,JPY,THB" background-color="#1dacd6"></fxwidget-er>
                    <a href="https://currencyrate.today/" target="_blank" class="text-xs text-gray-400 hover:text-indigo-500 mt-2 block">Powered by CurrencyRate</a>
                </div>
            </div>

            <div id="rate-list-display" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-green-500">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-3">
                    <i class="fa-solid fa-list-check text-green-600 mr-2"></i> ç·¨è¼¯/è‡ªè¨‚åŒ¯ç‡æ¸…å–® (1 å–®ä½ä»–åœ‹å¹£åˆ¥ = ? å–®ä½ <span class="current-base-cur">TWD</span>)
                </h3>
                <div id="rates-list" class="space-y-3">
                    </div>
            </div>

        </section>

        <section id="view-settings" class="space-y-6 animate-fade-in pb-10 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6 flex justify-center items-center">
                <span class="bg-gray-200 p-2 rounded-full mr-2"><i class="fa-solid fa-cog text-gray-600"></i></span> å‚™ä»½èˆ‡è¨­å®š
            </h2>

            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-indigo-400 space-y-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-cloud-arrow-down text-indigo-500 mr-2"></i> è³‡æ–™å‚™ä»½/åŒ¯å…¥
                </h3>
                <button onclick="exportData('json')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-indigo-700">
                    <i class="fa-solid fa-download mr-2"></i> åŒ¯å‡ºå‚™ä»½æª”æ¡ˆ (.json)
                </button>
                <button onclick="exportData('text')" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-indigo-600">
                    <i class="fa-solid fa-file-lines mr-2"></i> åŒ¯å‡ºç´”æ–‡å­—æª” (.txt)
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                <button onclick="document.getElementById('import-file').click()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-gray-300">
                    <i class="fa-solid fa-upload mr-2"></i> åŒ¯å…¥å‚™ä»½æª”æ¡ˆ
                </button>
            </div>
            
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-cyan-400 space-y-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-lightbulb text-cyan-500 mr-2"></i> æ„è¦‹åæ‡‰èˆ‡å•é¡Œå›å ±
                </h3>
                <p class="text-sm text-gray-600">
                    å¦‚æœæ‚¨åœ¨ä½¿ç”¨ä¸Šæœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿é€éé›»å­éƒµä»¶å›å ±ã€‚
                </p>
                <a href="mailto:ven691026@gmail.com?subject=%5B%E6%97%85%E8%A1%8C%E8%A8%98%E5%B8%B3%E6%9C%AC%20V8.9a%20%E6%84%8F%E8%A6%8B%E5%9B%9E%E9%A5%8B%5D&body=%E6%84%8F%E8%A6%8B/%E5%95%8F%E9%A1%8C%E9%A1%9E%E5%9E%8B:%20%5B%E4%BE%8B%E5%A6%82%EF%BC%9A%E9%8C%AF%E8%AA%A4%E5%9B%9E%E5%A0%B1/%E5%8A%9F%E8%83%BD%E5%BB%BA%E8%AD%B0%5D%0A-------------------------------------------%0A%E5%95%8F%E9%A1%8C%E6%8F%8F%E8%BF%B0%3A%0A%5B%E8%AB%8B%E8%A9%B3%E7%B4%B0%E6%8F%8F%E8%BF%B0%E6%82%A8%E9%81%87%E5%88%B0%E7%9A%84%E5%95%8F%E9%A1%8C%E6%88%96%E6%82%A8%E7%9A%84%E5%BB%BA%E8%AD%B0%5D%0A%0A%0AApp%20%E7%89%88%E6%9C%AC%3A%20V8.9a%0A%E8%A3%9D%E7%BD%AE%E8%B3%87%E8%A8%8A%3A%20%5B%E4%BE%8B%E5%A6%82%EF%BC%9A%5D" 
                    class="w-full bg-cyan-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-cyan-700">
                    <i class="fa-solid fa-envelope mr-2"></i> å¯„é€é›»å­éƒµä»¶å›å ±
                </a>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-red-400">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-3">
                    <i class="fa-solid fa-skull-crossbones text-red-500 mr-2"></i> æ¸…é™¤æ‰€æœ‰è³‡æ–™
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    æ­¤æ“ä½œæœƒæ°¸ä¹…åˆªé™¤æ‰€æœ‰æˆå“¡ã€èŠ±è²»ã€çµç®—å’Œè¨­å®šè³‡æ–™ï¼Œè«‹è¬¹æ…æ“ä½œã€‚
                </p>
                <button onclick="confirmClearData()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-red-700">
                    <i class="fa-solid fa-trash-can mr-2"></i> ç¢ºèªæ¸…é™¤æ‰€æœ‰è³‡æ–™
                </button>
            </div>

            <p class="text-center text-xs text-gray-400 pt-10">æ—…è¡Œè¨˜å¸³æœ¬ V8.9a | By Gemini</p>
        </section>

    </div>

    <div id="favorite-modal" class="fixed inset-0 z-[60] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeFavoriteModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative modal-base modal-hidden-state" id="favorite-panel">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center border-b pb-3">ç·¨è¼¯å¸¸ç”¨æ¸…å–®</h3>
            <div id="favorite-list-editor" class="max-h-[85vh] overflow-y-auto space-y-3">
                </div>
            <div class="mt-4 pt-4 border-t border-gray-100 flex gap-2">
                <input type="text" id="new-favorite-title" placeholder="åç¨± (ä¾‹å¦‚: é£²æ–™)" class="flex-1 border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg">
                <input type="text" id="new-favorite-category" placeholder="é¡åˆ¥åœ–ç¤º (ä¾‹å¦‚: â˜•)" class="w-16 border-2 border-gray-300 rounded-xl px-2 py-2 text-lg text-center">
                <button onclick="addFavoriteItem()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold btn-big">æ–°å¢</button>
            </div>
            <button onclick="closeFavoriteModal()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow-md btn-big mt-4">é—œé–‰</button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-[60] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative modal-base modal-hidden-state" id="edit-panel">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center border-b pb-3">ä¿®æ”¹æ¶ˆè²»å…§å®¹</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">è²·äº†ä»€éº¼?</label>
                    <input type="text" id="edit-title" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">é‡‘é¡èˆ‡å¹£åˆ¥</label>
                    <div class="flex gap-2">
                        <input type="number" id="edit-amount" step="0.01" class="flex-1 border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                        <select id="edit-currency" class="w-1/3 border-2 border-gray-300 rounded-xl px-2 py-2 font-bold text-lg text-center">
                            </select>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">æ—¥æœŸ (YYYY-MM-DD)</label>
                    <input type="date" id="edit-date" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500 bg-gray-50">
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">é¡åˆ¥</label>
                    <select id="edit-category" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                        <option value="é¤é£²">ğŸ” é¤é£²</option>
                        <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                        <option value="ä½å®¿">ğŸ  ä½å®¿</option>
                        <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option>
                        <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="å…¶ä»–">ğŸ’¡ å…¶ä»–</option>
                        <option value="">ç„¡é¡åˆ¥</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEdit()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow hover:bg-indigo-700 btn-big">å„²å­˜è®Šæ›´</button>
                <button onclick="closeEditModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow hover:bg-gray-300 btn-big">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="member-tag-modal" class="fixed inset-0 z-[60] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeMemberTagModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative modal-base modal-hidden-state" id="tag-panel">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center border-b pb-3">ç·¨è¼¯æ¨™ç±¤ï¼š<span id="member-tag-name"></span></h3>
            <div id="member-tags-list" class="flex flex-wrap gap-2 max-h-80 overflow-y-auto">
                </div>
            <button onclick="closeMemberTagModal()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow-md btn-big mt-6">å®Œæˆ</button>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 z-[70] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative modal-base modal-hidden-state">
            <div id="modal-icon" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4 text-blue-500 text-3xl">
                <i class="fa-solid fa-info"></i>
            </div>
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-2 text-center">æ¨™é¡Œ</h3>
            <p id="modal-message" class="text-gray-600 mb-6 text-center text-lg">è¨Šæ¯</p>
            <div id="modal-actions" class="flex gap-3">
                </div>
        </div>
    </div>

    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white px-4 py-3 rounded-full shadow-xl transition-all transform z-[70] flex items-center gap-3 pointer-events-none opacity-0 translate-y-[-100%]">
        <i class="fa-solid fa-circle-check text-green-400 text-2xl"></i>
        <span id="toast-msg">è¤‡è£½å¥½äº†ï¼</span>
    </div>

    <script async src="https://s.fx-w.io/widgets/exchange-rates/latest.js"></script>

    <script>
        // è¨­å®šå”¯ä¸€çš„ Keyï¼Œç¢ºä¿è³‡æ–™ç¨ç«‹
        const STORAGE_KEY = 'trip_account_v8_clean';
        const DEFAULT_TAGS = [{ key: 'Drinker', name: 'ğŸº å–é…’' }, { key: 'Vegetarian', name: 'ğŸ¥¦ åƒç´ ' }, { key: 'Driver', name: 'ğŸš— å¸æ©Ÿ' }, { key: 'Kid', name: 'ğŸ‘¶ å°å­©' }];
        const ALL_CURRENCIES = ['TWD', 'USD', 'JPY', 'EUR', 'CNY', 'HKD', 'KRW', 'THB', 'GBP', 'AUD', 'CAD', 'SGD'];
        const DEFAULT_EXCHANGE_RATES = { 'TWD': 1.0, 'USD': 32.0, 'JPY': 0.21, 'EUR': 34.5, 'CNY': 4.4, 'HKD': 4.1, 'KRW': 0.024, 'THB': 0.9, 'GBP': 39.0, 'AUD': 22.0, 'CAD': 23.5, 'SGD': 24.0 };
        
        // V8.9a ä¿®æ­£ï¼šæª¢æŸ¥ localStorage å¯ç”¨æ€§ï¼Œç§»é™¤éæŒä¹…åŒ–å„²å­˜çš„ fallback
        let localStorageIsAvailable = true;

        function checkLocalStorageAvailability() {
            try {
                const testKey = '__test__';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                localStorageIsAvailable = true;
            } catch (e) {
                localStorageIsAvailable = false;
                console.error('Local storage is blocked or unavailable:', e);
                // é¦–æ¬¡è¼‰å…¥æ™‚æé†’ä½¿ç”¨è€…
                setTimeout(() => {
                    showToast('âš  è­¦å‘Šï¼šè³‡æ–™å„²å­˜å¤±æ•—ï¼è«‹å‹¿å¾æœ¬æ©Ÿæª”æ¡ˆé–‹å•Ÿï¼Œæˆ–æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å°é–ç¶²ç«™è³‡æ–™ã€‚', 'error', 10000); 
                }, 1000);
            }
        }
        
        // å…¨åŸŸè®Šæ•¸
        let data = {};
        let settlementResult = null;
        let currentEditingId = null; 
        let currentEditingMemberId = null; 
        let liveRates = null; 
        let currentModal = null; 
        let currentOnConfirm = null; 

        // --- Data Persistence and Initialization ---

        function loadData() {
            checkLocalStorageAvailability();

            let stored = null;
            if (localStorageIsAvailable) {
                try {
                    stored = localStorage.getItem(STORAGE_KEY);
                } catch (e) {
                    // This catch is mostly redundant due to the check, but good for safety
                    console.error("Error retrieving data from localStorage:", e);
                }
            }

            if (stored) {
                data = JSON.parse(stored);
            } else {
                // Initialize default data structure
                data = {
                    baseCurrency: 'TWD',
                    publicFeeCollectorId: '',
                    customTags: JSON.parse(JSON.stringify(DEFAULT_TAGS)),
                    exchangeRates: JSON.parse(JSON.stringify(DEFAULT_EXCHANGE_RATES)),
                    expenses: [],
                    payments: [],
                    members: [],
                    favorites: [] 
                };
            }
            // Ensure essential fields exist after load
            if (!data.baseCurrency) data.baseCurrency = 'TWD';
            if (!data.customTags) data.customTags = JSON.parse(JSON.stringify(DEFAULT_TAGS));
            if (!data.exchangeRates) data.exchangeRates = JSON.parse(JSON.stringify(DEFAULT_EXCHANGE_RATES));
            if (!data.expenses) data.expenses = [];
            if (!data.payments) data.payments = [];
            if (!data.members) data.members = [];
            if (!data.favorites) data.favorites = []; 

            data.exchangeRates['TWD'] = 1.0;
            // ç¢ºä¿å…¬æ¬¾ä»£å¢Šäººå­˜åœ¨
            if (data.members.length > 0 && (!data.publicFeeCollectorId || !data.members.find(m => m.id === data.publicFeeCollectorId))) {
                 data.publicFeeCollectorId = data.members[0].id;
            }
        }

        function saveData() {
            if (localStorageIsAvailable) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error('Failed to save data to local storage:', e);
                    showToast('è³‡æ–™å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æ˜¯å¦å¾æœ¬æ©Ÿæª”æ¡ˆé–‹å•Ÿã€‚', 'error');
                }
            } else {
                 showToast('âš  è³‡æ–™æœªå„²å­˜ï¼è«‹å‹¿å¾æœ¬æ©Ÿæª”æ¡ˆé–‹å•Ÿï¼Œæˆ–æª¢æŸ¥ç€è¦½å™¨éš±ç§è¨­å®šã€‚', 'error');
            }
            renderAll();
        }

        function init() {
            loadData();
            renderAll();
            
            // è‡ªå‹•å¾ç¶²è·¯æ›´æ–°åŒ¯ç‡
            fetchLiveRates(); 

            // ç¢ºä¿ä¸€é–‹å§‹é¡¯ç¤ºç¬¬ä¸€å€‹ tab
            switchTab('members');
        }

        // --- Currency and Rate Logic ---

        function getRateToBase(currency) {
            if (currency === data.baseCurrency) return 1.0;
            const rateToTWD = data.exchangeRates[currency] || 1.0;
            const baseRateToTWD = data.exchangeRates[data.baseCurrency] || 1.0;
            return baseRateToTWD === 0 ? 0 : rateToTWD / baseRateToTWD;
        }

        function updateRatesFromLive() {
            if (liveRates) {
                ALL_CURRENCIES.forEach(c => {
                    if (liveRates[c] !== undefined) {
                        // rate is TWD to X, we need X to TWD
                        const twdRate = 1.0 / liveRates[c];
                        data.exchangeRates[c] = parseFloat(twdRate.toFixed(4));
                    }
                });
                
                data.exchangeRates['TWD'] = 1.0; 

                const badge = document.getElementById('rate-source-badge');
                if (badge) {
                    badge.className = "text-xs bg-green-100 text-green-600 px-2 py-1 rounded font-bold";
                    badge.innerText = "ğŸŸ¢ ç¶²è·¯å³æ™‚";
                }
                
                showToast('å·²æˆåŠŸæ›´æ–°ç¶²è·¯å³æ™‚åŒ¯ç‡');
                saveData(); 
            }
        }

        function fetchLiveRates() {
            const badge = document.getElementById('rate-source-badge'), info = document.getElementById('calc-rate-info');
            if(badge) { 
                badge.className = "text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold"; 
                badge.innerText = "æ›´æ–°ä¸­..."; 
            }
            if(info) info.innerText = "æ­£åœ¨é€£ç·šåˆ°ç¶²è·¯åŒ¯ç‡...";
            
            // ä½¿ç”¨ TWD ç‚ºåŸºæº–ç²å–åŒ¯ç‡ (1 TWD = ? Other Currencies)
            fetch('https://api.exchangerate-api.com/v4/latest/TWD')
                .then(r => r.json())
                .then(d => {
                    if (d.rates) {
                        liveRates = d.rates; 
                        if(!liveRates['TWD']) liveRates['TWD'] = 1;
                        updateRatesFromLive(); 
                    } else {
                        if(badge) {
                            badge.className = "text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold";
                            badge.innerText = "âŒ æ›´æ–°å¤±æ•—";
                        }
                        showToast('ç¶²è·¯åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤', 'error');
                    }
                })
                .catch(e => {
                    if(badge) {
                        badge.className = "text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold";
                        badge.innerText = "âŒ æ›´æ–°å¤±æ•—";
                    }
                    showToast('ç¶²è·¯åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼šé€£ç·šå•é¡Œ', 'error');
                    if(info) info.innerText = "ç„¡æ³•é€£ç·šåˆ°ç¶²è·¯åŒ¯ç‡ï¼Œä½¿ç”¨å„²å­˜è³‡æ–™";
                    updateCalculator();
                    calculateSettlement();
                });
        }
        
        function updateRate(currency, value) {
            let rateInput = parseFloat(value);
            
            if (isNaN(rateInput) || rateInput <= 0) {
                showToast('åŒ¯ç‡å€¼å¿…é ˆæ˜¯æ­£æ•¸', 'warning');
                renderRatesList(); 
                return;
            }
            
            // rateInput: 1 Other = ? Base
            const baseToTwdRate = data.exchangeRates[data.baseCurrency] || 1.0;
            const newTwdRate = rateInput * baseToTwdRate;
            
            data.exchangeRates[currency] = parseFloat(newTwdRate.toFixed(4));

            saveData(); 
            showToast(`å·²è¨­å®š ${currency} å° ${data.baseCurrency} çš„åŒ¯ç‡ç‚º ${rateInput.toFixed(4)}`);
        }

        function switchBaseCurrency(currency) {
            if (data.baseCurrency === currency) return;
            data.baseCurrency = currency;
            saveData();
            showToast(`çµç®—åŸºæº–å¹£åˆ¥å·²åˆ‡æ›ç‚º ${currency}`);
        }
        
        function updateCalculator(isTargetChanged = false) {
            const fromCur = document.getElementById('calc-from').value;
            const toCur = document.getElementById('calc-to').value;
            const amountInput = document.getElementById('calc-amount');
            const amountToInput = document.getElementById('calc-amount-to');
            const resultAmountEl = document.getElementById('calc-result-amount');
            const resultCurEl = document.getElementById('calc-result-cur');
            
            const rateFromToBase = getRateToBase(fromCur);
            const rateToToBase = getRateToBase(toCur);
            
            const rateFromToTo = rateFromToBase / rateToToBase; 

            let amount = parseFloat(amountInput.value) || 0;
            let amountTo = parseFloat(amountToInput.value) || 0;
            
            if (isTargetChanged) {
                amount = amountTo / rateFromToTo;
                amountInput.value = amount.toFixed(2);
            } else {
                amountTo = amount * rateFromToTo;
                amountToInput.value = amountTo.toFixed(2);
            }

            resultAmountEl.textContent = amountTo.toFixed(2);
            resultCurEl.textContent = toCur;
        }

        // --- Rendering Functions ---

        function renderAll() {
            renderCurrencySelectors();
            renderMembers();
            renderExpensesList();
            renderRatesList(); 
            renderFavorites(); 
            calculateSettlement();
        }

        function renderCurrencySelectors() {
            document.querySelectorAll('.current-base-cur').forEach(el => el.textContent = data.baseCurrency);

            const baseSel = document.getElementById('base-currency-select');
            if(baseSel) {
                baseSel.innerHTML = ALL_CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');
                baseSel.value = data.baseCurrency;
            }

            const calcFrom = document.getElementById('calc-from');
            const calcTo = document.getElementById('calc-to');
            const expCur = document.getElementById('exp-currency');

            const opts = ALL_CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');
            if (calcFrom) { calcFrom.innerHTML = opts; if (!calcFrom.value) calcFrom.value = 'TWD'; }
            if (calcTo) { calcTo.innerHTML = opts; calcTo.value = data.baseCurrency; }
            if (expCur) { expCur.innerHTML = opts; if (!expCur.value) expCur.value = 'TWD'; }
        }

        function renderRatesList() {
            const list = document.getElementById('rates-list');
            if (!list) return;

            const baseToTwdRate = data.exchangeRates[data.baseCurrency] || 1.0;
            const ratesHtml = ALL_CURRENCIES
                .filter(c => c !== data.baseCurrency)
                .map(c => {
                    const rateToTWD = data.exchangeRates[c] || DEFAULT_EXCHANGE_RATES[c] || 1.0; 
                    const rateToDisplay = rateToTWD / baseToTwdRate; 
                    
                    return `
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-2"> 
                            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                                <div class="font-bold text-indigo-600 text-lg">1 ${c}</div> <div class="font-bold text-gray-500 text-sm"> = ? ${data.baseCurrency}</div> </div>
                            <input 
                                type="number" 
                                step="0.0001" 
                                value="${rateToDisplay.toFixed(4)}" 
                                onchange="updateRate('${c}', this.value)" 
                                class="w-full border-2 border-gray-200 rounded-lg px-3 py-2 text-right font-mono text-indigo-600 font-bold text-lg bg-gray-50 focus:border-indigo-500"
                            >
                        </div>
                    `;
                })
                .join('');

            list.innerHTML = ratesHtml;
            const titleSpan = document.querySelector('#rate-list-display h3 .current-base-cur');
            if (titleSpan) titleSpan.textContent = data.baseCurrency;
        }

        function renderMembers() {
             const collSelect = document.getElementById('public-fee-collector-select');
            if(collSelect) collSelect.innerHTML = data.members.map(m => `<option value="${m.id}" ${m.id === data.publicFeeCollectorId ? 'selected' : ''}>${m.name}</option>`).join('');

            const list = document.getElementById('members-list');
            if (!list) return;

            if (data.members.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-xl">ğŸ‘» é‚„æ²’æœ‰äººå–”ï¼Œå¿«åŠ äººï¼</div>';
            } else {
                list.innerHTML = data.members.map(m => {
                    const tagsHtml = m.tags.map(k => {
                        const t = data.customTags.find(t => t.key === k);
                        return t ? `<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-lg text-xs font-bold mr-1">${t.name}</span>` : '';
                    }).join('');
                    const feeStatusClass = m.isFeeCollected ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-600 border-red-200';
                    const feeStatusIcon = m.isFeeCollected ? 'fa-check-circle' : 'fa-circle-xmark';
                    const feeStatusText = m.isFeeCollected ? 'å·²äº¤' : 'é‚„æ²’äº¤';
                    const prepaidDisplay = `${m.prepaid.toFixed(2)} <span class="text-xs text-gray-400">${m.prepaidCurrency}</span>`;

                    return `
                        <div class="bg-white rounded-2xl shadow-md border-b-4 border-gray-200 overflow-hidden">
                            <div class="p-4 flex justify-between items-center">
                                <h4 class="font-bold text-lg text-gray-800">${m.name}</h4>
                                <div class="flex items-center gap-2">
                                    <button onclick="openMemberTagModal('${m.id}')" class="text-gray-400 hover:text-indigo-500 p-2"><i class="fa-solid fa-tag"></i></button>
                                    <button onclick="deleteMember('${m.id}')" class="text-gray-400 hover:text-red-500 p-2"><i class="fa-solid fa-user-minus"></i></button>
                                </div>
                            </div>
                            <div class="p-4 pt-0">
                                <div class="text-sm text-gray-500 mb-2">${tagsHtml || 'ç„¡æ¨™ç±¤'}</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                        <p class="text-xs text-gray-500 font-medium">é ä»˜/å…¬è²»</p>
                                        <div class="flex items-end justify-between mt-1">
                                            <p class="text-xl font-bold text-green-700">${prepaidDisplay}</p>
                                            <button onclick="toggleFeeCollected('${m.id}')" class="text-xs ${feeStatusClass} px-2 py-1 rounded-lg font-bold flex items-center shadow-sm">
                                                <i class="fa-solid ${feeStatusIcon} mr-1"></i> ${feeStatusText}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                        <p class="text-xs text-gray-500 font-medium">é ä»˜å¹£åˆ¥/é‡‘é¡</p>
                                        <div class="flex items-end justify-between mt-1">
                                            <select onchange="updatePrepaidCurrency('${m.id}', this.value)" class="text-base font-bold text-indigo-600 bg-transparent border-none p-0 focus:outline-none focus:ring-0">
                                                ${ALL_CURRENCIES.map(c => `<option value="${c}" ${m.prepaidCurrency === c ? 'selected' : ''}>${c}</option>`).join('')}
                                            </select>
                                            <input type="number" onchange="updatePrepaidAmount('${m.id}', this.value)" value="${m.prepaid.toFixed(2)}" step="0.01" inputmode="decimal" class="text-xl font-bold text-right text-indigo-600 w-1/2 bg-transparent border-b border-gray-300 focus:border-indigo-500">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            const payerSelect = document.getElementById('exp-payer');
            if (payerSelect) {
                payerSelect.innerHTML = data.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            }
            renderTargetList();
            calculatePublicFeeBalance();
            renderCustomTagsList();
        }

        function renderCustomTagsList() {
            const list = document.getElementById('custom-tags-list');
            if (!list) return;
            list.innerHTML = data.customTags.map(t => `
                <div class="flex items-center bg-cyan-50 text-cyan-700 px-3 py-1 rounded-full text-sm font-bold shadow-sm">
                    ${t.name}
                    <button onclick="renameCustomTag('${t.key}')" class="ml-2 text-cyan-500 hover:text-cyan-800"><i class="fa-solid fa-pen-to-square text-xs"></i></button>
                    <button onclick="deleteCustomTag('${t.key}')" class="ml-2 text-cyan-500 hover:text-red-500"><i class="fa-solid fa-times text-xs"></i></button>
                </div>
            `).join('');
        }

        function renderExpensesList() {
            const list = document.getElementById('expenses-list');
            if (!list) return;

            if (data.expenses.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-xl">âœï¸ è©¦è‘—è¨˜ä¸€ç­†å¸³å§ï¼</div>';
                return;
            }

            list.innerHTML = data.expenses.map(e => {
                const payer = data.members.find(m => m.id === e.payerId)?.name || 'æœªçŸ¥';
                const targets = e.targets.map(id => data.members.find(m => m.id === id)?.name || '?').join('ã€');
                // e.exchangeRate is the rate from e.currency to data.baseCurrency.
                const baseAmount = (e.amount * e.exchangeRate).toFixed(2);
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 ${e.payerId === data.publicFeeCollectorId ? 'border-yellow-500' : 'border-indigo-500'} flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-800 truncate">${e.title}</span>
                                ${e.category ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">${e.category}</span>` : ''}
                            </div>
                            <p class="text-xl font-bold text-red-600 mt-1">${e.amount.toFixed(2)} ${e.currency}</p>
                            <p class="text-xs text-gray-500">ä»£å¢Š: ${payer} | åˆ†æ”¤: ${targets}</p>
                            <p class="text-xs text-gray-400 mt-1">ç´„ ${baseAmount} ${data.baseCurrency}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openEditModal('${e.id}')" class="text-gray-400 hover:text-blue-500 p-2"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteExpense('${e.id}')" class="text-gray-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTargetList() {
            const targetsList = document.getElementById('targets-list');
            if (!targetsList) return;
            targetsList.innerHTML = data.members.map(m => `
                <label class="flex items-center bg-gray-50 p-3 rounded-xl border border-gray-200 cursor-pointer shadow-sm">
                    <input type="checkbox" name="expense-target" value="${m.id}" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">${m.name}</span>
                </label>
            `).join('');
        }

        function renderFavorites() {
            const list = document.getElementById('favorites-list');
            if (!list) return;

            // ç¢ºä¿ç¬¬ä¸€å€‹æ˜¯ç·¨è¼¯æŒ‰éˆ•
            let html = `<button onclick="openFavoriteModal()" class="text-gray-400 hover:text-indigo-500 text-sm font-bold flex items-center">
                <i class="fa-solid fa-star mr-1"></i> ç·¨è¼¯å¸¸ç”¨æ¸…å–®
            </button>`;

            html += data.favorites.map(f => `
                <button onclick="useFavorite('${f.id}')" class="bg-indigo-500 text-white px-3 py-1.5 rounded-xl text-sm font-bold shadow-md hover:bg-indigo-600 btn-big">
                    ${f.category} ${f.title}
                </button>
            `).join('');

            list.innerHTML = html;
        }

        function renderFavoriteListEditor() {
            const editor = document.getElementById('favorite-list-editor');
            if (!editor) return;

            if (data.favorites.length === 0) {
                editor.innerHTML = '<div class="text-center text-gray-400 py-4 border-2 border-dashed rounded-xl">å°šç„¡å¸¸ç”¨é …ç›®</div>';
                return;
            }

            editor.innerHTML = data.favorites.map(f => `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <div class="font-bold text-gray-800">${f.category} ${f.title}</div>
                    <button onclick="deleteFavoriteItem('${f.id}')" class="text-red-500 hover:text-red-700 p-1"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }
        
        function renderTagList(member) {
            const list = document.getElementById('member-tags-list');
            if (!list) return;
            list.innerHTML = data.customTags.map(t => {
                const isSelected = member.tags.includes(t.key);
                return `
                    <button 
                        onclick="toggleMemberTag('${member.id}', '${t.key}')" 
                        class="px-3 py-1 rounded-full text-sm font-bold transition-all ${isSelected ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                    >
                        ${isSelected ? '<i class="fa-solid fa-check mr-1"></i>' : ''} ${t.name}
                    </button>
                `;
            }).join('');
        }

        // --- Member Logic ---

        function addMember() {
            const nameInput = document.getElementById('input-member-name');
            const name = nameInput.value.trim();
            if (name === "") { return showToast('è«‹è¼¸å…¥æˆå“¡åç¨±', 'warning'); }
            
            const newMember = {
                id: Date.now().toString(),
                name: name,
                prepaid: 0,
                prepaidCurrency: data.baseCurrency,
                isFeeCollected: false,
                tags: []
            };
            data.members.push(newMember);
            nameInput.value = '';
            
            // å¦‚æœæ˜¯ç¬¬ä¸€å€‹æˆå“¡ï¼Œè¨­ç‚ºå…¬æ¬¾ä»£å¢Šäºº
            if (data.members.length === 1) {
                data.publicFeeCollectorId = newMember.id;
            }
            saveData();
            showToast(`${name} åŠ å…¥æ—…è¡Œï¼`);
        }

        function deleteMember(id) {
            showModal('confirm', 'ç¢ºèªåˆªé™¤æˆå“¡', 'åˆªé™¤æˆå“¡æœƒåŒæ™‚åˆªé™¤æ‰€æœ‰èˆ‡ä»–ç›¸é—œçš„èŠ±è²»ç´€éŒ„ï¼Œç¢ºèªå—ï¼Ÿ', () => {
                data.expenses = data.expenses
                    .filter(e => e.payerId !== id)
                    .map(e => ({
                        ...e,
                        targets: e.targets.filter(tId => tId !== id)
                    }))
                    .filter(e => e.targets.length > 0); // åˆªé™¤æ²’æœ‰åˆ†æ”¤äººçš„è²»ç”¨

                data.members = data.members.filter(m => m.id !== id);
                
                // é‡è¨­å…¬æ¬¾ä»£å¢Šäºº
                if (data.publicFeeCollectorId === id) {
                    data.publicFeeCollectorId = data.members.length > 0 ? data.members[0].id : '';
                }

                saveData();
                showToast('æˆå“¡å·²åˆªé™¤', 'error');
            });
        }

        function switchPublicFeeCollector(id) {
            data.publicFeeCollectorId = id;
            saveData();
            showToast(`å…¬æ¬¾ä»£å¢Šäººå·²åˆ‡æ›`);
        }
        
        function calculatePublicFeeBalance() {
            const balanceEl = document.getElementById('public-fee-balance');
            if (!balanceEl) return;

            const publicCollector = data.members.find(m => m.id === data.publicFeeCollectorId);
            if (!publicCollector) {
                balanceEl.textContent = 'N/A';
                return;
            }

            // 1. è¨ˆç®—æ‰€æœ‰æˆå“¡é ä»˜çš„å…¬æ¬¾ (æ›ç®—ç‚ºåŸºæº–å¹£åˆ¥)
            const totalPrepaid = data.members.reduce((sum, member) => {
                const rate = getRateToBase(member.prepaidCurrency);
                return sum + (member.isFeeCollected ? (member.prepaid * rate) : 0);
            }, 0);

            // 2. è¨ˆç®—æ‰€æœ‰å…¬æ¬¾æ”¯å‡º (æ›ç®—ç‚ºåŸºæº–å¹£åˆ¥)
            const totalPublicExpense = data.expenses.reduce((sum, expense) => {
                // æª¢æŸ¥æ˜¯å¦æ˜¯å…¬æ¬¾æ”¯å‡º (payerId ç‚ºå…¬æ¬¾ä»£å¢Šäºº)
                if (expense.payerId === data.publicFeeCollectorId) {
                     // expense.exchangeRate is the rate from expense.currency to data.baseCurrency
                    return sum + (expense.amount * expense.exchangeRate);
                }
                return sum;
            }, 0);

            const balance = totalPrepaid - totalPublicExpense;
            balanceEl.textContent = balance.toFixed(2);
            balanceEl.className = `text-2xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'} mt-1`;
        }
        
        function updatePrepaidCurrency(id, currency) {
            const member = data.members.find(m => m.id === id);
            if (member) {
                member.prepaidCurrency = currency;
                saveData();
                showToast(`${member.name} é ä»˜å¹£åˆ¥å·²æ›´æ–°ç‚º ${currency}`);
            }
        }

        function updatePrepaidAmount(id, amountStr) {
            const member = data.members.find(m => m.id === id);
            const amount = parseFloat(amountStr);
            if (member && !isNaN(amount) && amount >= 0) {
                member.prepaid = amount;
                saveData();
                showToast(`${member.name} é ä»˜é‡‘é¡å·²æ›´æ–°`);
            } else {
                showToast('é‡‘é¡ä¸æ­£ç¢º', 'warning');
                renderMembers(); // æ¢å¾©èˆŠå€¼
            }
        }
        
        function toggleFeeCollected(id) {
            const member = data.members.find(m => m.id === id);
            if (member) {
                member.isFeeCollected = !member.isFeeCollected;
                saveData();
                showToast(`${member.name} å…¬è²»ç‹€æ…‹å·²æ›´æ–°`);
            }
        }

        function batchAddPrepaid() {
            const amountStr = document.getElementById('batch-prepaid-amount').value;
            const amount = parseFloat(amountStr);

            if (isNaN(amount) || amount <= 0) {
                return showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„å…¬è²»é‡‘é¡', 'warning');
            }

            showModal('confirm', 'ç¢ºèªè¿½åŠ å…¬è²»', `ç¢ºå®šæ‰€æœ‰æˆå“¡éƒ½å°‡é ä»˜ ${amount} ${data.baseCurrency} å—ï¼Ÿ`, () => {
                data.members.forEach(m => {
                    // å°‡æ–°è¿½åŠ çš„é‡‘é¡ï¼Œä»¥åŸºæº–å¹£åˆ¥è¨ˆç®—å¾ŒåŠ åˆ°æˆå“¡é ä»˜ä¸­
                    const currentRate = getRateToBase(m.prepaidCurrency); // Rate from member's prepaid currency to Base
                    const newPrepaidBase = m.prepaid * currentRate + amount;
                    m.prepaid = newPrepaidBase / currentRate; // æ›ç®—å›æˆå“¡çš„é ä»˜å¹£åˆ¥
                    m.prepaid = parseFloat(m.prepaid.toFixed(2));
                    m.prepaidCurrency = m.prepaidCurrency; // ä¿æŒå¹£åˆ¥
                    m.isFeeCollected = true;
                });
                document.getElementById('batch-prepaid-amount').value = '';
                saveData();
                showToast('å…¬è²»è¿½åŠ å®Œæˆï¼');
            });
        }

        function addCustomTag() {
            const nameInput = document.getElementById('input-tag-name');
            const name = nameInput.value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥æ¨™ç±¤åç¨±', 'warning');

            const newTag = {
                key: name.toLowerCase().replace(/[^a-z0-9]/g, '_') + Date.now().toString().slice(-4),
                name: name
            };
            data.customTags.push(newTag);
            nameInput.value = '';
            saveData();
            showToast('æ–°æ¨™ç±¤å·²æ–°å¢');
        }
        
        function deleteCustomTag(key) {
            showModal('confirm', 'ç¢ºèªåˆªé™¤æ¨™ç±¤', 'æ­¤æ¨™ç±¤å°‡å¾æ‰€æœ‰æˆå“¡èº«ä¸Šç§»é™¤ï¼Œç¢ºèªåˆªé™¤å—ï¼Ÿ', () => {
                data.customTags = data.customTags.filter(t => t.key !== key);
                data.members.forEach(m => {
                    m.tags = m.tags.filter(tKey => tKey !== key);
                });
                saveData();
                showToast('æ¨™ç±¤å·²åˆªé™¤', 'error');
            });
        }
        
        function renameCustomTag(k) { 
            const t = data.customTags.find(x => x.key === k); 
            if(!t) return;
            const n = prompt(`å°‡æ¨™ç±¤ "${t.name}" é‡å‘½åç‚ºï¼š`); 
            if(n && n.trim()) { 
                t.name = n.trim(); 
                saveData(); 
                renderMembers(); 
                renderTagList(data.members.find(x => x.id === currentEditingMemberId)); 
                showToast('æ¨™ç±¤åç¨±å·²æ›´æ–°');
            } 
        }

        function openMemberTagModal(memberId) {
            currentEditingMemberId = memberId;
            const member = data.members.find(m => m.id === memberId);
            if (!member) return;

            document.getElementById('member-tag-name').textContent = member.name;
            renderTagList(member);

            const modal = document.getElementById('member-tag-modal');
            const panel = modal.querySelector('#tag-panel');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function closeMemberTagModal() {
            const modal = document.getElementById('member-tag-modal');
            const panel = modal.querySelector('#tag-panel');

            panel.classList.remove('modal-visible-state');
            panel.classList.add('modal-hidden-state');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                currentEditingMemberId = null;
                renderMembers(); // é—œé–‰å¾Œæ›´æ–°æˆå“¡æ¸…å–®
            }, 250);
        }

        function toggleMemberTag(memberId, tagKey) {
            const member = data.members.find(m => m.id === memberId);
            if (!member) return;

            if (member.tags.includes(tagKey)) {
                member.tags = member.tags.filter(k => k !== tagKey);
            } else {
                member.tags.push(tagKey);
            }
            // ä¸éœ€è¦ saveData()ï¼Œå› ç‚ºåœ¨ closeMemberTagModal æ™‚æœƒå‘¼å« renderMembers()
            renderTagList(member); 
        }

        // --- Expense Logic ---

        function toggleExpenseType(isPublic) {
            const payerSelectContainer = document.getElementById('individual-payer-select-container');
            const publicFeeNote = document.getElementById('public-fee-note');
            
            if (isPublic) {
                payerSelectContainer.classList.add('hidden');
                publicFeeNote.classList.remove('hidden');
            } else {
                payerSelectContainer.classList.remove('hidden');
                publicFeeNote.classList.add('hidden');
            }
        }

        function toggleAllTargets() {
            const checkboxes = document.querySelectorAll('#targets-list input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
        }

        function addExpense() {
            const title = document.getElementById('exp-title').value.trim();
            const amountStr = document.getElementById('exp-amount').value;
            const currency = document.getElementById('exp-currency').value;
            const payerSelect = document.getElementById('exp-payer');
            const isPublicFee = document.getElementById('is-public-fee').checked;
            const payerId = isPublicFee ? data.publicFeeCollectorId : payerSelect.value;
            const category = document.getElementById('exp-category').value;
            const targets = Array.from(document.querySelectorAll('#targets-list input:checked'))
                                .map(input => input.value);

            const amount = parseFloat(amountStr);

            if (!title || isNaN(amount) || amount <= 0 || !payerId || targets.length === 0) {
                return showToast('è«‹å¡«å¯«å®Œæ•´ï¼šæ¨™é¡Œã€é‡‘é¡ã€ä»˜æ¬¾äººã€åˆ†æ”¤äºº', 'warning');
            }

            // exchangeRate: Rate from expense currency to data.baseCurrency
            const exchangeRate = getRateToBase(currency);

            const newExpense = {
                id: Date.now().toString(),
                title: title,
                amount: amount,
                currency: currency,
                exchangeRate: exchangeRate, 
                payerId: payerId,
                targets: targets,
                category: category,
                date: new Date().toISOString().split('T')[0] 
            };

            data.expenses.unshift(newExpense);
            
            document.getElementById('exp-title').value = '';
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-category').value = '';
            
            saveData();
            showToast(`è¨˜å¸³æˆåŠŸï¼ ${title} ${amount} ${currency}`);
        }

        function deleteExpense(id) {
            showModal('confirm', 'ç¢ºèªåˆªé™¤æ¶ˆè²»', 'é€™ç­†æ¶ˆè²»ç´€éŒ„å°‡æœƒè¢«ç§»é™¤ï¼Œç¢ºèªå—ï¼Ÿ', () => {
                data.expenses = data.expenses.filter(e => e.id !== id);
                saveData();
                showToast('æ¶ˆè²»å·²åˆªé™¤', 'error');
            });
        }

        function openEditModal(id) {
            currentEditingId = id;
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('edit-title').value = expense.title;
            document.getElementById('edit-amount').value = expense.amount;
            document.getElementById('edit-category').value = expense.category;
            document.getElementById('edit-date').value = expense.date;

            // æ–°å¢ï¼šå¹£åˆ¥é¸æ“‡å™¨å¡«å……èˆ‡é¸ä¸­
            const editCur = document.getElementById('edit-currency');
            if (editCur) {
                editCur.innerHTML = ALL_CURRENCIES.map(c => 
                    `<option value="${c}" ${expense.currency === c ? 'selected' : ''}>${c}</option>`
                ).join('');
            }
            // çµæŸæ–°å¢

            const modal = document.getElementById('edit-modal');
            const panel = document.getElementById('edit-panel');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function saveEdit() {
            const expense = data.expenses.find(e => e.id === currentEditingId);
            if (!expense) return;

            const newTitle = document.getElementById('edit-title').value.trim();
            const newAmount = parseFloat(document.getElementById('edit-amount').value);
            const newCurrency = document.getElementById('edit-currency').value; // æ–°å¢ï¼šå–å¾—æ–°çš„å¹£åˆ¥
            const newCategory = document.getElementById('edit-category').value;
            const newDate = document.getElementById('edit-date').value;

            if (!newTitle || isNaN(newAmount) || newAmount <= 0) {
                return showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¨™é¡Œå’Œé‡‘é¡', 'warning');
            }

            expense.title = newTitle;
            expense.amount = newAmount;
            expense.category = newCategory;
            expense.date = newDate;

            // æ–°å¢ï¼šå¦‚æœå¹£åˆ¥æ”¹è®Šï¼Œæ›´æ–°å¹£åˆ¥ä¸¦é‡æ–°è¨ˆç®—åŒ¯ç‡
            if (expense.currency !== newCurrency) {
                expense.currency = newCurrency;
                // exchangeRate: Rate from expense.currency to data.baseCurrency, must be recalculated
                expense.exchangeRate = getRateToBase(newCurrency); 
            }
            // çµæŸæ–°å¢

            closeEditModal();
            saveData();
            showToast('æ¶ˆè²»å·²æ›´æ–°');
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            const panel = document.getElementById('edit-panel');
            
            panel.classList.remove('modal-visible-state');
            panel.classList.add('modal-hidden-state');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                currentEditingId = null;
            }, 250);
        }

        // --- Favorite Logic ---

        function addFavoriteItem() {
            const title = document.getElementById('new-favorite-title').value.trim();
            const category = document.getElementById('new-favorite-category').value.trim();
            if (!title) return showToast('è«‹è¼¸å…¥åç¨±', 'warning');

            data.favorites.push({
                id: Date.now().toString(),
                title: title,
                category: category || 'ğŸ’¡'
            });

            document.getElementById('new-favorite-title').value = '';
            document.getElementById('new-favorite-category').value = '';
            saveData();
            renderFavoriteListEditor();
            showToast('å¸¸ç”¨é …ç›®å·²æ–°å¢');
        }

        function deleteFavoriteItem(id) {
            data.favorites = data.favorites.filter(f => f.id !== id);
            saveData();
            renderFavoriteListEditor();
            showToast('å¸¸ç”¨é …ç›®å·²åˆªé™¤', 'error');
        }

        function useFavorite(id) {
            const favorite = data.favorites.find(f => f.id === id);
            if (!favorite) return;

            document.getElementById('exp-title').value = favorite.title;
            document.getElementById('exp-category').value = favorite.category;

            switchTab('expenses'); // åˆ‡æ›åˆ°è¨˜å¸³é 
            showToast(`å·²å¥—ç”¨ ${favorite.title}`);
        }

        function openFavoriteModal() {
            const modal = document.getElementById('favorite-modal');
            const panel = document.getElementById('favorite-panel');
            
            renderFavoriteListEditor(); 

            modal.classList.remove('hidden'); 
            
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function closeFavoriteModal() {
            const modal = document.getElementById('favorite-modal');
            const panel = document.getElementById('favorite-panel');
            
            panel.classList.remove('modal-visible-state');
            panel.classList.add('modal-hidden-state');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                renderFavorites(); 
            }, 250);
        }


        // --- Settlement Logic ---

        function calculateSettlement() {
            const balances = {};
            const baseCur = data.baseCurrency;
            
            data.members.forEach(m => {
                balances[m.id] = { 
                    id: m.id, // æ–°å¢ id æ¬„ä½ä»¥ä¾›è½‰å¸³è¨ˆç•«ä½¿ç”¨
                    name: m.name, 
                    prepaid: 0, 
                    spend: 0, 
                    balance: 0 
                };
            });

            let totalSpend = 0;
            let totalPrepaid = 0;

            // 1. è¨ˆç®—é ä»˜é‡‘ (Prepaid)
            data.members.forEach(m => {
                const prepaidBase = m.prepaid * getRateToBase(m.prepaidCurrency);
                if (m.isFeeCollected) {
                    balances[m.id].prepaid = prepaidBase;
                }
                totalPrepaid += prepaidBase;
            });

            // 2. è¨ˆç®—èŠ±è²» (Spend)
            data.expenses.forEach(e => {
                // å°‡èŠ±è²»æ›ç®—ç‚ºåŸºæº–å¹£åˆ¥ (e.exchangeRate is rate from expense.currency to baseCurrency)
                const baseAmount = e.amount * e.exchangeRate; 
                totalSpend += baseAmount;
                
                const perPersonSplit = baseAmount / e.targets.length;

                e.targets.forEach(targetId => {
                    if (balances[targetId]) {
                        balances[targetId].spend += perPersonSplit;
                    }
                });
            });

            // 3. è¨ˆç®—çµç®—é¤˜é¡ (Balance)
            data.members.forEach(m => {
                // ç¸½ä»£å¢Šé‡‘é¡ = å€‹äººé ä»˜å…¬è²» + å€‹äººå¢Šä»˜çš„è²»ç”¨
                let totalPaid = balances[m.id].prepaid; 
                data.expenses.filter(e => e.payerId === m.id).forEach(e => {
                    const baseAmount = e.amount * e.exchangeRate;
                    // å¦‚æœä»˜æ¬¾äººæ˜¯å…¬æ¬¾ä»£å¢Šäººï¼Œä¸”é€™ç­†æ˜¯å…¬æ¬¾æ”¯å‡ºï¼Œå‰‡ä¸é‡è¤‡è¨ˆå…¥å…¬æ¬¾ä»£å¢Šäººçš„ totalPaidï¼Œå› ç‚ºé ä»˜å…¬è²»ä¸­å·²ç¶“åŒ…å«ã€‚
                    if (e.payerId !== data.publicFeeCollectorId) {
                        totalPaid += baseAmount;
                    }
                });
                
                balances[m.id].balance = totalPaid - balances[m.id].spend;
            });
            
            const balancesArray = Object.values(balances);

            // 4. è¨ˆç®—è½‰å¸³è¨ˆç•«
            const plan = simplifySettlement(balancesArray);

            settlementResult = {
                totalSpend: totalSpend.toFixed(2),
                totalPrepaid: totalPrepaid.toFixed(2),
                memberBalances: balancesArray,
                plan: plan
            };
            
            // æ¸²æŸ“çµæœ
            renderResult(settlementResult);
        }

        function simplifySettlement(balances) {
            const plan = [];
            const balancesCopy = balances.map(b => ({ ...b, balance: parseFloat(b.balance.toFixed(2)) })); // é¿å…æµ®é»æ•¸èª¤å·®ï¼Œå››æ¨äº”å…¥åˆ°å°æ•¸é»å…©ä½
            balancesCopy.sort((a, b) => a.balance - b.balance);
            
            let givers = balancesCopy.filter(b => b.balance < -0.01);
            let receivers = balancesCopy.filter(b => b.balance > 0.01);

            while (givers.length > 0 && receivers.length > 0) {
                let giver = givers[0];
                let receiver = receivers[0];
                
                // å–çµ•å°å€¼ï¼Œå› ç‚º giver.balance æ˜¯è² æ•¸
                const amountToTransfer = Math.min(Math.abs(giver.balance), receiver.balance);
                
                if (amountToTransfer > 0.01) {
                    plan.push({
                        from: giver.id,
                        to: receiver.id,
                        amount: amountToTransfer.toFixed(2)
                    });
                }

                // æ›´æ–°é¤˜é¡
                giver.balance += amountToTransfer;
                receiver.balance -= amountToTransfer;
                
                // é‡æ–°æ’åºä¸¦ç§»é™¤å·²çµæ¸…çš„æˆå“¡
                givers = givers.filter(b => Math.abs(b.balance) >= 0.01);
                receivers = receivers.filter(b => Math.abs(b.balance) >= 0.01);
            }
            return plan;
        }

        function renderResult(result) {
            if (!result || !data.members.length) {
                document.getElementById('member-balance-list').innerHTML = '<div class="text-center text-gray-400 py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-xl">æˆå“¡ä¸è¶³æˆ–å°šæœªè¨˜å¸³</div>';
                document.getElementById('settlement-plan').innerHTML = '';
                document.getElementById('total-spend').textContent = '0';
                document.getElementById('total-prepaid').textContent = '0';
                return;
            }

            document.getElementById('total-spend').textContent = result.totalSpend;
            document.getElementById('total-prepaid').textContent = result.totalPrepaid;
            const baseCur = data.baseCurrency;

            // æ¸²æŸ“æˆå“¡çµç®—åˆ—è¡¨
            const balanceList = document.getElementById('member-balance-list');
            balanceList.innerHTML = result.memberBalances.map(b => {
                const statusClass = b.balance > 0.01 ? 'bg-green-100 text-green-700' : 
                                     b.balance < -0.01 ? 'bg-red-100 text-red-700' : 
                                     'bg-gray-100 text-gray-700';
                const statusText = b.balance > 0.01 ? 'æ‡‰æ”¶' : 
                                   b.balance < -0.01 ? 'æ‡‰ä»˜' : 
                                   'çµæ¸…';
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-md border-b-4 ${statusClass.includes('green') ? 'border-green-400' : statusClass.includes('red') ? 'border-red-400' : 'border-gray-300'}">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-bold text-gray-800">${b.name}</h4>
                            <span class="text-xs ${statusClass} px-3 py-1 rounded-full font-bold">${statusText}</span>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <div>
                                <p class="text-xs text-gray-500">é ä»˜ç¸½é¡ (å«ä»£å¢Š)</p>
                                <p class="text-xl font-bold">${b.prepaid.toFixed(2)} ${baseCur}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 text-right">åˆ†æ”¤ç¸½é¡</p>
                                <p class="text-xl font-bold text-red-500">${b.spend.toFixed(2)} ${baseCur}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 text-right">çµç®—é¤˜é¡</p>
                                <p class="text-2xl font-bold ${statusClass.includes('green') ? 'text-green-600' : 'text-red-600'}">${b.balance.toFixed(2)} ${baseCur}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // æ¸²æŸ“è½‰å¸³è¨ˆç•«
            const planList = document.getElementById('settlement-plan');
            if (result.plan.length === 0) {
                planList.innerHTML = '<div class="text-center text-gray-400 py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-lg"><i class="fa-solid fa-check-circle mr-2"></i> å¸³ç›®å…¨éƒ¨çµæ¸…å›‰ï¼</div>';
            } else {
                planList.innerHTML = result.plan.map(p => {
                    const fromName = data.members.find(m => m.id === p.from)?.name || 'æœªçŸ¥';
                    const toName = data.members.find(m => m.id === p.to)?.name || 'æœªçŸ¥';
                    return `
                        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md border-b-4 border-indigo-400">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-bold text-red-500">${fromName}</span>
                                <i class="fa-solid fa-arrow-right text-gray-500"></i>
                                <span class="text-lg font-bold text-green-500">${toName}</span>
                            </div>
                            <p class="text-2xl font-bold text-indigo-600">${p.amount} ${baseCur}</p>
                        </div>
                    `;
                }).join('');
            }
        }

        // --- Utility Functions (Toast & Modal) ---

        function showToast(msg, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = toast.querySelector('i');
            
            iconEl.className = '';
            toast.classList.remove('bg-gray-900/90', 'bg-red-600/90', 'bg-yellow-600/90');

            if (type === 'success') {
                iconEl.classList.add('fa-solid', 'fa-circle-check', 'text-green-400', 'text-2xl');
                toast.classList.add('bg-gray-900/90');
            } else if (type === 'error') {
                iconEl.classList.add('fa-solid', 'fa-circle-xmark', 'text-red-400', 'text-2xl');
                toast.classList.add('bg-red-600/90');
            } else if (type === 'warning') {
                iconEl.classList.add('fa-solid', 'fa-triangle-exclamation', 'text-yellow-400', 'text-2xl');
                toast.classList.add('bg-yellow-600/90');
            } else {
                iconEl.classList.add('fa-solid', 'fa-info', 'text-blue-400', 'text-2xl');
                toast.classList.add('bg-gray-900/90');
            }
            
            msgEl.textContent = msg;

            // Show
            toast.style.opacity = '1';
            toast.style.transform = 'translate(-50%, 0)';

            // Hide after duration
            clearTimeout(toast.timer);
            toast.timer = setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -100%)';
            }, duration);
        }

        function showModal(type, title, message, onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            const panel = modal.querySelector('div:last-child'); 
            const iconEl = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const actionsEl = document.getElementById('modal-actions');

            currentModal = modal;
            currentOnConfirm = onConfirm;

            titleEl.textContent = title;
            messageEl.textContent = message;

            iconEl.className = '';
            iconEl.classList.add('mx-auto', 'flex', 'items-center', 'justify-center', 'h-16', 'w-16', 'rounded-full', 'text-3xl');
            
            actionsEl.innerHTML = '';
            
            if (type === 'confirm') {
                iconEl.classList.add('bg-red-100', 'text-red-500');
                iconEl.querySelector('i').className = 'fa-solid fa-triangle-exclamation';

                actionsEl.innerHTML = `
                    <button onclick="confirmModalAction()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold text-lg shadow hover:bg-red-700 btn-big">ç¢ºèª</button>
                    <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow hover:bg-gray-300 btn-big">å–æ¶ˆ</button>
                `;
            } else { 
                iconEl.classList.add('bg-blue-100', 'text-blue-500');
                iconEl.querySelector('i').className = 'fa-solid fa-info';
                
                actionsEl.innerHTML = `
                    <button onclick="closeModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow hover:bg-indigo-700 btn-big">é—œé–‰</button>
                `;
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function closeModal() {
            if (!currentModal) return;
            const panel = currentModal.querySelector('div:last-child');
            
            panel.classList.remove('modal-visible-state');
            panel.classList.add('modal-hidden-state');
            
            setTimeout(() => {
                currentModal.classList.add('hidden');
                currentModal = null;
                currentOnConfirm = null;
            }, 250);
        }

        function confirmModalAction() {
            if (currentOnConfirm) {
                currentOnConfirm();
            }
            closeModal();
        }

        // --- App Flow ---

        function switchTab(tab) {
            const tabs = ['members', 'expenses', 'result', 'rates', 'settings'];
            const navItems = {
                'members': document.getElementById('tab-members'),
                'expenses': document.getElementById('tab-expenses'),
                'result': document.getElementById('tab-result'),
                'rates': document.getElementById('tab-rates'),
                'settings': document.getElementById('tab-settings'),
            };

            tabs.forEach(t => {
                const view = document.getElementById(`view-${t}`);
                if (view) view.classList.add('hidden');
                if (navItems[t]) {
                    navItems[t].classList.remove('active', 'text-indigo-400');
                    navItems[t].classList.add('inactive', 'text-white/60');
                }
            });

            const activeView = document.getElementById(`view-${tab}`);
            const activeButton = document.getElementById(`tab-${tab}`);
            if (activeView) activeView.classList.remove('hidden');
            if (activeButton) {
                activeButton.classList.remove('inactive', 'text-white/60');
                activeButton.classList.add('active', 'text-indigo-400');
            }

            if (tab === 'result') {
                calculateSettlement();
            }
        }

        function copyReport() {
            if(!settlementResult) return showToast('è«‹å…ˆåˆ‡æ›åˆ°ã€Œç®—éŒ¢ã€é é¢å–”', 'warning');
            
            // ä½¿ç”¨ generateTextReport ç”¢ç”Ÿå®Œæ•´çš„ç´”æ–‡å­—å ±å‘Šï¼Œä½†åƒ…é™çµç®—éƒ¨åˆ†
            const baseCur = data.baseCurrency;
            let text = `ğŸ“… æ—…è¡Œçµç®—å ±å‘Š (${baseCur})\n`;
            
            // ç¸½çµ
            text += `\n--- ç¸½çµ ---\n`;
            text += `ç¸½èŠ±è²»: ${settlementResult.totalSpend} ${baseCur}\n`;
            text += `ç¸½é ä»˜/å…¬è²»: ${settlementResult.totalPrepaid} ${baseCur}\n`;

            // å€‹äººçµç®—
            text += `\n--- å€‹äººçµç®— ---\n`;
            settlementResult.memberBalances.forEach(b => {
                const status = b.balance > 0.01 ? 'æ‡‰æ”¶' : b.balance < -0.01 ? 'æ‡‰ä»˜' : 'çµæ¸…';
                const sign = b.balance > 0.01 ? '+' : '';
                text += `ğŸ‘¤ ${b.name}: ${status} ${sign}${b.balance.toFixed(2)} ${baseCur}\n`;
            });
            
            // è½‰å¸³è¨ˆç•«
            text += `\n--- è½‰å¸³è¨ˆç•« ---\n`;
            if (settlementResult.plan.length === 0) {
                text += `ğŸ‰ å¸³ç›®å…¨éƒ¨çµæ¸…å›‰ï¼`;
            } else { 
                settlementResult.plan.forEach(p => { 
                    const f = data.members.find(m => m.id === p.from)?.name; 
                    const t = data.members.find(m => m.id === p.to)?.name; 
                    text += `ğŸ‘‰ ${f} çµ¦ ${t}ï¼š${p.amount} ${baseCur}\n`; 
                }); 
            }
            
            const ta = document.createElement('textarea'); 
            ta.value = text; 
            document.body.appendChild(ta); 
            ta.select(); 
            try { 
                document.execCommand('copy'); 
                showToast('è¤‡è£½å¥½äº†ï¼'); 
            } catch(e) { 
                alert('è¤‡è£½å¤±æ•—'); 
            } 
            document.body.removeChild(ta);
        }

        // --- Backup & Restore ---

        function generateTextReport() {
            let text = `======================================\n`;
            text += `  æ—…è¡Œè¨˜å¸³æœ¬ - ç´”æ–‡å­—å‚™ä»½å ±å‘Š\n`;
            text += `======================================\n\n`;

            text += `ğŸ“… å‚™ä»½æ—¥æœŸ: ${new Date().toLocaleString('zh-TW', { dateStyle: 'medium', timeStyle: 'short' })}\n`;
            text += `ğŸ’° åŸºæº–å¹£åˆ¥: ${data.baseCurrency}\n`;
            text += `--------------------------------------\n\n`;

            // æˆå“¡æ¸…å–®
            text += `ğŸ‘¥ æˆå“¡æ¸…å–® (${data.members.length} äºº):\n`;
            if (data.members.length === 0) {
                 text += '  (ç„¡)\n';
            } else {
                data.members.forEach(m => {
                    const tags = m.tags.map(k => data.customTags.find(t => t.key === k)?.name || k).join(', ');
                    const prepaidStatus = m.isFeeCollected ? 'å·²äº¤å…¬è²»' : 'æœªäº¤å…¬è²»';
                    text += `  - ${m.name}: é ä»˜ ${m.prepaid.toFixed(2)} ${m.prepaidCurrency} (${prepaidStatus})${tags ? ` | æ¨™ç±¤: ${tags}` : ''}\n`;
                });
            }
            text += `\n--------------------------------------\n\n`;

            // èŠ±è²»æ¸…å–®
            text += `ğŸ§¾ èŠ±è²»ç´€éŒ„ (${data.expenses.length} ç­†):\n`;
            if (data.expenses.length === 0) {
                text += '  (ç„¡)\n';
            } else {
                data.expenses.sort((a, b) => b.id - a.id).forEach((e, index) => {
                    const payerName = data.members.find(m => m.id === e.payerId)?.name || 'æœªçŸ¥';
                    const targetNames = e.targets.map(id => data.members.find(m => m.id === id)?.name || '?').join('ã€');
                    const baseAmount = (e.amount * e.exchangeRate).toFixed(2); // e.exchangeRate is rate to Base Currency

                    text += `  ${index + 1}. [${e.category || 'ç„¡é¡åˆ¥'}] ${e.title} (${e.date})\n`;
                    text += `     - é‡‘é¡: ${e.amount.toFixed(2)} ${e.currency} (ç´„ ${baseAmount} ${data.baseCurrency})\n`;
                    text += `     - ä»£å¢Š: ${payerName}\n`;
                    text += `     - åˆ†æ”¤: ${targetNames}\n`;
                });
            }
            text += `\n======================================\n`;
            return text;
        }


        function exportData(type) { 
            let fileContent, fileName, mimeType;
            
            if (type === 'json') {
                fileContent = JSON.stringify(data);
                fileName = `æ—…è¡Œè¨˜å¸³æœ¬_å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
                mimeType = "application/json";
            } else if (type === 'text') {
                fileContent = generateTextReport();
                fileName = `æ—…è¡Œè¨˜å¸³æœ¬_å ±å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
                mimeType = "text/plain";
            } else {
                return; // Should not happen
            }

            const b = new Blob([fileContent], {type: mimeType});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(u);
            showToast(`è³‡æ–™å·²åŒ¯å‡ºç‚º ${type.toUpperCase()} æª”æ¡ˆ`);
        }

        function importData(event) { 
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.members && importedData.expenses) {
                        showModal('confirm', 'ç¢ºèªåŒ¯å…¥è³‡æ–™', 'é€™å°‡è¦†è“‹æ‰€æœ‰ç•¶å‰è³‡æ–™ï¼Œç¢ºèªåŒ¯å…¥å—ï¼Ÿ', () => {
                            data = importedData;
                            data.exchangeRates['TWD'] = 1.0; // ç¢ºä¿åŒ¯ç‡æ­£ç¢º
                            saveData();
                            showToast('è³‡æ–™å·²æˆåŠŸåŒ¯å…¥', 'success');
                        });
                    } else {
                        showToast('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º', 'error');
                    }
                } catch(error) {
                    showToast('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆè§£æéŒ¯èª¤', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearData() { 
            if (localStorageIsAvailable) {
                localStorage.removeItem(STORAGE_KEY);
            }
            data = {};
            loadData(); // é‡æ–°åˆå§‹åŒ–ç‚ºé è¨­å€¼
            saveData();
            showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
            switchTab('members');
        }

        function confirmClearData() {
            showModal('confirm', 'è­¦å‘Šï¼šæ°¸ä¹…åˆªé™¤', 'æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼', clearData);
        }

    </script>
</body>
</html>
