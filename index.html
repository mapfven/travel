<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œè¨˜å¸³æœ¬ V8.9a (è³‡æ–™å„²å­˜ä¿®æ­£ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #FFFBEB; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 1rem; 
            padding-top: 100px; 
            padding-bottom: 40px; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: padding-bottom 0.3s;
        }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */
        .btn-big { transition: transform 0.1s; }
        .btn-big:active { transform: scale(0.98); }

        /* å°èˆªæ¬„æ¨£å¼ - è¡Œå‹•é»æ“Šèˆ‡é¡¯ç¤ºå„ªåŒ– */
        .nav-item {
            cursor: pointer; 
            touch-action: manipulation; 
            transition: color 0.2s, transform 0.1s;
        }
        /* [ä¿®æ”¹] è®“ active é¡è‰²åœ¨æ–°çš„æ·ºè‰²èƒŒæ™¯ä¸Šä¿æŒæ¸…æ™° */
        .nav-item.active { color: #4F46E5; font-weight: bold; } 
        /* [ä¿®æ”¹] è®“ inactive é¡è‰²åœ¨æ–°çš„æ·ºè‰²èƒŒæ™¯ä¸Šä¿æŒæ¸…æ™° */
        .nav-item.inactive { color: #9CA3AF; } 
        .nav-item:active { transform: scale(0.95); } 
        
        /* é¿å… iOS è¼¸å…¥æ¡†æ”¾å¤§ */
        input, select, textarea {
            font-size: 1rem !important; 
        }

        /* é ‚éƒ¨å°èˆªæ¬„å‹•ç•« */
        #top-nav { 
            transition: transform 0.3s ease-in-out;
            will-change: transform;
            padding-top: env(safe-area-inset-top); 
        }

        /* Modal å‹•ç•« */
        .modal-base {
            transition: opacity 0.2s ease-out, transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-hidden-state { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .modal-visible-state { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* é«˜äº®å‹•ç•« */
        @keyframes highlight-pulse {
            0% { background-color: #dcfce7; }
            100% { background-color: white; }
        }
        .highlight-anim { animation: highlight-pulse 2s ease-out; }
    </style>
</head>

<body onload="init()">
    
    <nav id="top-nav" class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-lg z-50">
        <div class="max-w-lg mx-auto flex justify-around items-center h-24 text-gray-700"> 
            <button id="tab-members" onclick="switchTab('members')" class="nav-item flex flex-col items-center p-2 pt-3 active text-indigo-600">
                <i class="fa-solid fa-users text-xl"></i>
                <span class="text-xs mt-1">å¤§å®¶</span>
            </button>
            <button id="tab-expenses" onclick="switchTab('expenses')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-gray-500">
                <i class="fa-solid fa-receipt text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button id="tab-result" onclick="switchTab('result')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-gray-500">
                <i class="fa-solid fa-calculator text-xl"></i>
                <span class="text-xs mt-1">ç®—éŒ¢</span>
            </button>
            <button id="tab-rates" onclick="switchTab('rates')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-gray-500">
                <i class="fa-solid fa-money-bill-transfer text-xl"></i>
                <span class="text-xs mt-1">åŒ¯ç‡</span>
            </button>
            <button id="tab-settings" onclick="switchTab('settings')" class="nav-item flex flex-col items-center p-2 pt-3 inactive text-gray-500">
                <i class="fa-solid fa-cog text-xl"></i>
                <span class="text-xs mt-1">è¨­å®š</span>
            </button>
        </div>
    </nav>
    <div class="max-w-lg mx-auto p-4 pt-6">

        <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-6 flex items-center">
            <i class="fa-solid fa-plane-departure text-indigo-600 mr-3"></i> æ—…è¡Œè¨˜å¸³æœ¬
            <div id="rate-warning" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-lg font-bold ml-auto hidden shadow-sm"><i class="fa-solid fa-triangle-exclamation mr-1"></i> åŒ¯ç‡ç•°å¸¸</div>
        </h1>

        <section id="view-members" class="space-y-6 animate-fade-in pb-10">
            
            <div id="rate-settings-container" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-yellow-400">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-3">
                    <i class="fa-solid fa-gear text-yellow-600 mr-2"></i> åŒ¯ç‡åŠŸèƒ½è¨­å®š
                </h3>
                <div class="flex justify-between items-center mb-4">
                    <label for="base-currency-select" class="block text-gray-500 font-bold">åŸºæº–å¹£åˆ¥</label>
                    <select id="base-currency-select" onchange="switchBaseCurrency(this.value)" class="border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                        </select>
                </div>
                <button onclick="fetchLiveRates()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-blue-600">
                    <i class="fa-solid fa-arrow-rotate-right mr-2"></i> æ‰‹å‹•ç¶²è·¯å³æ™‚æ›´æ–°
                </button>
                <div id="calc-rate-info" class="text-center text-sm text-gray-500 mt-2">ä½¿ç”¨å„²å­˜è³‡æ–™</div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-indigo-400">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-user-plus text-indigo-500 mr-2"></i> èª°è¦åŠ å…¥ï¼Ÿ
                </h3>
                <div class="flex gap-3">
                    <input type="text" id="input-member-name" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: é˜¿å…¬)" class="flex-1 border-2 border-gray-300 rounded-xl px-4 text-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" onkeypress="if(event.key === 'Enter') addMember()">
                    <button onclick="addMember()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-md btn-big"> åŠ å…¥ </button>
                </div>
            </div>

            <div class="bg-green-100 p-5 rounded-2xl shadow-lg border-2 border-green-200">
                <h3 class="text-lg font-bold text-green-800 mb-3 flex items-center">
                    <i class="fa-solid fa-money-bill-wave mr-2"></i> å¤§å®¶ä¸€èµ·äº¤å…¬è²»
                </h3>
                <div class="flex flex-col gap-3">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">è¿½åŠ å…¬è²»å¹£åˆ¥ (<span class="current-base-cur">TWD</span>)</label>
                        <input type="number" id="batch-prepaid-amount" placeholder="æ¯äººäº¤å¤šå°‘? (ä¾‹å¦‚ 1000)" step="0.01" inputmode="decimal" class="w-full border-2 border-green-300 rounded-xl px-4 py-3 text-xl font-bold focus:border-green-500">
                    </div>
                    <button onclick="batchAddPrepaid()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center">
                        <i class="fa-solid fa-plus-circle mr-2"></i> ç¢ºå®šï¼æ¯äººéƒ½äº¤éŒ¢
                    </button>
                </div>
            </div>
            <div id="members-section">
                <h3 class="text-lg font-bold text-gray-600 mb-2 pl-2">ç›®å‰æœ‰èª°åœ¨æ—…è¡Œ?</h3>
                <div id="members-list" class="space-y-3">
                    </div>
            </div>

            <div class="bg-yellow-50 p-5 rounded-2xl shadow-lg border-l-8 border-yellow-400">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-coins text-yellow-600 mr-2"></i> å…¬æ¬¾éŒ¢åŒ…è¨­å®š
                </h3>
                <div class="flex justify-between items-center mb-4">
                    <label for="public-fee-collector-select" class="block text-gray-500 font-bold">å…¬æ¬¾ç”±èª°ä»£å¢Š/ä»£æ”¶?</label>
                    <select id="public-fee-collector-select" onchange="switchPublicFeeCollector(this.value)" class="border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-yellow-500">
                        </select>
                </div>
                <div class="flex justify-between items-center">
                    <label class="block text-gray-500 font-bold">å…¬æ¬¾é¤˜é¡ (<span class="current-base-cur">TWD</span>)</label>
                    <p id="public-fee-balance" class="text-2xl font-bold text-green-600">0</p>
                </div>
            </div>

            <div id="tags-setting-section" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-cyan-400">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-tags text-cyan-500 mr-2"></i> è‡ªè¨‚æˆå“¡æ¨™ç±¤
                </h3>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="input-tag-name" placeholder="æ¨™ç±¤åç¨± (ä¾‹å¦‚: å¸æ©Ÿ)" class="flex-1 border-2 border-gray-300 rounded-xl px-4 text-lg focus:border-cyan-500" onkeypress="if(event.key === 'Enter') addCustomTag()">
                    <button onclick="addCustomTag()" class="bg-cyan-500 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-md btn-big"> æ–°å¢ </button>
                </div>
                <div id="custom-tags-list" class="flex flex-wrap gap-2">
                    </div>
            </div>
        </section>

        <section id="view-expenses" class="space-y-6 animate-fade-in pb-10 hidden">
            <div class="bg-white p-6 rounded-3xl shadow-xl border-2 border-indigo-100">
                <h2 class="text-2xl font-bold text-center text-indigo-800 mb-6 flex justify-center items-center">
                    <span class="bg-indigo-100 p-2 rounded-full mr-2"><i class="fa-solid fa-pen"></i></span> è¨˜ä¸€ç­†èŠ±è²»
                </h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-gray-500 font-bold mb-1 ml-1">1. èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ</label>
                        <div class="mb-2">
                            <select id="exp-currency" class="w-full bg-white border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg text-center focus:border-indigo-500">
                                </select>
                        </div>
                        <input type="number" id="exp-amount" placeholder="0" inputmode="decimal" step="0.01" class="w-full bg-gray-50 border-2 border-gray-300 rounded-2xl px-4 py-4 font-mono font-bold text-4xl text-indigo-700 text-center focus:border-indigo-500">
                    </div>

                    <div>
                        <label class="block text-gray-500 font-bold mb-1 ml-1">2. è²·äº†ä»€éº¼ï¼Ÿ</label>
                        <div class="space-y-2"> <input type="text" id="exp-title" placeholder="è¼¸å…¥åç¨± (ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š)" class="w-full border-2 border-gray-300 rounded-xl px-3 py-1.5 font-bold text-base focus:border-indigo-500" onkeypress="if(event.key === 'Enter') addExpense()">
                            <select id="exp-category" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-base text-center focus:border-indigo-500">
                                <option value="">é¸æ“‡é¡åˆ¥</option>
                                <option value="é¤é£²">ğŸ” é¤é£²</option>
                                <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                <option value="ä½å®¿">ğŸ  ä½å®¿</option>
                                <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option>
                                <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="å…¶ä»–">ğŸ’¡ å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="favorites-list" class="flex flex-wrap gap-2 border-t pt-3 border-gray-100">
                        <button onclick="openFavoriteModal()" class="text-gray-400 hover:text-indigo-500 text-sm font-bold flex items-center">
                            <i class="fa-solid fa-star mr-1"></i> ç·¨è¼¯å¸¸ç”¨æ¸…å–®
                        </button>
                        </div>

                    <div>
                        <label class="block text-gray-500 font-bold mb-1 ml-1">3. èª°å‡ºçš„éŒ¢ï¼Ÿ</label>
                        <div class="flex flex-col gap-2">
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-sm">
                                <label for="is-public-fee" class="flex-1 font-bold text-lg text-gray-700 cursor-pointer">
                                    å…¬æ¬¾æ”¯å‡º
                                </label>
                                <input type="checkbox" id="is-public-fee" onchange="toggleExpenseType(this.checked)" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                            </div>
                            <div id="individual-payer-select-container">
                                <select id="exp-payer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                                    </select>
                            </div>
                        </div>
                    </div>

                    <div id="targets-section">
                        <label class="block text-gray-500 font-bold mb-1 ml-1">4. èª°è¦åˆ†æ”¤ï¼Ÿ</label>
                        <div id="targets-list" class="grid grid-cols-4 gap-2">
                            </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleAllTargets()" class="text-sm text-indigo-500 hover:underline w-full text-right">å…¨é¸ / å–æ¶ˆ</button>
                        </div>
                    </div>
                    
                    <div id="public-fee-note" class="bg-red-50 p-3 rounded-xl text-red-600 text-sm font-bold hidden">
                        <i class="fa-solid fa-circle-info mr-1"></i> é€™ç­†éŒ¢æœƒå¾ã€Œå…¬æ¬¾éŒ¢åŒ…ã€æ‰£é™¤ï¼Œä¸¦ç®—åœ¨æ‰€æœ‰äººçš„å¸³ä¸Šã€‚
                    </div>
                </div>

                <button onclick="addExpense()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg btn-big flex justify-center items-center mt-6">
                    <i class="fa-solid fa-check mr-2"></i> è¨˜ä¸‹ä¾†
                </button>
            </div>

            <div id="capture-expenses-list-container">
                <div class="flex justify-between items-center mb-3 ml-2">
                    <h3 class="text-xl font-bold text-gray-700">æœ€è¿‘è¨˜äº†ä»€éº¼?</h3>
                    <button onclick="captureAndShare('capture-expenses-list-container')" class="bg-indigo-600 text-white px-3 py-1.5 rounded-xl font-bold text-sm shadow btn-big hover:bg-indigo-700">
                        <i class="fa-solid fa-camera mr-1"></i> æˆªåœ–åˆ†äº«
                    </button>
                </div>
                <div id="expenses-list" class="space-y-3 pb-20">
                    </div>
            </div>
            </section>

        <section id="view-result" class="animate-fade-in pb-10 hidden">
            <div id="view-result-content" class="space-y-6">
                <h2 class="text-2xl font-bold text-center text-gray-900 mb-6 flex justify-center items-center">
                    <span class="bg-yellow-100 p-2 rounded-full mr-2"><i class="fa-solid fa-receipt text-yellow-500"></i></span> çµç®—çµæœ (<span class="current-base-cur">TWD</span>)
                </h2>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-red-50 p-4 rounded-2xl shadow-md border-b-4 border-red-400">
                        <p class="text-sm font-medium text-red-500">ç¸½èŠ±è²» (çµç®—å¹£åˆ¥)</p>
                        <p id="total-spend" class="text-2xl font-bold text-red-600 mt-1">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-2xl shadow-md border-b-4 border-green-400">
                        <p class="text-sm font-medium text-green-700">ç¸½é ä»˜/å…¬è²» (çµç®—å¹£åˆ¥)</p>
                        <p id="total-prepaid" class="text-2xl font-bold text-green-700 mt-1">0</p>
                    </div>
                </div>

                <div id="member-balance-list" class="space-y-3">
                    </div>

                <div>
                    <h3 class="text-xl font-bold text-gray-700 mb-3 ml-2 flex items-center">
                        <i class="fa-solid fa-arrow-right-arrow-left text-indigo-500 mr-2"></i> è½‰å¸³çµç®—è¨ˆç•«
                    </h3>
                    <div id="settlement-plan" class="space-y-3">
                        <div id="plan-loading" class="text-center text-gray-400 py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-lg">
                            <i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨è¨ˆç®—...
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mt-6">
                <button onclick="captureAndShare('view-result-content')" class="bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg shadow hover:bg-indigo-700 btn-big">
                    <i class="fa-solid fa-camera mr-2"></i> æˆªåœ–åˆ†äº«ç®—éŒ¢çµæœ
                </button>
                <button onclick="copyReport()" class="bg-gray-800 text-white py-4 rounded-2xl font-bold text-lg shadow hover:bg-black btn-big">
                    <i class="fa-solid fa-copy mr-2"></i> è¤‡è£½ç®—éŒ¢çµæœ (å‚³LINE)
                </button>
            </div>
            
            <div class="h-10"></div>
        </section>
        <section id="view-rates" class="space-y-6 animate-fade-in pb-10 hidden"> 
            
            <div id="capture-calc-container" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-indigo-400">
                <div class="flex justify-between items-start mb-2"> 
                    <h3 class="text-xl font-bold text-gray-800 flex items-center"> 
                        <i class="fa-solid fa-calculator text-indigo-500 mr-2"></i> æ›åŒ¯è¨ˆç®—æ©Ÿ 
                    </h3> 
                    <div class="flex items-center space-x-2">
                        <span id="rate-source-badge" class="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded font-bold">è¼‰å…¥ä¸­...</span>
                        <button onclick="captureAndShare('capture-calc-container')" class="bg-indigo-600 text-white px-3 py-1.5 rounded-xl font-bold text-sm shadow btn-big hover:bg-indigo-700">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                </div> 
                <div class="flex flex-col gap-3"> 
                    <div class="space-y-2"> 
                        <label for="calc-amount" class="block text-sm font-medium text-gray-700">æ›ç®—é‡‘é¡ (ä¾†æº)</label>
                        <input type="number" id="calc-amount" placeholder="å¤šå°‘éŒ¢?" oninput="updateCalculator()" step="0.01" class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 font-bold text-lg text-gray-700 focus:border-indigo-500"> 
                        <select id="calc-from" onchange="updateCalculator()" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-base text-center focus:border-indigo-500"> 
                            </select> 
                    </div> 
                    <div class="text-center text-gray-500 font-bold text-lg"><i class="fa-solid fa-arrows-up-down"></i></div> 
                    <div class="space-y-2"> 
                        <label for="calc-amount-to" class="block text-sm font-medium text-gray-700">æ›ç®—é‡‘é¡ (ç›®æ¨™)</label>
                        <input type="number" id="calc-amount-to" placeholder="å¤šå°‘éŒ¢?" oninput="updateCalculator(true)" step="0.01" class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 font-bold text-lg text-gray-700 focus:border-indigo-500"> 
                        <select id="calc-to" onchange="updateCalculator()" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-base text-center focus:border-indigo-500"> 
                            </select> 
                    </div>
                </div> 
                <div id="calc-result" class="mt-4 text-center border-t border-gray-100 pt-3"> 
                    <p class="text-gray-500 text-sm">æ›ç®—çµæœ (ç´„)</p> 
                    <p class="text-4xl font-bold text-indigo-600"><span id="calc-result-amount">0</span> <span id="calc-result-cur" class="text-lg">TWD</span></p> 
                </div> 
            </div>
            <div id="capture-split-calc-container" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-green-400">
                <div class="flex justify-between items-start mb-2"> 
                    <h3 class="text-xl font-bold text-gray-800 flex items-center"> 
                        <i class="fa-solid fa-divide text-green-500 mr-2"></i> å–®æ¬¡åˆ†å¸³è¨ˆç®—æ©Ÿ 
                    </h3> 
                    <button onclick="captureAndShare('capture-split-calc-container')" class="bg-green-600 text-white px-3 py-1.5 rounded-xl font-bold text-sm shadow btn-big hover:bg-green-700">
                        <i class="fa-solid fa-camera"></i> æˆªåœ–åˆ†äº«
                    </button>
                </div> 
                
                <div class="space-y-4">
                    <div>
                        <label for="split-total-amount" class="block text-sm font-medium text-gray-700">ç¸½é‡‘é¡ (Total Amount)</label>
                        <input type="number" id="split-total-amount" placeholder="0" oninput="updateSplitCalculator()" step="0.01" inputmode="decimal" class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 font-bold text-xl text-red-600 text-center focus:border-green-500"> 
                    </div>

                    <div>
                        <label for="split-total-people" class="block text-sm font-medium text-gray-700">ç¸½äººæ•¸ (Total People)</label>
                        <input type="number" id="split-total-people" placeholder="2" oninput="updateSplitCalculator()" step="1" inputmode="numeric" min="1" class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 font-bold text-xl text-indigo-600 text-center focus:border-green-500" value="2"> 
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-100 space-y-3"> 
                    <div class="flex justify-between items-center">
                        <p class="text-gray-500 text-base font-medium">å»ºè­°æ¯äººæ”¯ä»˜é‡‘é¡</p> 
                        <p class="text-3xl font-bold text-green-600"><span id="split-avg-amount">0</span></p> 
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-gray-500 text-sm">æ¹Šæ•´å¾Œé¤˜é¡ (ä»£å¢Šäººå¤šæ”¶/å°‘ä»˜)</p> 
                        <p class="text-xl font-bold text-red-600"><span id="split-remainder">0</span></p> 
                    </div>
                </div> 
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-yellow-400">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-4">
                    <i class="fa-solid fa-cloud-arrow-down text-yellow-600 mr-2"></i> å³æ™‚åŒ¯ç‡åƒè€ƒ (TWD åŸºæº–)
                </h3>
                <div class="text-center">
                    <fxwidget-er inverse="false" amount="1" decimals="2" large="false" shadow="true" symbol="true" flag="true" changes="true" grouping="true" border="false" main-curr="TWD" sel-curr="EUR,USD,CNY,JPY,THB" background-color="#1dacd6"></fxwidget-er>
                    <a href="https://currencyrate.today/" target="_blank" class="text-xs text-gray-400 hover:text-indigo-500 mt-2 block">Powered by CurrencyRate</a>
                    <script async src="https://s.fx-w.io/widgets/exchange-rates/latest.js"></script>
                    </div>
            </div>

            <div id="rate-list-display" class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-green-500">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-3">
                    <i class="fa-solid fa-list-check text-green-600 mr-2"></i> ç·¨è¼¯/è‡ªè¨‚åŒ¯ç‡æ¸…å–® (1 å–®ä½ä»–åœ‹å¹£åˆ¥ = ? å–®ä½ <span class="current-base-cur">TWD</span>)
                </h3>
                <div id="rates-list" class="space-y-3">
                    </div>
            </div>

        </section>

        <section id="view-settings" class="space-y-6 animate-fade-in pb-10 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6 flex justify-center items-center">
                <span class="bg-gray-200 p-2 rounded-full mr-2"><i class="fa-solid fa-cog text-gray-600"></i></span> å‚™ä»½èˆ‡è¨­å®š
            </h2>

            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-indigo-400 space-y-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-cloud-arrow-down text-indigo-500 mr-2"></i> è³‡æ–™å‚™ä»½/åŒ¯å…¥
                </h3>
                <button onclick="exportData('json')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-indigo-700">
                    <i class="fa-solid fa-download mr-2"></i> åŒ¯å‡ºå‚™ä»½æª”æ¡ˆ (.json)
                </button>
                <button onclick="exportData('text')" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-indigo-600">
                    <i class="fa-solid fa-file-lines mr-2"></i> åŒ¯å‡ºç´”æ–‡å­—æª” (.txt)
                </button>
                <button onclick="copyExpensesAsCsv()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-green-700">
                    <i class="fa-solid fa-file-csv mr-2"></i> è¤‡è£½è¨˜å¸³ (CSV æ ¼å¼)
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                <button onclick="document.getElementById('import-file').click()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-gray-300">
                    <i class="fa-solid fa-upload mr-2"></i> åŒ¯å…¥å‚™ä»½æª”æ¡ˆ
                </button>
            </div>
            
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-cyan-400 space-y-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-lightbulb text-cyan-500 mr-2"></i> æ„è¦‹åæ‡‰èˆ‡å•é¡Œå›å ±
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    å¦‚æœæ‚¨åœ¨ä½¿ç”¨ä¸Šæœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿é€éé›»å­éƒµä»¶å›å ±ã€‚
                </p>
                <a href="mailto:ven691026@gmail.com?subject=%5B%E6%97%85%E8%A1%8C%E8%A8%98%E5%B8%B3%E6%9C%AC%20V8.9a%20%E6%84%8F%E8%A6%8B%E5%9B%9E%E9%A5%8B%5D&body=%E6%84%8F%E8%A6%8B/%E5%95%8F%E9%A1%8C%E9%A1%9E%E5%9E%8B:%20%5B%E4%BE%8B%E5%A6%82%EF%BC%9A%E9%8C%AF%E8%AA%A4%E5%9B%9E%E5%A0%B1/%E5%8A%9F%E8%83%BD%E5%BB%BA%E8%AD%B0%5D%0A-------------------------------------------%0A%E5%95%8F%E9%A1%8C%E6%8F%8F%E8%BF%B0%3A%0A%5B%E8%AB%8B%E8%A9%B3%E7%B4%B0%E6%8F%8F%E8%BF%B0%E6%82%A8%E9%81%87%E5%88%B0%E7%9A%84%E5%95%8F%E9%A1%8C%E6%88%96%E6%82%A8%E7%9A%84%E5%BB%BA%E8%AD%B0%5D%0A%0A%0AApp%20%E7%89%88%E6%9C%AC%3F%20V8.9a%0A%E8%A3%9D%E7%BD%AE%E8%B3%87%E8%A8%8A%3A%20%5B%E4%BE%8B%E5%A6%82%EF%BC%9A%5D" 
                    class="w-full bg-cyan-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-cyan-700">
                    <i class="fa-solid fa-envelope mr-2"></i> å¯„é€é›»å­éƒµä»¶å›å ±
                </a>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-lg border-l-8 border-red-400">
                <h3 class="text-xl font-bold text-gray-800 flex items-center mb-3">
                    <i class="fa-solid fa-skull-crossbones text-red-500 mr-2"></i> æ¸…é™¤æ‰€æœ‰è³‡æ–™
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    æ­¤æ“ä½œæœƒæ°¸ä¹…åˆªé™¤æ‰€æœ‰æˆå“¡ã€èŠ±è²»ã€çµç®—å’Œè¨­å®šè³‡æ–™ï¼Œè«‹è¬¹æ…æ“ä½œã€‚
                </p>
                <button onclick="confirmClearData()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold text-lg shadow-md btn-big flex justify-center items-center hover:bg-red-700">
                    <i class="fa-solid fa-trash-can mr-2"></i> ç¢ºèªæ¸…é™¤æ‰€æœ‰è³‡æ–™
                </button>
            </div>

            <p class="text-center text-xs text-gray-400 pt-10">æ—…è¡Œè¨˜å¸³æœ¬ V8.9a | By Gemini</p>
        </section>

    </div>

    <div id="favorite-modal" class="fixed inset-0 z-[60] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeFavoriteModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative modal-base modal-hidden-state" id="favorite-panel">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center border-b pb-3">ç·¨è¼¯å¸¸ç”¨æ¸…å–®</h3>
            <div id="favorite-list-editor" class="max-h-[85vh] overflow-y-auto space-y-3">
                </div>
            <div class="mt-4 pt-4 border-t border-gray-100 space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="new-favorite-title" placeholder="åç¨± (ä¾‹å¦‚: é£²æ–™)" class="flex-1 border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg">
                    <input type="text" id="new-favorite-category" placeholder="é¡åˆ¥åœ–ç¤º (ä¾‹å¦‚: â˜•)" class="w-16 border-2 border-gray-300 rounded-xl px-2 py-2 text-lg text-center">
                </div>
                <button onclick="addFavoriteItem()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold btn-big">æ–°å¢</button>
            </div>
            <button onclick="closeFavoriteModal()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow-md btn-big mt-4">é—œé–‰</button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-[60] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative modal-base modal-hidden-state" id="edit-panel">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center border-b pb-3">ä¿®æ”¹æ¶ˆè²»å…§å®¹</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">è²·äº†ä»€éº¼?</label>
                    <input type="text" id="edit-title" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">é‡‘é¡</label>
                    <input type="number" id="edit-amount" step="0.01" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">å¹£åˆ¥</label>
                    <select id="edit-currency" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg text-center">
                        </select>
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">æ—¥æœŸ (YYYY-MM-DD)</label>
                    <input type="date" id="edit-date" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500 bg-gray-50">
                </div>
                <div>
                    <label class="block text-gray-500 font-bold mb-1 text-sm">é¡åˆ¥</label>
                    <select id="edit-category" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 font-bold text-lg focus:border-indigo-500">
                        <option value="é¤é£²">ğŸ” é¤é£²</option>
                        <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                        <option value="ä½å®¿">ğŸ  ä½å®¿</option>
                        <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option>
                        <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="å…¶ä»–">ğŸ’¡ å…¶ä»–</option>
                        <option value="">ç„¡é¡åˆ¥</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEdit()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow hover:bg-indigo-700 btn-big">å„²å­˜è®Šæ›´</button>
                <button onclick="closeEditModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow hover:bg-gray-300 btn-big">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[70] hidden flex justify-center items-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl relative modal-base modal-hidden-state" id="confirm-panel">
            <h3 id="confirm-title" class="text-xl font-bold text-gray-900 mb-3">æ¨™é¡Œ</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">è¨Šæ¯</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow hover:bg-gray-300 btn-big">å–æ¶ˆ</button>
                <button onclick="handleConfirm()" id="confirm-button" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold text-lg shadow hover:bg-red-700 btn-big">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-xs z-[80] transition-all duration-300 ease-in-out -translate-y-full">
        <div class="flex items-center p-4 mt-1 bg-gray-900/90 text-white rounded-xl shadow-xl space-x-3">
            <div id="toast-icon"></div>
            <span id="toast-message" class="font-bold text-sm flex-1">è¨Šæ¯</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const STORAGE_KEY = 'travelBookkeepingDataV89a';
        const ALL_CURRENCIES = ["TWD", "USD", "EUR", "JPY", "CNY", "KRW", "HKD", "THB", "AUD", "GBP", "CAD"];
        const DEFAULT_EXCHANGE_RATES = {
            "TWD": 1.0, "USD": 32.0, "EUR": 34.0, "JPY": 0.22, "CNY": 4.4, "KRW": 0.026, 
            "HKD": 4.1, "THB": 0.9, "AUD": 21.0, "GBP": 39.0, "CAD": 23.0
        };
        const DEFAULT_TAGS = [
            { key: 'driver', name: 'ğŸš— å¸æ©Ÿ' },
            { key: 'photographer', name: 'ğŸ“¸ æ”å½±å¸«' },
            { key: 'planner', name: 'ğŸ“‹ è¦åŠƒ' }
        ];

        let localStorageIsAvailable = false;
        function checkLocalStorageAvailability() {
            if (typeof localStorage !== 'undefined') {
                try {
                    const testKey = '__test__';
                    localStorage.setItem(testKey, testKey);
                    localStorage.removeItem(testKey);
                    localStorageIsAvailable = true;
                } catch (e) {
                    localStorageIsAvailable = false;
                    console.error('Local storage is blocked or unavailable:', e);
                    // é¦–æ¬¡è¼‰å…¥æ™‚æé†’ä½¿ç”¨è€…
                    setTimeout(() => {
                        showToast('âš  è­¦å‘Šï¼šè³‡æ–™å„²å­˜å¤±æ•—ï¼è«‹å‹¿å¾æœ¬æ©Ÿæª”æ¡ˆé–‹å•Ÿï¼Œæˆ–æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å°é–ç¶²ç«™è³‡æ–™ã€‚', 'error', 10000);
                    }, 1000);
                }
            }
        }

        // å…¨åŸŸè®Šæ•¸
        let data = {};
        let settlementResult = null;
        let currentEditingId = null;
        let currentEditingMemberId = null;
        let liveRates = null;
        let currentModal = null;
        let currentOnConfirm = null;

        // --- Screenshot and Sharing Logic (3, 4, 5 and NEW Split) ---
        function captureAndShare(elementId) {
            const element = document.getElementById(elementId);
            if (!element) {
                showToast('æˆªåœ–ç›®æ¨™ä¸å­˜åœ¨', 'error');
                return;
            }

            showToast('æ­£åœ¨ç”Ÿæˆæˆªåœ–...', 'info', 1500);
            
            // Use a small delay for better rendering sync
            setTimeout(() => {
                html2canvas(element, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true, 
                    logging: false,
                    backgroundColor: '#FFFBEB', // ä¿æŒèƒŒæ™¯è‰²ä¸€è‡´
                    removeContainer: true // Clean up the temporary canvas container
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Fallback to image display in new window for easy saving/sharing
                    const newWindow = window.open();
                    if (newWindow) {
                        newWindow.document.write('<img src="' + imgData + '" style="width:100%; height:auto; display: block; border: none;">');
                        newWindow.document.title = 'æ—…è¡Œè¨˜å¸³æœ¬æˆªåœ–';
                        newWindow.focus();
                        showToast('æˆªåœ–å·²åœ¨æ–°è¦–çª—é–‹å•Ÿï¼Œè«‹é•·æŒ‰/å³éµå„²å­˜æˆ–åˆ†äº«', 'success', 3000);
                    } else {
                        showToast('æˆªåœ–å¤±æ•—ï¼šè«‹å…è¨±å½ˆå‡ºè¦–çª—', 'error');
                    }
                }).catch(err => {
                    console.error('html2canvas failed:', err);
                    showToast('æˆªåœ–å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²é å…§å®¹', 'error');
                });
            }, 100); 
        }

        // --- Data Persistence and Initialization ---
        function loadData() {
            checkLocalStorageAvailability();
            let stored = null;
            if (localStorageIsAvailable) {
                try {
                    stored = localStorage.getItem(STORAGE_KEY);
                } catch (e) {
                    // This catch is mostly redundant due to the check, but good for safety
                    console.error("Error retrieving data from localStorage:", e);
                }
            }
            if (stored) {
                data = JSON.parse(stored);
            } else {
                // Initialize default data structure
                data = {
                    baseCurrency: 'TWD',
                    publicFeeCollectorId: '',
                    customTags: JSON.parse(JSON.stringify(DEFAULT_TAGS)),
                    exchangeRates: JSON.parse(JSON.stringify(DEFAULT_EXCHANGE_RATES)),
                    expenses: [],
                    payments: [],
                    members: [],
                    favorites: []
                };
            }

            // Ensure essential fields exist after load
            if (!data.baseCurrency) data.baseCurrency = 'TWD';
            if (!data.customTags) data.customTags = JSON.parse(JSON.stringify(DEFAULT_TAGS));
            if (!data.exchangeRates) data.exchangeRates = JSON.parse(JSON.stringify(DEFAULT_EXCHANGE_RATES));
            if (!data.expenses) data.expenses = [];
            if (!data.payments) data.payments = [];
            if (!data.members) data.members = [];
            if (!data.favorites) data.favorites = [];
            
            data.exchangeRates['TWD'] = 1.0; 

            // ç¢ºä¿å…¬æ¬¾ä»£å¢Šäººå­˜åœ¨
            if (data.members.length > 0 && !data.members.some(m => m.id === data.publicFeeCollectorId)) {
                data.publicFeeCollectorId = data.members[0].id;
            } else if (data.members.length === 0) {
                data.publicFeeCollectorId = '';
            }
        }

        function saveData(silent = false) {
            if (localStorageIsAvailable) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    if (!silent) {
                        // Re-render only affected components after data change
                        renderMembersList();
                        renderPublicFeeCollectorSelect();
                        renderTargetCheckboxes();
                        renderExpensesList();
                        renderRatesList();
                        renderBaseCurrencySelect();
                        renderCurrencyOptions();
                        renderTagsSetting();
                        renderFavorites();
                        calculatePublicFeeBalance();
                        // ç¢ºä¿çµç®—çµæœåœ¨èƒŒæ™¯æ›´æ–°
                        if (document.getElementById('view-result').classList.contains('hidden')) {
                            calculateSettlement();
                        } else {
                            calculateSettlement(true);
                        }
                    }
                } catch (e) {
                    console.error("Error saving data to localStorage:", e);
                    showToast('âš  å„²å­˜è³‡æ–™å¤±æ•—', 'error');
                }
            } else if (!silent) {
                showToast('âš  å„²å­˜å¤±æ•—ï¼šæœ¬åœ°å„²å­˜ä¸å¯ç”¨', 'error');
            }
        }

        function init() {
            loadData();
            renderBaseCurrencySelect();
            renderMembersList();
            renderPublicFeeCollectorSelect();
            renderTargetCheckboxes();
            renderExpensesList();
            renderRatesList();
            renderCurrencyOptions();
            renderTagsSetting();
            renderFavorites();
            calculatePublicFeeBalance();
            // é¦–æ¬¡è¼‰å…¥åªè¨ˆç®—ä¸€æ¬¡ï¼Œä¸å¼·åˆ¶é‡æ–°è¨ˆç®—
            calculateSettlement(); 
            // åˆå§‹åŒ–å–®æ¬¡åˆ†å¸³è¨ˆç®—æ©Ÿ
            updateSplitCalculator();
            // é è¨­åˆ‡æ›åˆ°ç¬¬ä¸€å€‹ tab
            switchTab('members'); 
        }

        // --- Utility Functions ---

        const getRateToBase = (currency) => {
            const baseCur = data.baseCurrency;
            if (currency === baseCur) return 1.0;
            const rateToTWD = data.exchangeRates[currency] || DEFAULT_EXCHANGE_RATES[currency] || 1.0;
            const baseToTWD = data.exchangeRates[baseCur] || 1.0;
            // 1 Unit of Currency = X Unit of BaseCurrency
            return rateToTWD / baseToTWD;
        };

        const getRate = (fromCur, toCur) => {
            if (fromCur === toCur) return 1.0;
            const rateFromToTWD = data.exchangeRates[fromCur] || DEFAULT_EXCHANGE_RATES[fromCur] || 1.0;
            const rateToToTWD = data.exchangeRates[toCur] || DEFAULT_EXCHANGE_RATES[toCur] || 1.0;
            // 1 Unit of FromCur = X Unit of ToCur
            return rateFromToTWD / rateToToTWD;
        };

        function switchTab(tab) {
            const views = ['members', 'expenses', 'result', 'rates', 'settings'];
            views.forEach(view => {
                const viewEl = document.getElementById(`view-${view}`);
                const tabEl = document.getElementById(`tab-${view}`);
                if (view === tab) {
                    viewEl.classList.remove('hidden');
                    // [ä¿®æ”¹] ç§»é™¤èˆŠ/æ–° inactive é¡è‰²ä¸¦åŠ ä¸Šæ–° active é¡è‰² (é©ç”¨æ–¼æ–°çš„æ·ºè‰²å°è¦½åˆ—)
                    tabEl.classList.remove('inactive', 'text-white/60', 'text-gray-500'); 
                    tabEl.classList.add('active', 'text-indigo-600'); 
                    tabEl.classList.remove('text-indigo-400');
                    // é‡æ–°è¨ˆç®—çµç®—çµæœ
                    if (tab === 'result') {
                        calculateSettlement(true);
                    } else if (tab === 'expenses') {
                        // ç¢ºä¿åˆ‡æ›åˆ°è¨˜å¸³é æ™‚ï¼Œé è¨­å¹£åˆ¥æ˜¯åŸºæº–å¹£åˆ¥
                        const expCurSelect = document.getElementById('exp-currency');
                        if (expCurSelect) {
                            expCurSelect.value = data.baseCurrency;
                        }
                    }
                } else {
                    viewEl.classList.add('hidden');
                    // [ä¿®æ”¹] ç§»é™¤èˆŠ/æ–° active é¡è‰²ä¸¦åŠ ä¸Šæ–° inactive é¡è‰² (é©ç”¨æ–¼æ–°çš„æ·ºè‰²å°è¦½åˆ—)
                    tabEl.classList.remove('active', 'text-indigo-400', 'text-indigo-600'); 
                    tabEl.classList.add('inactive', 'text-gray-500'); 
                    tabEl.classList.remove('text-white/60');
                }
            });
        }

        function showToast(msg, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast-container');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');

            if (!toast || !msgEl || !iconEl) return;

            // Reset classes
            toast.className = 'fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-xs z-[80] transition-all duration-300 ease-in-out';
            iconEl.className = '';

            let bgColorClass = 'bg-gray-900/90';

            if (type === 'success') {
                iconEl.classList.add('fa-solid', 'fa-circle-check', 'text-green-400', 'text-2xl');
            } else if (type === 'error') {
                iconEl.classList.add('fa-solid', 'fa-circle-xmark', 'text-red-400', 'text-2xl');
                bgColorClass = 'bg-red-600/90';
            } else if (type === 'warning') {
                iconEl.classList.add('fa-solid', 'fa-triangle-exclamation', 'text-yellow-400', 'text-2xl');
            } else { // info or default
                iconEl.classList.add('fa-solid', 'fa-circle-info', 'text-indigo-400', 'text-2xl');
            }

            msgEl.textContent = msg;
            toast.classList.add(bgColorClass);
            toast.classList.add('translate-y-0');

            setTimeout(() => {
                toast.classList.remove('translate-y-0');
                toast.classList.add('-translate-y-full');
            }, duration);
        }

        function showModal(type, title, message, onConfirm, confirmText = 'ç¢ºå®š') {
            const modal = document.getElementById('confirm-modal');
            const panel = document.getElementById('confirm-panel');
            const titleEl = document.getElementById('confirm-title');
            const msgEl = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-button');

            if (!modal || !panel) return;

            currentModal = modal;
            currentOnConfirm = onConfirm;

            titleEl.textContent = title;
            msgEl.textContent = message;
            confirmBtn.textContent = confirmText;

            confirmBtn.className = 'flex-1 py-3 rounded-xl font-bold text-lg shadow btn-big';
            if (type === 'confirm') {
                confirmBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
            } else {
                confirmBtn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
            }
            
            // Set up CANCEL button
            const cancelBtn = modal.querySelector('button:first-child');
            if (cancelBtn) {
                cancelBtn.textContent = (type === 'confirm') ? 'å–æ¶ˆ' : 'é—œé–‰';
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function closeModal() {
            if (currentModal) {
                const panel = currentModal.querySelector('div:last-child');
                panel.classList.remove('modal-visible-state');
                panel.classList.add('modal-hidden-state');
                setTimeout(() => {
                    currentModal.classList.add('hidden');
                    currentModal = null;
                    currentOnConfirm = null;
                }, 250);
            }
        }

        function handleConfirm() {
            if (currentOnConfirm) {
                currentOnConfirm();
            }
            closeModal();
        }

        // --- Render Functions ---

        function renderCurrencyOptions(selectId) {
            const selects = document.querySelectorAll(`#${selectId}`);
            if (selectId === undefined) {
                // Renders all currency selects by ID
                renderCurrencyOptions('base-currency-select');
                renderCurrencyOptions('exp-currency');
                renderCurrencyOptions('calc-from');
                renderCurrencyOptions('calc-to');
                // Don't forget the edit modal select
                renderCurrencyOptions('edit-currency'); 
                return;
            }

            selects.forEach(selectEl => {
                selectEl.innerHTML = ALL_CURRENCIES.map(c => `<option value="${c}">${c}</option>` ).join('');

                // Set default value based on ID
                if (selectId === 'base-currency-select') {
                    selectEl.value = data.baseCurrency;
                } else if (selectId === 'exp-currency') {
                    selectEl.value = data.baseCurrency; // å„ªåŒ– 1: è¨˜å¸³é è¨­ç‚ºåŸºæº–å¹£åˆ¥
                } else if (selectId === 'calc-from') {
                    selectEl.value = 'TWD';
                } else if (selectId === 'calc-to') {
                    selectEl.value = 'USD';
                }
            });

            // Update calculator if rates list is present
            if (document.getElementById('rates-list')) {
                updateCalculator();
            }
        }

        function renderRatesList() {
            const list = document.getElementById('rates-list');
            if (!list) return;

            const baseToTwdRate = data.exchangeRates[data.baseCurrency] || 1.0;

            const ratesHtml = ALL_CURRENCIES
                .filter(c => c !== data.baseCurrency)
                .map(c => {
                    const rateToTWD = data.exchangeRates[c] || DEFAULT_EXCHANGE_RATES[c] || 1.0;
                    const rateToDisplay = rateToTWD / baseToTwdRate; // 1 Other = ? Base
                    const displayRate = rateToDisplay.toFixed(4);
                    
                    return `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-sm">
                            <span class="font-bold text-lg text-gray-800 flex-1">${c}</span>
                            <div class="flex items-center space-x-2">
                                <input 
                                    onchange="updateRate('${c}', this.value)" 
                                    type="number" 
                                    value="${displayRate}" 
                                    step="0.0001" 
                                    inputmode="decimal"
                                    class="text-xl font-bold text-right text-indigo-600 w-24 border-none bg-transparent focus:bg-white rounded-md p-1"
                                >
                            </div>
                        </div>
                    `;
                }).join('');
            
            list.innerHTML = ratesHtml;

            const rateInfo = document.getElementById('calc-rate-info');
            const rateSourceBadge = document.getElementById('rate-source-badge');
            if (rateInfo) {
                rateInfo.innerText = `ä½¿ç”¨å„²å­˜è³‡æ–™ (åŸºæº–å¹£åˆ¥ï¼š${data.baseCurrency})`;
            }
            if (rateSourceBadge) {
                rateSourceBadge.className = "text-xs bg-green-100 text-green-600 px-2 py-1 rounded font-bold";
                rateSourceBadge.innerText = "âœ“ æœ¬åœ°å„²å­˜";
            }
        }

        function renderBaseCurrencySelect() {
            const baseSelect = document.getElementById('base-currency-select');
            if (!baseSelect) return;
            baseSelect.innerHTML = ALL_CURRENCIES.map(c => 
                `<option value="${c}" ${c === data.baseCurrency ? 'selected' : ''}>${c}</option>`
            ).join('');
            // Update all currency display
            document.querySelectorAll('.current-base-cur').forEach(el => el.textContent = data.baseCurrency);
        }

        function renderPublicFeeCollectorSelect() {
            const select = document.getElementById('public-fee-collector-select');
            if (!select) return;

            select.innerHTML = data.members.map(m => 
                `<option value="${m.id}" ${m.id === data.publicFeeCollectorId ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            // å¦‚æœæ²’æœ‰æˆå“¡ï¼Œç¦ç”¨ä¸‹æ‹‰é¸å–®
            if (data.members.length === 0) {
                select.innerHTML = '<option value="" disabled selected>è«‹å…ˆæ–°å¢æˆå“¡</option>';
            }
        }

        function renderMembersList() {
            const list = document.getElementById('members-list');
            if (!list) return;

            list.innerHTML = data.members.map(m => {
                const tagDisplay = m.tags && m.tags.length > 0 ? m.tags.map(tKey => {
                    const tag = data.customTags.find(t => t.key === tKey);
                    return tag ? `<span class="bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full text-xs font-bold">${tag.name}</span>` : '';
                }).join(' ') : 'ç„¡æ¨™ç±¤';
                const feeCollectedClass = m.isFeeCollected ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400';
                const feeCollectedIcon = m.isFeeCollected ? 'fa-check-circle' : 'fa-circle-xmark';
                const feeCollectedText = m.isFeeCollected ? 'å·²ç¹³' : 'æœªç¹³';
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-md border-b-4 border-indigo-300 space-y-3">
                        <div class="flex justify-between items-start">
                            <h4 class="text-xl font-bold text-gray-800">${m.name} ${m.id === data.publicFeeCollectorId ? '<span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full text-xs font-bold ml-2">å…¬æ¬¾ä»£å¢Š</span>' : ''} </h4>
                            <div class="flex items-center space-x-2">
                                <button onclick="openMemberTagModal('${m.id}')" class="text-gray-500 hover:text-cyan-500 text-sm"><i class="fa-solid fa-tags"></i> æ¨™ç±¤</button>
                                <button onclick="deleteMember('${m.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center ${feeCollectedClass} p-2 rounded-lg cursor-pointer" onclick="toggleFeeCollected('${m.id}')">
                                <span class="font-medium text-gray-700">æ˜¯å¦å·²ç¹³å…¬è²»?</span>
                                <span class="font-bold text-lg text-gray-800 flex items-center">
                                    <i class="fa-solid ${feeCollectedIcon} mr-2"></i> ${feeCollectedText}
                                </span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-medium text-gray-700 flex-1">é ä»˜é‡‘é¡ (${m.prepaidCurrency})</span>
                                <input onchange="updatePrepaid('${m.id}', this.value)" type="number" value="${m.prepaid.toFixed(2)}" step="0.01" inputmode="decimal" class="text-xl font-bold text-right text-indigo-600 w-1/3 border-2 border-gray-300 rounded-lg p-1" onblur="this.value=parseFloat(this.value).toFixed(2)">
                            </div>
                            <div class="text-sm text-gray-500 mt-1">æ¨™ç±¤: ${tagDisplay}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTargetCheckboxes() {
            const targetsList = document.getElementById('targets-list');
            const expPayerSelect = document.getElementById('exp-payer');
            
            if (targetsList) {
                targetsList.innerHTML = data.members.map(m => `
                    <label class="flex items-center cursor-pointer bg-gray-100 p-2 rounded-xl text-sm font-bold shadow-sm hover:bg-gray-200">
                        <input type="checkbox" name="target" value="${m.id}" checked class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                        ${m.name}
                    </label>
                `).join('');
            }

            if (expPayerSelect) {
                expPayerSelect.innerHTML = data.members.map(m => 
                    `<option value="${m.id}" ${m.id === data.publicFeeCollectorId ? 'selected' : ''}>${m.name}</option>`
                ).join('');
                if (data.members.length === 0) {
                    expPayerSelect.innerHTML = '<option value="" disabled selected>è«‹å…ˆæ–°å¢æˆå“¡</option>';
                }
            }
        }

        function renderExpensesList() {
            const list = document.getElementById('expenses-list');
            if (!list) return;

            if (data.expenses.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-xl">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„</div>';
                return;
            }

            // é™åˆ¶åªé¡¯ç¤ºæœ€è¿‘ 20 ç­†
            const displayExpenses = data.expenses.slice(0, 20);

            list.innerHTML = displayExpenses.map(e => {
                const payer = data.members.find(m => m.id === e.payerId)?.name || 'æœªçŸ¥';
                const targets = e.targets.map(tId => data.members.find(m => m.id === tId)?.name || 'æœªçŸ¥').join(', ');
                const isPublic = e.payerId === data.publicFeeCollectorId && e.isPublicFee;
                const baseAmount = (e.amount * e.exchangeRate).toFixed(2);
                const highlightClass = e.highlight ? 'highlight-anim' : '';

                return `
                    <div id="expense-${e.id}" class="bg-white p-4 rounded-xl shadow-lg border-l-8 border-cyan-400 ${highlightClass}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-lg font-bold text-gray-900 flex-1">${e.title} 
                                ${e.category ? `<span class="bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full text-xs font-medium ml-2">${e.category}</span>` : ''} </h4>
                            <div class="flex items-center space-x-2">
                                <button onclick="openEditModal('${e.id}')" class="text-gray-500 hover:text-indigo-500 text-sm"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button onclick="deleteExpense('${e.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                            <div class="text-gray-500">ğŸ’° é‡‘é¡:</div>
                            <div class="font-bold text-right text-gray-800">${e.amount.toFixed(2)} ${e.currency} ${e.currency !== data.baseCurrency ? `<span class="text-xs text-gray-400 ml-1">(${baseAmount} ${data.baseCurrency})</span>` : ''} </div>
                            <div class="text-gray-500">ğŸ‘¤ ä»˜æ¬¾äºº:</div>
                            <div class="font-bold text-right text-indigo-600">${payer} ${isPublic ? '(å…¬æ¬¾æ”¯å‡º)' : ''}</div>
                            <div class="text-gray-500">ğŸ§‘â€ğŸ¤â€ğŸ§‘ åˆ†æ”¤äºº:</div>
                            <div class="text-right text-gray-700">${targets}</div>
                            <div class="text-gray-500">ğŸ“… æ—¥æœŸ:</div>
                            <div class="text-right text-gray-700">${e.date}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Remove highlight pulse after animation
            setTimeout(() => {
                document.querySelectorAll('.highlight-anim').forEach(el => {
                    delete e.highlight; // Also remove from data for next save
                    el.classList.remove('highlight-anim');
                });
                saveData(true);
            }, 2000);
        }

        function renderTagsSetting() {
            const list = document.getElementById('custom-tags-list');
            if (!list) return;

            list.innerHTML = data.customTags.map(t => `
                <div class="flex items-center bg-cyan-50 border border-cyan-200 rounded-full px-3 py-1 text-sm font-bold text-cyan-800 shadow-sm">
                    <span>${t.name}</span>
                    <button onclick="deleteCustomTag('${t.key}')" class="ml-2 text-cyan-600 hover:text-red-500">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderFavorites() {
            const list = document.getElementById('favorites-list');
            if (!list) return;

            list.innerHTML = `
                <button onclick="openFavoriteModal()" class="text-gray-400 hover:text-indigo-500 text-sm font-bold flex items-center">
                    <i class="fa-solid fa-star mr-1"></i> ç·¨è¼¯å¸¸ç”¨æ¸…å–®
                </button>
            ` + data.favorites.map(f => `
                <button onclick="applyFavorite('${f.title}', '${f.category}')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-bold text-sm shadow-sm hover:bg-indigo-100 hover:text-indigo-700 btn-big">
                    ${f.category ? f.category + ' ' : ''}${f.title}
                </button>
            `).join('');
        }

        function renderFavoriteListEditor() {
            const editor = document.getElementById('favorite-list-editor');
            if (!editor) return;

            if (data.favorites.length === 0) {
                editor.innerHTML = '<p class="text-center text-gray-500 py-4">å°šç„¡å¸¸ç”¨é …ç›®</p>';
                return;
            }

            editor.innerHTML = data.favorites.map(f => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-200 shadow-sm">
                    <span class="font-bold text-gray-800">${f.category ? f.category + ' ' : ''}${f.title}</span>
                    <button onclick="deleteFavoriteItem('${f.title}')" class="text-red-500 hover:text-red-700 text-lg">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- Member Logic ---

        function addMember() {
            const nameInput = document.getElementById('input-member-name');
            const name = nameInput.value.trim();

            if (!name) return showToast('è«‹è¼¸å…¥æˆå“¡åç¨±', 'warning');
            if (data.members.some(m => m.name === name)) return showToast('æˆå“¡åç¨±å·²å­˜åœ¨', 'warning');

            const newId = Date.now().toString();
            const newMember = {
                id: newId,
                name: name,
                prepaid: 0.0,
                prepaidCurrency: data.baseCurrency,
                isFeeCollected: false,
                tags: []
            };

            data.members.push(newMember);

            // å¦‚æœæ˜¯ç¬¬ä¸€å€‹æˆå“¡ï¼Œè¨­ç‚ºå…¬æ¬¾ä»£å¢Šäºº
            if (data.members.length === 1) {
                data.publicFeeCollectorId = newId;
            }

            nameInput.value = '';
            saveData();
            showToast(`${name} å·²åŠ å…¥æ—…è¡Œï¼`, 'success');
        }

        function deleteMember(id) {
            const member = data.members.find(m => m.id === id);
            if (!member) return;

            showModal('confirm', 'ç¢ºèªåˆªé™¤æˆå“¡', `ç¢ºå®šè¦åˆªé™¤æˆå“¡ ${member.name} å—ï¼Ÿæ‰€æœ‰ç›¸é—œå¸³å‹™å°‡è¢«æ¸…é™¤ï¼`, () => {
                // ç§»é™¤æ‰€æœ‰ç›¸é—œçš„è²»ç”¨è¨˜éŒ„
                data.expenses = data.expenses.filter(e => e.payerId !== id && !e.targets.includes(id));
                // å¾æ‰€æœ‰è²»ç”¨ä¸­ç§»é™¤ä½œç‚ºåˆ†æ”¤äºº
                data.expenses.forEach(e => {
                    e.targets = e.targets.filter(tId => tId !== id);
                });
                // ç§»é™¤æˆå“¡
                data.members = data.members.filter(m => m.id !== id);

                // é‡æ–°è¨­å®šå…¬æ¬¾ä»£å¢Šäººï¼Œå¦‚æœè¢«åˆªé™¤è€…æ˜¯ä»£å¢Šäºº
                if (data.publicFeeCollectorId === id) {
                    data.publicFeeCollectorId = data.members.length > 0 ? data.members[0].id : '';
                }

                saveData();
                showToast('æˆå“¡å·²åˆªé™¤', 'error');
            });
        }

        function switchPublicFeeCollector(id) {
            data.publicFeeCollectorId = id;
            saveData();
            calculatePublicFeeBalance();
            showToast('å…¬æ¬¾ä»£å¢Šäººå·²åˆ‡æ›');
        }

        function calculatePublicFeeBalance() {
            const collectorId = data.publicFeeCollectorId;
            const balanceEl = document.getElementById('public-fee-balance');
            if (!collectorId || !balanceEl) return;

            // ç¸½å…¬è²»æ”¶å…¥
            const totalPublicPrepaid = data.members.reduce((sum, m) => {
                const prepaidBase = m.prepaid * getRateToBase(m.prepaidCurrency);
                return m.isFeeCollected ? sum + prepaidBase : sum;
            }, 0);

            // ç¸½å…¬è²»æ”¯å‡º (å…¬æ¬¾ä»£å¢Šäººä»£ä»˜çš„è²»ç”¨ï¼Œä¸”æ¨™è¨˜ç‚ºå…¬æ¬¾æ”¯å‡º)
            const totalPublicSpend = data.expenses.reduce((sum, e) => {
                // æª¢æŸ¥æ˜¯å¦ç‚ºå…¬æ¬¾æ”¯å‡º (åœ¨ UI é‚è¼¯ä¸­ï¼Œå…¬æ¬¾æ”¯å‡ºæœƒå°‡ payerId è¨­ç‚ºå…¬æ¬¾ä»£å¢Šäºº ID ä¸” isPublicFee ç‚º true)
                if (e.isPublicFee) {
                    return sum + (e.amount * e.exchangeRate);
                }
                return sum;
            }, 0);

            // æ·¨é¤˜é¡ (å…¬è²»ç¸½æ”¶å…¥ - å…¬è²»ç¸½æ”¯å‡º)
            const balance = totalPublicPrepaid - totalPublicSpend;
            balanceEl.textContent = balance.toFixed(2);
            balanceEl.className = balance >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
        }

        function updatePrepaid(memberId, value) {
            let amount = parseFloat(value);
            const member = data.members.find(m => m.id === memberId);
            if (!member) return;

            if (isNaN(amount) || amount < 0) {
                amount = 0.0;
            }

            member.prepaid = parseFloat(amount.toFixed(2));
            saveData();
        }

        function toggleFeeCollected(memberId) {
            const member = data.members.find(m => m.id === memberId);
            if (!member) return;

            member.isFeeCollected = !member.isFeeCollected;
            saveData();
            showToast(`${member.name} å…¬è²»ç‹€æ…‹å·²æ›´æ–°`);
        }

        function batchAddPrepaid() {
            const amountStr = document.getElementById('batch-prepaid-amount').value;
            const amount = parseFloat(amountStr);

            if (data.members.length === 0) {
                return showToast('è«‹å…ˆæ–°å¢æˆå“¡', 'warning');
            }
            if (isNaN(amount) || amount <= 0) {
                return showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„å…¬è²»é‡‘é¡', 'warning');
            }

            showModal('confirm', 'ç¢ºèªè¿½åŠ å…¬è²»', `ç¢ºå®šæ‰€æœ‰æˆå“¡éƒ½å°‡é ä»˜ ${amount} ${data.baseCurrency} å—ï¼Ÿ`, () => {
                data.members.forEach(m => {
                    // å°‡æ–°è¿½åŠ çš„é‡‘é¡ï¼Œä»¥åŸºæº–å¹£åˆ¥è¨ˆç®—å¾ŒåŠ åˆ°æˆå“¡é ä»˜ä¸­
                    const currentRate = getRateToBase(m.prepaidCurrency); // Rate from member's prepaid currency to Base
                    const newPrepaidBase = m.prepaid * currentRate + amount;
                    
                    // æ›ç®—å›æˆå“¡çš„é ä»˜å¹£åˆ¥
                    m.prepaidCurrency = data.baseCurrency; // çµ±ä¸€é ä»˜å¹£åˆ¥ç‚ºåŸºæº–å¹£åˆ¥
                    m.prepaid = newPrepaidBase / getRateToBase(m.prepaidCurrency); // new rate is 1.0, so it's just newPrepaidBase
                    m.prepaid = parseFloat(m.prepaid.toFixed(2));
                    m.isFeeCollected = true;
                });
                document.getElementById('batch-prepaid-amount').value = '';
                saveData();
                showToast('å…¬è²»è¿½åŠ å®Œæˆï¼');
            });
        }

        function addCustomTag() {
            const nameInput = document.getElementById('input-tag-name');
            const name = nameInput.value.trim();

            if (!name) return showToast('è«‹è¼¸å…¥æ¨™ç±¤åç¨±', 'warning');
            // æª¢æŸ¥é‡è¤‡
            if (data.customTags.some(t => t.name === name)) {
                return showToast('æ­¤æ¨™ç±¤åç¨±å·²å­˜åœ¨', 'warning');
            }

            const newTag = {
                key: name.toLowerCase().replace(/[^a-z0-9]/g, '_') + Date.now().toString().slice(-4), // Simple unique key
                name: name
            };
            data.customTags.push(newTag);
            nameInput.value = '';
            saveData();
            showToast('æ–°æ¨™ç±¤å·²æ–°å¢');
        }

        function deleteCustomTag(key) {
            showModal('confirm', 'ç¢ºèªåˆªé™¤æ¨™ç±¤', 'æ­¤æ¨™ç±¤å°‡å¾æ‰€æœ‰æˆå“¡èº«ä¸Šç§»é™¤ï¼Œç¢ºèªåˆªé™¤å—ï¼Ÿ', () => {
                data.customTags = data.customTags.filter(t => t.key !== key);
                data.members.forEach(m => {
                    m.tags = m.tags.filter(tKey => tKey !== key);
                });
                saveData();
                showToast('æ¨™ç±¤å·²åˆªé™¤', 'error');
            });
        }
        
        // --- Expense Logic ---

        function toggleExpenseType(isPublic) {
            const payerContainer = document.getElementById('individual-payer-select-container');
            const publicNote = document.getElementById('public-fee-note');
            const payerSelect = document.getElementById('exp-payer');
            const collectorId = data.publicFeeCollectorId;

            if (isPublic) {
                if (!collectorId) {
                    showToast('è«‹å…ˆæŒ‡å®šä¸€ä½å…¬æ¬¾ä»£å¢Šäºº', 'warning');
                    document.getElementById('is-public-fee').checked = false;
                    return;
                }
                payerContainer.classList.add('hidden');
                publicNote.classList.remove('hidden');
            } else {
                payerContainer.classList.remove('hidden');
                publicNote.classList.add('hidden');
                // åˆ‡å›å€‹äººæ”¯å‡ºæ™‚ï¼Œé è¨­é¸æ“‡å…¬æ¬¾ä»£å¢Šäººï¼Œå› ç‚ºä»–æœ€å¸¸ä»˜æ¬¾
                if (collectorId) {
                    payerSelect.value = collectorId;
                }
            }
        }

        function toggleAllTargets() {
            const checkboxes = document.querySelectorAll('#targets-list input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
        }

        function addExpense() {
            const title = document.getElementById('exp-title').value.trim();
            const amountStr = document.getElementById('exp-amount').value;
            const currency = document.getElementById('exp-currency').value;
            const category = document.getElementById('exp-category').value;
            const isPublicFee = document.getElementById('is-public-fee').checked;
            
            let payerId = '';
            if (isPublicFee) {
                payerId = data.publicFeeCollectorId;
            } else {
                payerId = document.getElementById('exp-payer').value;
            }

            const targetCheckboxes = document.querySelectorAll('#targets-list input[type="checkbox"]:checked');
            const targets = Array.from(targetCheckboxes).map(cb => cb.value);

            const amount = parseFloat(amountStr);
            
            if (!title) return showToast('è«‹è¼¸å…¥æ¶ˆè²»åç¨±', 'warning');
            if (isNaN(amount) || amount <= 0) return showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'warning');
            if (!payerId) return showToast('è«‹é¸æ“‡ä»˜æ¬¾äºº', 'warning');
            if (targets.length === 0) return showToast('è«‹é¸æ“‡åˆ†æ”¤äºº', 'warning');

            // 1. Get exchange rate from expense currency to data.baseCurrency
            const exchangeRate = getRateToBase(currency);

            const newExpense = {
                id: Date.now().toString(),
                title: title,
                amount: amount,
                currency: currency,
                exchangeRate: exchangeRate,
                payerId: payerId,
                targets: targets,
                category: category,
                isPublicFee: isPublicFee, // Add this field for clarity
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD format
                highlight: true // For animation
            };

            data.expenses.unshift(newExpense);
            
            // Clear inputs and reset targets
            document.getElementById('exp-title').value = '';
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-category').value = '';
            document.getElementById('is-public-fee').checked = false;
            toggleExpenseType(false); // Reset UI to individual payer
            document.getElementById('exp-payer').value = payerId; // Keep the last payer selected

            // Re-select all targets for next expense
            document.querySelectorAll('#targets-list input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });

            saveData();
            showToast(`è¨˜å¸³æˆåŠŸï¼ ${title} ${amount} ${currency}`, 'success');
        }

        function deleteExpense(id) {
            showModal('confirm', 'ç¢ºèªåˆªé™¤æ¶ˆè²»', 'é€™ç­†æ¶ˆè²»ç´€éŒ„å°‡æœƒè¢«ç§»é™¤ï¼Œç¢ºèªå—ï¼Ÿ', () => {
                data.expenses = data.expenses.filter(e => e.id !== id);
                saveData();
                showToast('æ¶ˆè²»å·²åˆªé™¤', 'error');
            });
        }

        function openEditModal(id) {
            currentEditingId = id;
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('edit-title').value = expense.title;
            document.getElementById('edit-amount').value = expense.amount;

            // Populate currency select options and set value
            const editCurrencySelect = document.getElementById('edit-currency');
            editCurrencySelect.innerHTML = ALL_CURRENCIES.map(c => 
                `<option value="${c}" ${c === expense.currency ? 'selected' : ''}>${c}</option>`
            ).join('');

            document.getElementById('edit-date').value = expense.date;
            document.getElementById('edit-category').value = expense.category || '';

            const modal = document.getElementById('edit-modal');
            const panel = document.getElementById('edit-panel');
            modal.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            const panel = document.getElementById('edit-panel');
            panel.classList.remove('modal-visible-state');
            panel.classList.add('modal-hidden-state');
            setTimeout(() => {
                modal.classList.add('hidden');
                currentEditingId = null;
            }, 250);
        }

        function saveEdit() {
            if (!currentEditingId) return;

            const expense = data.expenses.find(e => e.id === currentEditingId);
            if (!expense) return;

            const newTitle = document.getElementById('edit-title').value.trim();
            const newAmountStr = document.getElementById('edit-amount').value;
            const newCurrency = document.getElementById('edit-currency').value;
            const newDate = document.getElementById('edit-date').value;
            const newCategory = document.getElementById('edit-category').value;

            const newAmount = parseFloat(newAmountStr);

            if (!newTitle || isNaN(newAmount) || newAmount <= 0) {
                return showToast('è«‹ç¢ºä¿åç¨±å’Œæœ‰æ•ˆé‡‘é¡å·²å¡«å¯«', 'warning');
            }

            // Update expense data
            expense.title = newTitle;
            expense.amount = parseFloat(newAmount.toFixed(2));
            expense.currency = newCurrency;
            expense.date = newDate;
            expense.category = newCategory;
            // Recalculate exchange rate just in case base currency or rates changed since original entry
            expense.exchangeRate = getRateToBase(newCurrency);
            expense.highlight = true; // For animation

            saveData();
            closeEditModal();
            showToast('æ¶ˆè²»ä¿®æ”¹å·²å„²å­˜', 'success');
        }

        // --- Favorite Logic ---
        function openFavoriteModal() {
            const modal = document.getElementById('favorite-modal');
            const panel = document.getElementById('favorite-panel');
            renderFavoriteListEditor();
            modal.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('modal-hidden-state');
                panel.classList.add('modal-visible-state');
            }, 10);
        }

        function closeFavoriteModal() {
            const modal = document.getElementById('favorite-modal');
            const panel = document.getElementById('favorite-panel');
            panel.classList.remove('modal-visible-state');
            panel.classList.add('modal-hidden-state');
            setTimeout(() => {
                modal.classList.add('hidden');
                renderFavorites();
            }, 250);
        }

        function addFavoriteItem() {
            const titleInput = document.getElementById('new-favorite-title');
            const categoryInput = document.getElementById('new-favorite-category');
            const title = titleInput.value.trim();
            const category = categoryInput.value.trim();

            if (!title) return showToast('è«‹è¼¸å…¥å¸¸ç”¨åç¨±', 'warning');
            if (data.favorites.some(f => f.title === title)) return showToast('å¸¸ç”¨é …ç›®å·²å­˜åœ¨', 'warning');

            data.favorites.push({ title: title, category: category });
            titleInput.value = '';
            categoryInput.value = '';
            saveData();
            renderFavoriteListEditor();
            showToast('å¸¸ç”¨é …ç›®å·²æ–°å¢');
        }

        function deleteFavoriteItem(title) {
            data.favorites = data.favorites.filter(f => f.title !== title);
            saveData();
            renderFavoriteListEditor();
            showToast('å¸¸ç”¨é …ç›®å·²åˆªé™¤', 'error');
        }

        function applyFavorite(title, category) {
            document.getElementById('exp-title').value = title;
            // å˜—è©¦åŒ¹é…é è¨­é¡åˆ¥
            const categorySelect = document.getElementById('exp-category');
            const matchingOption = Array.from(categorySelect.options).find(opt => opt.text.includes(category));
            if (matchingOption) {
                categorySelect.value = matchingOption.value;
            } else {
                categorySelect.value = '';
            }
            showToast(`å·²å¥—ç”¨å¸¸ç”¨é …ç›®: ${title}`);
        }

        // --- Settlement Logic ---
        function calculateSettlement(forceRecalculate = false) {
            const loading = document.getElementById('plan-loading');
            if (loading) loading.style.display = 'block';

            if (!forceRecalculate && settlementResult) {
                renderResult(settlementResult);
                if (loading) loading.style.display = 'none';
                return;
            }

            const balances = {};
            const baseCur = data.baseCurrency;
            data.members.forEach(m => {
                balances[m.id] = {
                    id: m.id, // æ–°å¢ id æ¬„ä½ä»¥ä¾›è½‰å¸³è¨ˆç•«ä½¿ç”¨
                    name: m.name,
                    prepaid: 0,
                    spend: 0,
                    balance: 0
                };
            });

            let totalSpend = 0;
            let totalPrepaid = 0;

            // 1. è¨ˆç®—é ä»˜é‡‘ (Prepaid)
            data.members.forEach(m => {
                const prepaidBase = m.prepaid * getRateToBase(m.prepaidCurrency);
                if (m.isFeeCollected) {
                    balances[m.id].prepaid += prepaidBase;
                }
                totalPrepaid += prepaidBase;
            });

            // 2. è¨ˆç®—èŠ±è²»åˆ†æ”¤ (Spend)
            data.expenses.forEach(e => {
                const amountBase = e.amount * e.exchangeRate;
                totalSpend += amountBase;
                
                const targetsCount = e.targets.length;
                if (targetsCount > 0) {
                    const share = amountBase / targetsCount;
                    e.targets.forEach(memberId => {
                        if (balances[memberId]) {
                            balances[memberId].spend += share;
                        }
                    });
                }
            });

            // 3. è¨ˆç®—æ·¨é¤˜é¡
            const memberBalances = Object.values(balances).map(b => {
                // æ·¨é¤˜é¡ = é ä»˜é‡‘ - å¹³å‡èŠ±è²»
                b.balance = parseFloat((b.prepaid - b.spend).toFixed(2));
                return b;
            });

            // 4. è¨ˆç®—è½‰å¸³è¨ˆç•«
            const plan = simplifySettlement(memberBalances.filter(b => b.balance !== 0));

            settlementResult = {
                totalSpend: totalSpend.toFixed(2),
                totalPrepaid: totalPrepaid.toFixed(2),
                memberBalances: memberBalances,
                plan: plan
            };

            renderResult(settlementResult);
            if (loading) loading.style.display = 'none';
        }


        // 5. çµç®—ç°¡åŒ–æ¼”ç®—æ³•
        function simplifySettlement(balances) {
            const payers = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance); // æ‡‰æ”¶ > 0
            const receivers = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance); // æ‡‰ä»˜ < 0

            const plan = [];

            let pIndex = 0;
            let rIndex = 0;

            // æ‡‰ä»˜é‡‘é¡å–çµ•å°å€¼
            receivers.forEach(r => r.balance = Math.abs(r.balance));
            
            while (pIndex < payers.length && rIndex < receivers.length) {
                let payer = payers[pIndex];
                let receiver = receivers[rIndex];
                
                // æ‡‰ä»˜é‡‘é¡ (Receiver's absolute balance)
                const amount = Math.min(payer.balance, receiver.balance);

                plan.push({
                    from: receiver.id,
                    to: payer.id,
                    amount: amount.toFixed(2)
                });

                payer.balance -= amount;
                receiver.balance -= amount;

                if (payer.balance < 0.01) {
                    pIndex++;
                }
                if (receiver.balance < 0.01) {
                    rIndex++;
                }
            }

            return plan;
        }

        function renderResult(result) {
            if (!result || !data.members.length) {
                document.getElementById('member-balance-list').innerHTML = '<div class="text-center text-gray-400 py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 text-xl">æˆå“¡ä¸è¶³æˆ–å°šæœªè¨˜å¸³</div>';
                document.getElementById('settlement-plan').innerHTML = '';
                document.getElementById('total-spend').textContent = '0';
                document.getElementById('total-prepaid').textContent = '0';
                return;
            }

            document.getElementById('total-spend').textContent = result.totalSpend;
            document.getElementById('total-prepaid').textContent = result.totalPrepaid;

            const baseCur = data.baseCurrency;

            // æ¸²æŸ“æˆå“¡çµç®—åˆ—è¡¨
            const balanceList = document.getElementById('member-balance-list');
            balanceList.innerHTML = result.memberBalances.map(b => {
                const statusClass = b.balance > 0.01 ? 'bg-green-100 text-green-700' : b.balance < -0.01 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
                const statusText = b.balance > 0.01 ? 'æ‡‰æ”¶' : b.balance < -0.01 ? 'æ‡‰ä»˜' : 'çµæ¸…';
                const sign = b.balance > 0.01 ? '+' : '';
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-md border-b-4 ${statusClass.includes('green') ? 'border-green-400' : statusClass.includes('red') ? 'border-red-400' : 'border-gray-300'}">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xl font-bold text-gray-800">${b.name}</h4>
                            <span class="px-3 py-1 rounded-full font-bold ${statusClass}">${statusText} ${sign}${Math.abs(b.balance).toFixed(2)} ${baseCur}</span>
                        </div>
                        <div class="grid grid-cols-3 text-sm mt-2 text-gray-600 border-t border-gray-100 pt-2">
                            <p class="text-left">ç¸½é ä»˜:</p><p class="text-center">${b.prepaid.toFixed(2)}</p>
                            <p class="text-right">ç¸½èŠ±è²»:</p><p class="text-left">${b.spend.toFixed(2)}</p>
                            <p class="text-center text-gray-400">(${baseCur})</p>
                        </div>
                    </div>
                `;
            }).join('');

            // æ¸²æŸ“è½‰å¸³è¨ˆç•«
            const planList = document.getElementById('settlement-plan');
            if (result.plan.length === 0) {
                planList.innerHTML = '<div class="text-center text-gray-500 py-4">å¸³å‹™å·²çµæ¸…ï¼Œç„¡é ˆè½‰å¸³ã€‚</div>';
            } else {
                planList.innerHTML = result.plan.map(p => {
                    const f = data.members.find(m => m.id === p.from)?.name;
                    const t = data.members.find(m => m.id === p.to)?.name;
                    return `
                        <div class="bg-indigo-50 p-3 rounded-xl shadow-md border-l-4 border-indigo-400 flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-800 flex-1">
                                ğŸ’¸ ${f} <i class="fa-solid fa-arrow-right mx-2 text-indigo-500"></i> ${t}
                            </span>
                            <span class="text-xl font-bold text-indigo-600">${p.amount} ${baseCur}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function copyReport() {
            if (!settlementResult) {
                calculateSettlement(true);
                return showToast('æ­£åœ¨è¨ˆç®—çµæœï¼Œè«‹ç¨å€™å†è©¦', 'info');
            }
            if (!navigator.clipboard) {
                showToast('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å‰ªè²¼ç°¿åŠŸèƒ½', 'error');
                return;
            }

            const baseCur = data.baseCurrency;
            let text = `ã€æ—…è¡Œè¨˜å¸³æœ¬ - çµç®—å ±å‘Šã€‘\n`;
            text += `çµç®—å¹£åˆ¥: ${baseCur}\n`;
            text += `ç¸½èŠ±è²»: ${settlementResult.totalSpend} ${baseCur}\n`;
            text += `ç¸½é ä»˜: ${settlementResult.totalPrepaid} ${baseCur}\n\n`;

            text += `--- æˆå“¡æ·¨é¤˜é¡ ---\n`;
            settlementResult.memberBalances.forEach(b => {
                const statusText = b.balance > 0.01 ? 'æ‡‰æ”¶' : b.balance < -0.01 ? 'æ‡‰ä»˜' : 'çµæ¸…';
                const sign = b.balance > 0.01 ? '+' : '';
                text += `ğŸ‘¤ ${b.name}: ${statusText} ${sign}${Math.abs(b.balance).toFixed(2)} ${baseCur}\n`;
            });
            text += `\n`;

            text += `--- è½‰å¸³çµç®—è¨ˆç•« ---\n`;
            if (settlementResult.plan.length === 0) {
                text += `âœ… å¸³å‹™å·²çµæ¸…ï¼Œç„¡é ˆè½‰å¸³ã€‚\n`;
            } else {
                settlementResult.plan.forEach(p => {
                    const f = data.members.find(m => m.id === p.from)?.name;
                    const t = data.members.find(m => m.id === p.to)?.name;
                    text += `ğŸ‘‰ ${f} çµ¦ ${t}ï¼š${p.amount} ${baseCur}\n`;
                });
            }

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('è¤‡è£½å¥½äº†ï¼');
            } catch(e) {
                alert('è¤‡è£½å¤±æ•—');
            }
            document.body.removeChild(ta);
        }

        // --- Exchange Rate Logic ---

        function updateCalculator(isTargetInput = false) {
            const amountFromEl = document.getElementById('calc-amount');
            const amountToEl = document.getElementById('calc-amount-to');
            const fromCur = document.getElementById('calc-from').value;
            const toCur = document.getElementById('calc-to').value;
            const resultAmountEl = document.getElementById('calc-result-amount');
            const resultCurEl = document.getElementById('calc-result-cur');

            const amountFrom = parseFloat(amountFromEl.value);
            const amountTo = parseFloat(amountToEl.value);

            resultCurEl.textContent = toCur;

            if (fromCur === toCur) {
                amountToEl.value = amountFromEl.value;
                resultAmountEl.textContent = isNaN(amountFrom) ? '0' : amountFrom.toFixed(2);
                return;
            }

            const rateFromTo = getRate(fromCur, toCur);
            
            if (isNaN(rateFromTo)) {
                showToast('åŒ¯ç‡è³‡è¨Šä¸è¶³', 'warning');
                resultAmountEl.textContent = '???';
                return;
            }

            if (isTargetInput) {
                // User input 'to' amount, calculate 'from' amount
                if (isNaN(amountTo) || amountTo <= 0) {
                    amountFromEl.value = '';
                    resultAmountEl.textContent = '0';
                    return;
                }
                const calculatedFrom = amountTo / rateFromTo;
                amountFromEl.value = calculatedFrom.toFixed(2);
                resultAmountEl.textContent = amountTo.toFixed(2);

            } else {
                // User input 'from' amount, calculate 'to' amount
                if (isNaN(amountFrom) || amountFrom <= 0) {
                    amountToEl.value = '';
                    resultAmountEl.textContent = '0';
                    return;
                }
                const calculatedTo = amountFrom * rateFromTo;
                amountToEl.value = calculatedTo.toFixed(2);
                resultAmountEl.textContent = calculatedTo.toFixed(2);
            }
        }

        // --- NEW: Single Split Calculator Logic ---
        function updateSplitCalculator() {
            const totalAmountEl = document.getElementById('split-total-amount');
            const totalPeopleEl = document.getElementById('split-total-people');
            const avgAmountEl = document.getElementById('split-avg-amount');
            const remainderEl = document.getElementById('split-remainder');

            const totalAmount = parseFloat(totalAmountEl.value) || 0;
            let totalPeople = parseInt(totalPeopleEl.value);

            if (isNaN(totalPeople) || totalPeople < 1) {
                totalPeople = 1;
                totalPeopleEl.value = 1;
            }

            if (totalAmount <= 0 || totalPeople <= 0) {
                avgAmountEl.innerHTML = '0 <span class="text-base text-gray-500 font-normal ml-2"> (ç²¾ç¢ºå€¼: 0)</span>';
                remainderEl.textContent = '0';
                remainderEl.className = 'text-xl font-bold text-green-600';
                return;
            }

            const avgExact = totalAmount / totalPeople;
            
            // 1. å»ºè­°æ¯äººæ”¯ä»˜é‡‘é¡ (å‘ä¸Šå–æ•´åˆ°æ•´æ•¸ï¼Œæ–¹ä¾¿æ”¯ä»˜)
            const avgRoundUp = Math.ceil(avgExact);
            
            // 2. æ¹Šæ•´å¾Œçš„ç¸½é‡‘é¡
            const totalPaidRoundUp = avgRoundUp * totalPeople;
            
            // 3. é¤˜é¡ (ä»£å¢Šäººå¤šæ”¶/å°‘ä»˜çš„é‡‘é¡)
            const remainder = parseFloat((totalPaidRoundUp - totalAmount).toFixed(2)); 

            avgAmountEl.innerHTML = `
                ${avgRoundUp.toFixed(0)} 
                <span class="text-base text-gray-500 font-normal ml-2"> (ç²¾ç¢ºå€¼: ${avgExact.toFixed(2)})</span>
            `;
            
            remainderEl.textContent = remainder.toFixed(2);
            remainderEl.className = `text-xl font-bold ${remainder === 0 ? 'text-green-600' : 'text-red-600'}`;
        }
        // --- END: Single Split Calculator Logic ---

        function switchBaseCurrency(newBase) {
            if (data.baseCurrency === newBase) return;

            showModal('confirm', 'ç¢ºèªåˆ‡æ›åŸºæº–å¹£åˆ¥', `åˆ‡æ›åŸºæº–å¹£åˆ¥æœƒå½±éŸ¿æ‰€æœ‰å„²å­˜çš„ã€ŒåŒ¯ç‡ã€å’Œã€Œå…¬è²»ã€è¨ˆç®—ï¼Œç¢ºå®šè¦å°‡åŸºæº–å¹£åˆ¥åˆ‡æ›ç‚º ${newBase} å—ï¼Ÿ`, () => {
                data.baseCurrency = newBase;
                
                // é‡æ–°è¨ˆç®—æ‰€æœ‰è²»ç”¨çš„ exchangeRate (1 ExpenseCur = ? BaseCur)
                data.expenses.forEach(e => {
                    e.exchangeRate = getRateToBase(e.currency);
                });

                // é‡æ–°è¨ˆç®—æ‰€æœ‰æˆå“¡çš„ prepaid (ä¿æŒåŸºæº–å¹£åˆ¥çš„åƒ¹å€¼ä¸è®Šï¼Œæ›ç®—å›æˆå“¡çš„å¹£åˆ¥)
                data.members.forEach(m => {
                    const prepaidBase = m.prepaid * getRateToBase(m.prepaidCurrency);
                    m.prepaidCurrency = newBase; // å°‡æˆå“¡çš„é ä»˜å¹£åˆ¥ä¹Ÿåˆ‡æ›
                    m.prepaid = prepaidBase / getRateToBase(newBase); // new rate is 1.0, so it's just prepaidBase
                    m.prepaid = parseFloat(m.prepaid.toFixed(2));
                });
                
                saveData();
                showToast(`åŸºæº–å¹£åˆ¥å·²åˆ‡æ›ç‚º ${newBase}`, 'success');
            }, 'åˆ‡æ›');
        }

        function fetchLiveRates() {
            const badge = document.getElementById('rate-source-badge');
            const info = document.getElementById('calc-rate-info');
            if(badge) { 
                badge.className = "text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold"; 
                badge.innerText = "æ›´æ–°ä¸­..."; 
            }
            if(info) info.innerText = "æ­£åœ¨é€£ç·šåˆ°ç¶²è·¯åŒ¯ç‡...";

            // ä½¿ç”¨ TWD ç‚ºåŸºæº–ç²å–åŒ¯ç‡ (1 TWD = ? Other Currencies)
            fetch('https://api.exchangerate-api.com/v4/latest/TWD')
                .then(r => r.json())
                .then(d => {
                    if (d.rates) {
                        liveRates = d.rates;
                        if(!liveRates['TWD']) liveRates['TWD'] = 1;
                        updateRatesFromLive();
                    } else {
                        if(badge) { 
                            badge.className = "text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold"; 
                            badge.innerText = "âŒ æ›´æ–°å¤±æ•—"; 
                        }
                        showToast('ç¶²è·¯åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤', 'error');
                    }
                })
                .catch(e => {
                    if(badge) { 
                        badge.className = "text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold"; 
                        badge.innerText = "âŒ æ›´æ–°å¤±æ•—"; 
                    }
                    showToast('ç¶²è·¯åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼šé€£ç·šå•é¡Œ', 'error');
                    if(info) info.innerText = "ç„¡æ³•é€£ç·šåˆ°ç¶²è·¯åŒ¯ç‡ï¼Œä½¿ç”¨å„²å­˜è³‡æ–™";
                    updateCalculator();
                    calculateSettlement();
                });
        }

        function updateRatesFromLive() {
            const badge = document.getElementById('rate-source-badge');
            const info = document.getElementById('calc-rate-info');
            const newExchangeRates = JSON.parse(JSON.stringify(data.exchangeRates));

            if (!liveRates) return;

            // 1 TWD = X Other Currencies (from API)
            // We need 1 Other Currency = X TWD (for our internal storage)
            ALL_CURRENCIES.forEach(c => {
                if (c === 'TWD') {
                    newExchangeRates['TWD'] = 1.0;
                    return;
                }
                const rateToTWD = liveRates[c] ? (1 / liveRates[c]) : DEFAULT_EXCHANGE_RATES[c];
                newExchangeRates[c] = parseFloat(rateToTWD.toFixed(4));
            });

            data.exchangeRates = newExchangeRates;
            saveData(); // Save and re-render lists

            if(badge) { 
                badge.className = "text-xs bg-green-100 text-green-600 px-2 py-1 rounded font-bold"; 
                badge.innerText = "âœ“ ç¶²è·¯æ›´æ–°"; 
            }
            if(info) info.innerText = `æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleTimeString()} (åŸºæº–å¹£åˆ¥ï¼š${data.baseCurrency})`;
            showToast('åŒ¯ç‡å·²æ›´æ–°ï¼', 'success');
        }

        function updateRate(currency, value) {
            let rateInput = parseFloat(value);
            if (isNaN(rateInput) || rateInput <= 0) {
                showToast('åŒ¯ç‡å€¼å¿…é ˆæ˜¯æ­£æ•¸', 'warning');
                renderRatesList();
                return;
            }

            // rateInput: 1 Other = ? Base
            const baseToTwdRate = data.exchangeRates[data.baseCurrency] || 1.0;

            // newTwdRate: 1 Other = ? TWD
            const newTwdRate = rateInput * baseToTwdRate;
            data.exchangeRates[currency] = parseFloat(newTwdRate.toFixed(4));

            saveData();
            showToast(`å·²æ›´æ–° ${currency} åŒ¯ç‡`);
        }
        
        // --- Backup and Restore ---

        function exportData(type) {
            let fileContent = '';
            let mimeType = '';
            let fileName = '';

            if (type === 'json') {
                fileContent = JSON.stringify(data, null, 2);
                mimeType = 'application/json';
                fileName = `travel_bookkeeping_backup_${new Date().toISOString().split('T')[0]}.json`;
            } else if (type === 'text') {
                // Generate simple text report (similar to copyReport but without clipboard logic)
                calculateSettlement(true);
                const result = settlementResult;
                if (!result) return showToast('è«‹å…ˆè¨ˆç®—çµç®—çµæœ', 'warning');

                const baseCur = data.baseCurrency;
                let text = `ã€æ—…è¡Œè¨˜å¸³æœ¬ - å®Œæ•´ç´€éŒ„ã€‘\n`;
                text += `\n== çµç®—è³‡è¨Š ==\n`;
                text += `çµç®—å¹£åˆ¥: ${baseCur}\n`;
                text += `ç¸½èŠ±è²»: ${result.totalSpend} ${baseCur}\n`;
                text += `ç¸½é ä»˜: ${result.totalPrepaid} ${baseCur}\n\n`;

                text += `== æˆå“¡æ·¨é¤˜é¡ ==\n`;
                result.memberBalances.forEach(b => {
                    const statusText = b.balance > 0.01 ? 'æ‡‰æ”¶' : b.balance < -0.01 ? 'æ‡‰ä»˜' : 'çµæ¸…';
                    const sign = b.balance > 0.01 ? '+' : '';
                    text += `ğŸ‘¤ ${b.name}: ${statusText} ${sign}${Math.abs(b.balance).toFixed(2)} ${baseCur} (é ä»˜: ${b.prepaid.toFixed(2)}, èŠ±è²»: ${b.spend.toFixed(2)})\n`;
                });
                text += `\n`;

                text += `== è½‰å¸³çµç®—è¨ˆç•« ==\n`;
                if (result.plan.length === 0) {
                    text += `âœ… å¸³å‹™å·²çµæ¸…ï¼Œç„¡é ˆè½‰å¸³ã€‚\n`;
                } else {
                    result.plan.forEach(p => {
                        const f = data.members.find(m => m.id === p.from)?.name;
                        const t = data.members.find(m => m.id === p.to)?.name;
                        text += `ğŸ‘‰ ${f} çµ¦ ${t}ï¼š${p.amount} ${baseCur}\n`;
                    });
                }
                text += `\n`;
                
                text += `== è²»ç”¨æ˜ç´° ==\n`;
                data.expenses.forEach(e => {
                    const payer = data.members.find(m => m.id === e.payerId)?.name || 'æœªçŸ¥';
                    const targets = e.targets.map(tId => data.members.find(m => m.id === tId)?.name || 'æœªçŸ¥').join(', ');
                    const baseAmount = (e.amount * e.exchangeRate).toFixed(2);
                    text += `[${e.date}] ${e.title} (${e.category || 'ç„¡é¡åˆ¥'}) - ${e.amount.toFixed(2)} ${e.currency} (${baseAmount} ${baseCur})\n`;
                    text += `   - ä»˜æ¬¾äºº: ${payer} ${e.isPublicFee ? '(å…¬æ¬¾æ”¯å‡º)' : ''}\n`;
                    text += `   - åˆ†æ”¤äºº: ${targets}\n`;
                });
                
                fileContent = text;
                mimeType = 'text/plain';
                fileName = `travel_bookkeeping_report_${new Date().toISOString().split('T')[0]}.txt`;
            } else if (type === 'csv') {
                copyExpensesAsCsv(true); // Internal call to get CSV content
                return;
            } else {
                return; // Should not happen
            }

            const b = new Blob([fileContent], {type: mimeType});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(u);
            showToast(`è³‡æ–™å·²åŒ¯å‡ºç‚º ${type.toUpperCase()} æª”æ¡ˆ`);
        }

        // å„ªåŒ– 3: CSV è¤‡è£½åŠŸèƒ½
        function copyExpensesAsCsv() {
            if (!navigator.clipboard) {
                showToast('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å‰ªè²¼ç°¿åŠŸèƒ½', 'error');
                return;
            }
            if (data.expenses.length === 0) {
                showToast('æ²’æœ‰è¨˜å¸³ç´€éŒ„å¯è¤‡è£½', 'warning');
                return;
            }

            const headers = ["æ—¥æœŸ", "åç¨±", "é¡åˆ¥", "é‡‘é¡", "å¹£åˆ¥", "æŠ˜ç®—(åŸºæº–å¹£åˆ¥)", "ä»˜æ¬¾äºº", "åˆ†æ”¤äºº"];
            const csvRows = [headers.join(',')];

            data.expenses.forEach(e => {
                const payer = data.members.find(m => m.id === e.payerId)?.name || 'æœªçŸ¥';
                const targets = e.targets.map(tId => data.members.find(m => m.id === tId)?.name || 'æœªçŸ¥').join(';');
                const baseAmount = (e.amount * e.exchangeRate).toFixed(2);

                const row = [
                    `"${e.date}"`,
                    `"${e.title}"`,
                    `"${e.category || ''}"`,
                    e.amount.toFixed(2),
                    e.currency,
                    baseAmount,
                    `"${payer}"`,
                    `"${targets}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            
            const ta = document.createElement('textarea');
            ta.value = csvString;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('è¨˜å¸³æ˜ç´° (CSV æ ¼å¼) å·²è¤‡è£½ï¼', 'success');
            } catch(e) {
                alert('è¤‡è£½å¤±æ•—');
            }
            document.body.removeChild(ta);
        }

        function importData(event) { 
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.members && importedData.expenses) {
                        showModal('confirm', 'ç¢ºèªåŒ¯å…¥è³‡æ–™', 'é€™å°‡è¦†è“‹æ‰€æœ‰ç•¶å‰è³‡æ–™ï¼Œç¢ºèªåŒ¯å…¥å—ï¼Ÿ', () => {
                            data = importedData;
                            data.exchangeRates['TWD'] = 1.0; // ç¢ºä¿åŒ¯ç‡æ­£ç¢º
                            saveData();
                            showToast('è³‡æ–™å·²æˆåŠŸåŒ¯å…¥', 'success');
                        });
                    } else {
                        showToast('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º', 'error');
                    }
                } catch(error) {
                    showToast('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆè§£æéŒ¯èª¤', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearData() { 
            if (localStorageIsAvailable) {
                localStorage.removeItem(STORAGE_KEY);
            }
            data = {};
            loadData(); // é‡æ–°åˆå§‹åŒ–ç‚ºé è¨­å€¼
            saveData();
            showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
            switchTab('members');
        }

        function confirmClearData() {
            showModal('confirm', 'è­¦å‘Šï¼šæ°¸ä¹…åˆªé™¤', 'æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', clearData, 'ç¢ºèªæ¸…é™¤');
        }
    </script>
</body>
</html>
