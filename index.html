<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œè¨˜å¸³æœ¬ V8.9b (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #FFFBEB; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
            -webkit-tap-highlight-color: transparent; 
            font-size: 16px;
        }
        .container {
            max-width: 800px; /* é™åˆ¶å¯¬åº¦ */
        }
        /* éš±è—é è¨­æ»¾å‹•æ¢ï¼Œä½¿ç”¨æ›´å„ªé›…çš„æ¨£å¼ */
        .custom-scroll::-webkit-scrollbar {
            display: none;
        }
        .custom-scroll {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* é¿å… Tailwind CSS å½±éŸ¿ select çš„ç®­é ­ */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Tabs æ¨£å¼ */
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #D97706; /* amber-600 */
            background-color: #FEF3C7; /* amber-100 */
            color: #D97706;
            font-weight: 700;
        }

        /* Toast Message */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50; /* Higher than modal */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .toast {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
        }
    </style>
</head>

<body class="p-0 sm:p-4 pb-20">
    <div class="container mx-auto bg-white shadow-xl rounded-lg min-h-screen">
        
        <div class="sticky top-0 bg-white border-b border-amber-500 z-30 shadow-md">
            <div id="tabs" class="flex justify-around p-2">
                </div>
        </div>

        <div id="content" class="p-4 sm:p-6 space-y-6">
            </div>

        <div id="toast-container"></div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden justify-center items-center">
        </div>

    <script>
        // ==========================================================
        // V8.9b æ ¸å¿ƒé‚è¼¯ - ç¨‹å¼ç¢¼ä¿®å¾©èˆ‡æ‰‹æ©Ÿå„ªåŒ–
        // ==========================================================

        const APP_VERSION = 'V8.9b';
        const STORAGE_KEY = 'tripAccountData_V8_9'; // è®Šæ›´å„²å­˜Keyä»¥é¿å…èˆŠç‰ˆæœ¬è¡çª
        let data = initializeData();
        let settlementResult = null;
        let currentTab = 'account';
        let currentEditingMemberId = null; // ç”¨æ–¼ç·¨è¼¯å¸¸ç”¨æ¸…å–®

        // é è¨­æ”¯æ´çš„å¹£åˆ¥åˆ—è¡¨ (å¯æ“´å……)
        const CURRENCIES = {
            'TWD': 'æ–°å°å¹£', 'USD': 'ç¾å…ƒ', 'EUR': 'æ­å…ƒ', 'JPY': 'æ—¥åœ“', 'KRW': 'éŸ“å…ƒ', 'CNY': 'äººæ°‘å¹£', 'HKD': 'æ¸¯å¹£', 'THB': 'æ³°éŠ–', 'VND': 'è¶Šå—ç›¾'
        };

        // --- è³‡æ–™åˆå§‹åŒ–èˆ‡å„²å­˜ ---
        function initializeData() {
            return {
                tripName: 'æˆ‘çš„æ—…è¡Œè¨˜å¸³æœ¬',
                baseCurrency: 'TWD',
                members: [{ id: 'm1', name: 'å¤§é›„', tags: ['ä½å®¿', 'äº¤é€š', 'é£Ÿç‰©'] }],
                bills: [],
                exchangeRates: { 'TWD': 1 }, // TWD æ°¸é ç‚º 1
                nextMemberId: 2,
                nextBillId: 1,
                // V8.9 æ–°å¢å¸¸ç”¨æ¨™ç±¤åŠŸèƒ½
                customTags: [
                    { key: 't1', name: 'ä½å®¿' },
                    { key: 't2', name: 'æ©Ÿç¥¨' },
                    { key: 't3', name: 'é¤é£²' },
                    { key: 't4', name: 'æ™¯é»é–€ç¥¨' }
                ],
                nextTagKey: 5
            };
        }

        function loadData() {
            try {
                if (typeof localStorage === 'undefined') {
                    showToast('âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´è³‡æ–™å„²å­˜ï¼Œé‡æ–°æ•´ç†è³‡æ–™æœƒæ¶ˆå¤±ã€‚');
                    return initializeData();
                }
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const loadedData = JSON.parse(saved);
                    // æª¢æŸ¥ä¸¦è£œé½Š V8.9 æ–°å¢çš„æ¬„ä½
                    if (!loadedData.customTags) loadedData.customTags = initializeData().customTags;
                    if (!loadedData.nextTagKey) loadedData.nextTagKey = initializeData().nextTagKey;
                    if (!loadedData.baseCurrency) loadedData.baseCurrency = 'TWD';
                    
                    data = loadedData;
                    // ç¢ºä¿ exchangeRates ä¸­åŸºæº–å¹£åˆ¥ç‚º 1
                    data.exchangeRates[data.baseCurrency] = 1;
                } else {
                    data = initializeData();
                }
                showToast(`æ•¸æ“šè¼‰å…¥æˆåŠŸ (${APP_VERSION})`);

                // å¦‚æœç•¶å‰åŸºæº–å¹£åˆ¥ä¸åœ¨ CURRENCIES è£¡ï¼Œå‰‡åŠ å…¥
                if (!CURRENCIES[data.baseCurrency]) {
                     CURRENCIES[data.baseCurrency] = data.baseCurrency;
                }

            } catch (e) {
                console.error("è¼‰å…¥æ•¸æ“šå¤±æ•—:", e);
                showToast(`âŒ æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚`);
                // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­æ•¸æ“š
                data = initializeData();
            }
        }

        function saveData() {
            try {
                if (typeof localStorage === 'undefined') {
                    console.warn('LocalStorage ä¸å¯ç”¨ã€‚');
                    return;
                }
                // ç¢ºä¿ exchangeRates ä¸­åŸºæº–å¹£åˆ¥ç‚º 1
                data.exchangeRates[data.baseCurrency] = 1;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                // showToast('æ•¸æ“šå·²å„²å­˜'); // å„²å­˜é »ç¹ï¼Œä¸é¡¯ç¤º Toast
            } catch (e) {
                console.error("å„²å­˜æ•¸æ“šå¤±æ•—:", e);
                showToast(`âŒ æ•¸æ“šå„²å­˜å¤±æ•—ï¼`);
            }
        }
        
        // --- é€šç”¨ UI å‡½æ•¸ ---
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            
            // å»¶é²é¡¯ç¤º
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // å»¶é²æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                // å»¶é²ç§»é™¤ DOM
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300); 
            }, 3000);
        }

        function renderCurrencySelect(id, selectedCurrency, className = '') {
            let html = `<select id="${id}" class="p-2 border rounded-md shadow-sm ${className}">`;
            
            // ç¢ºä¿åŸºæº–å¹£åˆ¥æ˜¯ç¬¬ä¸€å€‹é¸é …
            html += `<option value="${data.baseCurrency}" ${data.baseCurrency === selectedCurrency ? 'selected' : ''}>${data.baseCurrency}</option>`;

            // å…¶ä»–å¹£åˆ¥
            Object.keys(CURRENCIES).sort().forEach(code => {
                if (code !== data.baseCurrency) {
                    html += `<option value="${code}" ${code === selectedCurrency ? 'selected' : ''}>${code}</option>`;
                }
            });

            html += `</select>`;
            return html;
        }

        // --- æ¨™ç±¤é å°èˆª ---
        const TABS = [
            { id: 'account', name: 'è¨˜å¸³', icon: 'fa-regular fa-clipboard' },
            { id: 'members', name: 'æˆå“¡', icon: 'fa-regular fa-user' },
            { id: 'settlement', name: 'ç®—éŒ¢', icon: 'fa-solid fa-coins' },
            { id: 'settings', name: 'è¨­å®š', icon: 'fa-solid fa-gear' }
        ];

        function renderTabs() {
            const tabsDiv = document.getElementById('tabs');
            tabsDiv.innerHTML = TABS.map(tab => `
                <button 
                    id="tab-${tab.id}"
                    class="tab-button flex-1 text-center py-2 mx-1 rounded-lg border-2 border-transparent transition-colors hover:border-amber-400 text-gray-700 ${currentTab === tab.id ? 'active' : ''}"
                    onclick="switchTab('${tab.id}')"
                >
                    <i class="${tab.icon} mr-1 sm:mr-2"></i>
                    <span class="text-sm sm:text-base">${tab.name}</span>
                </button>
            `).join('');
        }

        function switchTab(tabId) {
            currentTab = tabId;
            renderTabs();
            renderContent();
            saveData(); // åˆ‡æ›é é¢æ™‚å„²å­˜ä¸€æ¬¡
        }

        function renderContent() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = '';
            
            document.title = `${data.tripName} - ${TABS.find(t => t.id === currentTab)?.name}`;

            switch (currentTab) {
                case 'account':
                    renderAccountPage(contentDiv);
                    break;
                case 'members':
                    renderMembersPage(contentDiv);
                    break;
                case 'settlement':
                    renderSettlementPage(contentDiv);
                    break;
                case 'settings':
                    renderSettingsPage(contentDiv);
                    break;
                default:
                    contentDiv.innerHTML = `<p class="text-red-500">ç„¡æ•ˆçš„é é¢</p>`;
            }
        }
        
        // --- è¨˜å¸³é é¢ (Account) ---
        function renderAccountPage(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-amber-700">${data.tripName} ç¸½è¦½</h2>
                <div class="space-y-4">
                    <div class="p-4 border border-amber-300 bg-amber-50 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-amber-800 mb-3"><i class="fa-solid fa-plus-circle mr-2"></i>æ–°å¢è¨˜å¸³</h3>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">èŠ±çš„å¹£åˆ¥ (é è¨­ï¼š${data.baseCurrency})</label>
                            ${renderCurrencySelect('currencySelect', data.baseCurrency, 'w-full')}
                        </div>

                        <div class="mb-3 flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                            <div class="flex-1">
                                <label for="spentAmount" class="block text-sm font-medium text-gray-700">èŠ±äº†å¤šå°‘éŒ¢</label>
                                <input type="number" id="spentAmount" placeholder="é‡‘é¡" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" min="0">
                            </div>
                            <div class="flex-1">
                                <label for="billName" class="block text-sm font-medium text-gray-700">ç”¨é€”/åç¨±</label>
                                <input type="text" id="billName" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>

                        <div class="mb-4 flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                            <div class="w-full sm:w-1/2">
                                <label for="payerSelect" class="block text-sm font-medium text-gray-700">èª°ä»˜çš„éŒ¢</label>
                                ${renderMemberSelect('payerSelect', data.members[0]?.id || '')}
                            </div>
                            <div class="w-full sm:w-1/2">
                                <label for="sharersInput" class="block text-sm font-medium text-gray-700">èª°è¦åˆ†æ”¤ (å¤šé¸)</label>
                                ${renderSharersSelect('sharersInput')}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¿«é€Ÿæ¨™ç±¤</label>
                            <div id="quickTags" class="flex flex-wrap gap-2">
                                </div>
                            <input type="text" id="customTagName" placeholder="è‡ªå®šç¾©æ¨™ç±¤åç¨±" class="mt-2 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        

                        <button onclick="addBill()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 rounded-lg transition-colors">
                            <i class="fa-solid fa-plus-circle mr-2"></i>ç¢ºèªæ–°å¢
                        </button>
                    </div>

                    <div class="pt-4 border-t border-gray-300">
                        <h3 class="text-xl font-semibold text-amber-800 mb-3"><i class="fa-solid fa-receipt mr-2"></i>æ‰€æœ‰èŠ±è²» (${data.baseCurrency})</h3>
                        <div id="billList" class="space-y-3">
                            </div>
                    </div>
                </div>
            `;
            
            // è¨­ç½®åˆ†æ”¤è€…é è¨­ç‚ºæ‰€æœ‰æˆå“¡
            document.getElementById('sharersInput').value = data.members.map(m => m.id);

            renderBillList();
            renderQuickTags();
        }

        function renderMemberSelect(id, selectedId) {
            let html = `<select id="${id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">`;
            data.members.forEach(member => {
                html += `<option value="${member.id}" ${member.id === selectedId ? 'selected' : ''}>${member.name}</option>`;
            });
            html += `</select>`;
            return html;
        }
        
        function renderSharersSelect(id) {
            let html = `<select multiple id="${id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm h-28 custom-scroll">`;
            data.members.forEach(member => {
                // é è¨­å…¨éƒ¨é¸ä¸­
                html += `<option value="${member.id}" selected>${member.name}</option>`; 
            });
            html += `</select>`;
            return html;
        }

        function renderQuickTags() {
            const container = document.getElementById('quickTags');
            if (!container) return;
            container.innerHTML = '';

            // å¸¸ç”¨æ¨™ç±¤
            data.customTags.forEach(tag => {
                container.innerHTML += `
                    <button onclick="document.getElementById('customTagName').value='${tag.name}'" class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full hover:bg-blue-200 transition-colors">
                        ${tag.name}
                    </button>
                `;
            });
            // ç¸½æ˜¯åœ¨æœ«å°¾åŠ ä¸Šä¸€å€‹ã€Œè‡ªå®šç¾©ã€æŒ‰éˆ•
            container.innerHTML += `
                <button onclick="document.getElementById('customTagName').value=''" class="bg-gray-100 text-gray-800 text-sm font-medium px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">
                    <i class="fa-solid fa-pencil mr-1"></i>è‡ªå®šç¾©
                </button>
            `;
        }

        function getExchangeRate(currency) {
            // ç¢ºä¿åŸºæº–å¹£åˆ¥åŒ¯ç‡æ˜¯ 1
            if (currency === data.baseCurrency) return 1;
            
            // å˜—è©¦å–å¾—å„²å­˜çš„åŒ¯ç‡
            let rate = data.exchangeRates[currency];

            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œæç¤ºä¸¦é è¨­ç‚º 1 (å‡è¨­ 1:1)
            if (!rate || rate <= 0) {
                // ç‚ºäº†é¿å…é‡è¤‡çš„æç¤ºï¼Œåªåœ¨è¨ˆç®—æ™‚æç¤º
                console.warn(`[åŒ¯ç‡] æ‰¾ä¸åˆ° ${currency} çš„åŒ¯ç‡ï¼Œæš«æ™‚ä½¿ç”¨ 1:${data.baseCurrency} è¨ˆç®—ã€‚è«‹åœ¨ã€Œè¨­å®šã€é é¢è¨­å®šåŒ¯ç‡ã€‚`);
                return 1;
            }
            return rate;
        }

        function convertToBase(amount, currency) {
            const rate = getExchangeRate(currency);
            return parseFloat((amount * rate).toFixed(2));
        }

        function addBill() {
            const amount = parseFloat(document.getElementById('spentAmount').value);
            const currency = document.getElementById('currencySelect').value;
            const name = document.getElementById('billName').value.trim();
            const payerId = document.getElementById('payerSelect').value;
            const sharersInput = document.getElementById('sharersInput');
            const sharerIds = Array.from(sharersInput.selectedOptions).map(option => option.value);
            const tag = document.getElementById('customTagName').value.trim();

            if (!amount || amount <= 0 || !name || sharerIds.length === 0) {
                return showToast('âŒ è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ã€ç”¨é€”ä¸¦é¸æ“‡åˆ†æ”¤è€…ï¼');
            }

            // å°‡é‡‘é¡è½‰æ›ç‚ºåŸºæº–å¹£åˆ¥
            const baseAmount = convertToBase(amount, currency);

            const newBill = {
                id: `b${data.nextBillId++}`,
                name: name,
                amount: amount,
                currency: currency,
                baseAmount: baseAmount,
                payerId: payerId,
                sharerIds: sharerIds,
                tag: tag,
                timestamp: new Date().toISOString()
            };

            data.bills.unshift(newBill); // æ–°å¢åˆ°åˆ—è¡¨æœ€å‰æ–¹
            saveData();
            
            // æ¸…ç©ºè¼¸å…¥æ¬„
            document.getElementById('spentAmount').value = '';
            document.getElementById('billName').value = '';
            document.getElementById('customTagName').value = '';
            // é‡è¨­å¹£åˆ¥ç‚ºåŸºæº–å¹£åˆ¥ (å„ªåŒ–éœ€æ±‚ 2)
            document.getElementById('currencySelect').value = data.baseCurrency; 
            // é‡è¨­åˆ†æ”¤è€…ç‚ºå…¨éƒ¨
            Array.from(sharersInput.options).forEach(option => option.selected = true);


            renderBillList();
            showToast('âœ… è¨˜å¸³æ–°å¢æˆåŠŸï¼');
        }

        function renderBillList() {
            const container = document.getElementById('billList');
            if (!container) return;

            if (data.bills.length === 0) {
                container.innerHTML = `<p class="text-gray-500 p-4 border rounded-lg text-center">ç›®å‰é‚„æ²’æœ‰èŠ±è²»ç´€éŒ„å–”ï¼</p>`;
                return;
            }

            container.innerHTML = data.bills.map(bill => {
                const payerName = data.members.find(m => m.id === bill.payerId)?.name || 'æœªçŸ¥';
                const sharerNames = bill.sharerIds.map(id => data.members.find(m => m.id === id)?.name || '?').join(', ');
                const shareCount = bill.sharerIds.length;
                const shareAmount = shareCount > 0 ? (bill.baseAmount / shareCount).toFixed(2) : 0;
                const shareUnit = data.baseCurrency;

                return `
                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-lg font-bold text-gray-800">${bill.name}</h4>
                            <div class="flex space-x-2">
                                <button onclick="editBill('${bill.id}')" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="confirmDeleteBill('${bill.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mb-1">
                            <i class="fa-solid fa-tag mr-1"></i> æ¨™ç±¤: ${bill.tag || 'ç„¡æ¨™ç±¤'}
                        </p>
                        
                        <div class="mb-2 p-2 bg-indigo-50 border-l-4 border-indigo-400 rounded-md">
                            <p class="text-sm font-medium text-indigo-700">
                                <i class="fa-solid fa-money-bill-wave mr-1"></i> **${bill.amount} ${bill.currency}**
                                ${bill.currency !== data.baseCurrency ? `(ç´„ ${bill.baseAmount} ${data.baseCurrency})` : ''}
                            </p>
                            <p class="text-xs text-indigo-600">
                                åŸºæº–å¹£åˆ¥æ›ç®—ï¼š${bill.baseAmount} ${shareUnit}
                            </p>
                        </div>

                        <p class="text-sm text-gray-700 mb-1">
                            <i class="fa-solid fa-person-circle-check mr-1"></i> **ä»˜æ¬¾äºº**: ${payerName}
                        </p>
                        <p class="text-sm text-gray-700 mb-1">
                            <i class="fa-solid fa-user-group mr-1"></i> **åˆ†æ”¤è€…**: ${sharerNames}
                        </p>
                        <p class="text-sm text-amber-700 font-medium">
                            <i class="fa-solid fa-divide mr-1"></i> **æ¯äººæ‡‰åˆ†æ”¤**: ${shareAmount} ${shareUnit}
                        </p>
                    </div>
                `;
            }).join('');
        }

        function confirmDeleteBill(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ')) {
                data.bills = data.bills.filter(b => b.id !== id);
                saveData();
                renderBillList();
                showToast('ğŸ—‘ï¸ è¨˜å¸³å·²åˆªé™¤ï¼');
            }
        }

        // --- æˆå“¡é é¢ (Members) ---
        function renderMembersPage(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-amber-700"><i class="fa-solid fa-user-group mr-2"></i>æˆå“¡èˆ‡å¸¸ç”¨æ¸…å–®</h2>
                
                <div class="p-4 border border-blue-300 bg-blue-50 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">æ–°å¢æˆå“¡</h3>
                    <input type="text" id="newMemberName" placeholder="æˆå“¡å§“å" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm mb-3">
                    <button onclick="addMember()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition-colors">
                        <i class="fa-solid fa-user-plus mr-2"></i>ç¢ºèªæ–°å¢
                    </button>
                </div>

                <div class="pt-4 border-t border-gray-300">
                    <h3 class="text-xl font-semibold text-amber-800 mb-3">ç•¶å‰æˆå“¡åˆ—è¡¨</h3>
                    <div id="memberList" class="space-y-3">
                        ${renderMembers()}
                    </div>
                </div>
            `;
        }

        function renderMembers() {
            const container = document.getElementById('memberList');
            if (!container && currentTab !== 'members') return; // é¿å…åœ¨å…¶ä»–é é¢è§¸ç™¼éŒ¯èª¤
            
            const html = data.members.map(member => {
                const totalPaid = data.bills.filter(b => b.payerId === member.id).reduce((sum, b) => sum + b.baseAmount, 0).toFixed(2);
                
                return `
                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <div class="flex-1 min-w-0 mr-4">
                            <p class="text-lg font-bold text-gray-800 truncate">${member.name}</p>
                            <p class="text-sm text-gray-500">å·²ä»˜ç¸½é¡: ${totalPaid} ${data.baseCurrency}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="openCustomTagModal('${member.id}')" class="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full hover:bg-indigo-200 transition-colors hidden sm:block">å¸¸ç”¨æ¸…å–®</button>
                            <button onclick="openCustomTagModal('${member.id}')" class="text-indigo-600 hover:text-indigo-800 sm:hidden"><i class="fa-solid fa-list-check"></i></button>
                            <button onclick="confirmDeleteMember('${member.id}')" class="text-red-500 hover:text-red-700" title="åˆªé™¤æˆå“¡"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (container) container.innerHTML = html;
            return html;
        }

        function addMember() {
            const name = document.getElementById('newMemberName').value.trim();
            if (!name) {
                return showToast('âŒ è«‹è¼¸å…¥æˆå“¡å§“åï¼');
            }
            if (data.members.some(m => m.name === name)) {
                return showToast('âŒ è©²æˆå“¡å§“åå·²å­˜åœ¨ï¼');
            }

            const newMember = {
                id: `m${data.nextMemberId++}`,
                name: name,
                // V8.9 æ¯å€‹æˆå“¡éƒ½ä½¿ç”¨å…¨åŸŸçš„ customTags
                tags: [] 
            };

            data.members.push(newMember);
            saveData();
            document.getElementById('newMemberName').value = '';
            renderMembers();
            // åœ¨è¨˜å¸³é é¢ä¹Ÿè¦æ›´æ–°ä¸‹æ‹‰é¸å–®
            if (document.getElementById('payerSelect')) switchTab('account'); 
            showToast(`âœ… æˆå“¡ ${name} å·²æ–°å¢ï¼`);
        }
        
        function confirmDeleteMember(id) {
            const memberName = data.members.find(m => m.id === id)?.name || 'æœªçŸ¥æˆå“¡';
            const billsInvolved = data.bills.filter(b => b.payerId === id || b.sharerIds.includes(id)).length;

            if (billsInvolved > 0) {
                if (!confirm(`æˆå“¡ ${memberName} æ¶‰åŠ ${billsInvolved} ç­†è¨˜å¸³ã€‚åˆªé™¤æˆå“¡å°‡å°è‡´ç›¸é—œè¨˜å¸³çš„ä»˜æ¬¾äººå’Œåˆ†æ”¤è€…æ¬„ä½è®Šæˆã€ŒæœªçŸ¥ã€ã€‚\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ`)) {
                    return;
                }
            } else {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤æˆå“¡ ${memberName} å—ï¼Ÿ`)) {
                    return;
                }
            }

            data.members = data.members.filter(m => m.id !== id);
            // ä¸ä¿®æ”¹ billsï¼Œç›´æ¥è®“ payerId å’Œ sharerIds è®Šæˆç„¡æ•ˆID
            saveData();
            renderMembers();
            // å¦‚æœåœ¨è¨˜å¸³é é¢ï¼Œéœ€è¦åˆ·æ–°
            if (currentTab === 'account') switchTab('account'); 
            showToast(`ğŸ—‘ï¸ æˆå“¡ ${memberName} å·²åˆªé™¤ï¼`);
        }
        
        // --- å¸¸ç”¨æ¸…å–® Modal ---
        function openCustomTagModal(memberId) {
            currentEditingMemberId = memberId;
            const member = data.members.find(m => m.id === memberId);
            if (!member) return showToast('âŒ æ‰¾ä¸åˆ°è©²æˆå“¡ï¼');

            const modalContent = `
                <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center border-b pb-3 mb-4 sticky top-0 bg-white z-10">
                        <h3 class="text-xl font-bold text-amber-700">${member.name} çš„å¸¸ç”¨æ¸…å–®</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                    
                    <div id="tagListContainer" class="space-y-4">
                        </div>

                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">æ–°å¢å¸¸ç”¨æ¨™ç±¤</h4>
                        <div class="flex space-x-2">
                            <input type="text" id="newTagName" placeholder="æ¨™ç±¤åç¨±ï¼Œä¾‹å¦‚ï¼šåˆé¤" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm">
                            <button onclick="addCustomTag()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                <i class="fa-solid fa-plus"></i> åŠ å…¥
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-backdrop').innerHTML = modalContent;
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('modal-backdrop').classList.add('flex');
            
            // é¦–æ¬¡æ¸²æŸ“åˆ—è¡¨
            renderTagList(member);
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.remove('flex');
            currentEditingMemberId = null;
            // åˆ·æ–°è¨˜å¸³é é¢çš„ Quick Tags
            if (currentTab === 'account') renderQuickTags();
        }

        function renderTagList(member) {
            const container = document.getElementById('tagListContainer');
            if (!container) return;
            
            // é¡¯ç¤ºæ‰€æœ‰å…¨åŸŸè‡ªå®šç¾©æ¨™ç±¤
            const tagHtml = data.customTags.map(tag => `
                <div class="flex items-center justify-between p-3 border border-gray-100 rounded-lg bg-white shadow-sm">
                    <span class="text-gray-800 text-base font-medium flex-1 mr-4">${tag.name}</span>
                    <div class="flex space-x-2">
                        <button onclick="renameCustomTag('${tag.key}')" class="text-blue-500 hover:text-blue-700" title="ä¿®æ”¹åç¨±"><i class="fa-solid fa-pencil"></i></button>
                        <button onclick="confirmDeleteCustomTag('${tag.key}')" class="text-red-500 hover:text-red-700" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <p class="text-sm text-gray-500 mb-3">ä»¥ä¸‹åˆ—è¡¨æ˜¯æ‰€æœ‰æˆå“¡é€šç”¨çš„å¸¸ç”¨æ¨™ç±¤æ¸…å–®ã€‚</p>
                <div class="space-y-2 max-h-60 custom-scroll pr-2">
                    ${tagHtml.length > 0 ? tagHtml : '<p class="text-gray-500">ç›®å‰æ²’æœ‰å¸¸ç”¨æ¨™ç±¤ã€‚</p>'}
                </div>
            `;
            // V8.9b å„ªåŒ–: æ–°å¢è¼¸å…¥æ¡†/æŒ‰éˆ•ç§»åˆ° Modal å°¾éƒ¨ï¼Œåœ¨ openCustomTagModal å‡½æ•¸ä¸­è™•ç†
        }

        function addCustomTag() {
            const newTagName = document.getElementById('newTagName').value.trim();
            if (!newTagName) {
                return showToast('âŒ è«‹è¼¸å…¥æ¨™ç±¤åç¨±ï¼');
            }
            if (data.customTags.some(t => t.name === newTagName)) {
                return showToast('âŒ è©²æ¨™ç±¤åç¨±å·²å­˜åœ¨ï¼');
            }
            
            const newTag = { key: 't' + data.nextTagKey++, name: newTagName };
            data.customTags.push(newTag);
            saveData();
            document.getElementById('newTagName').value = '';
            
            // åˆ·æ–°åˆ—è¡¨
            const member = data.members.find(m => m.id === currentEditingMemberId);
            if(member) renderTagList(member);
            showToast('âœ… å¸¸ç”¨æ¨™ç±¤å·²æ–°å¢ï¼');
        }

        function confirmDeleteCustomTag(key) {
            const tagName = data.customTags.find(t => t.key === key)?.name || 'æœªçŸ¥æ¨™ç±¤';
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å¸¸ç”¨æ¨™ç±¤ã€Œ${tagName}ã€å—ï¼Ÿ\n\nåˆªé™¤å¾Œï¼Œæ‰€æœ‰è¨˜å¸³ä¸­å¸¶æœ‰æ­¤æ¨™ç±¤çš„ç´€éŒ„å°‡ä¸å—å½±éŸ¿ï¼Œä½†æ‚¨å°‡ç„¡æ³•å†æ¬¡å¾å¸¸ç”¨æ¸…å–®ä¸­å¿«é€Ÿé¸æ“‡ã€‚`)) {
                return;
            }
            
            data.customTags = data.customTags.filter(t => t.key !== key);
            saveData();
            
            // åˆ·æ–°åˆ—è¡¨
            const member = data.members.find(m => m.id === currentEditingMemberId);
            if(member) renderTagList(member);
            showToast('ğŸ—‘ï¸ å¸¸ç”¨æ¨™ç±¤å·²åˆªé™¤ï¼');
        }
        
        function renameCustomTag(k) { 
            const t = data.customTags.find(x=>x.key===k); 
            if(!t) return showToast('âŒ æ‰¾ä¸åˆ°è©²æ¨™ç±¤ï¼');
            
            const n = prompt(`å°‡æ¨™ç±¤ã€Œ${t.name}ã€æ”¹åç‚ºï¼š`, t.name); 
            
            if(n&&n.trim()) { 
                const newName = n.trim();
                if (data.customTags.some(tag => tag.name === newName)) {
                    return showToast('âŒ è©²æ¨™ç±¤åç¨±å·²å­˜åœ¨ï¼');
                }
                
                t.name=newName; 
                saveData(); 
                
                // åˆ·æ–°åˆ—è¡¨
                const member = data.members.find(m => m.id === currentEditingMemberId);
                if(member) renderTagList(member);
                showToast('âœ… æ¨™ç±¤å·²æ›´åï¼');
            } 
        }

        // --- ç®—éŒ¢é é¢ (Settlement) ---
        function renderSettlementPage(container) {
            const memberBalances = calculateBalances();
            settlementResult = calculateSettlement(memberBalances);

            const totalSpent = data.bills.reduce((sum, b) => sum + b.baseAmount, 0).toFixed(2);
            
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-amber-700"><i class="fa-solid fa-calculator mr-2"></i>çµç®—èˆ‡è½‰å¸³è¨ˆç•«</h2>
                <div class="mb-6 p-4 border border-green-300 bg-green-50 rounded-lg shadow-md">
                    <p class="text-lg font-semibold text-green-800">ç¸½èŠ±è²» (åŸºæº–å¹£åˆ¥): ${totalSpent} ${data.baseCurrency}</p>
                    <p class="text-sm text-green-700">æˆå“¡æ•¸: ${data.members.length} äºº</p>
                    <p class="text-sm text-green-700">å¹³å‡åˆ†æ”¤é‡‘é¡: ${(totalSpent / (data.members.length || 1)).toFixed(2)} ${data.baseCurrency}</p>
                </div>

                <div class="pt-4 border-t border-gray-300 mb-6">
                    <h3 class="text-xl font-semibold text-amber-800 mb-3">æˆå“¡çµé¤˜ç‹€æ³ (${data.baseCurrency})</h3>
                    <div id="balanceList" class="space-y-3">
                        ${renderBalanceList(memberBalances)}
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-300">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-amber-800">æœ€çµ‚è½‰å¸³è¨ˆç•«</h3>
                        <button onclick="copyReport()" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg transition-colors">
                            <i class="fa-solid fa-copy mr-1"></i>è¤‡è£½å ±å‘Š
                        </button>
                    </div>
                    <div id="settlementPlan" class="space-y-3">
                        ${renderSettlementPlan(settlementResult)}
                    </div>
                </div>
            `;
        }
        
        // 1. è¨ˆç®—æ¯å€‹æˆå“¡çš„çµé¤˜
        function calculateBalances() {
            const balances = {};
            data.members.forEach(m => {
                balances[m.id] = {
                    paid: 0,
                    shouldPay: 0,
                    net: 0, // æ·¨çµé¤˜ (paid - shouldPay)
                    name: m.name
                };
            });

            data.bills.forEach(bill => {
                // å·²ä»˜æ¬¾é …
                if (balances[bill.payerId]) {
                    balances[bill.payerId].paid += bill.baseAmount;
                }

                // æ‡‰åˆ†æ”¤é‡‘é¡
                const shareCount = bill.sharerIds.length;
                if (shareCount > 0) {
                    const shareAmount = bill.baseAmount / shareCount;
                    bill.sharerIds.forEach(sharerId => {
                        if (balances[sharerId]) {
                            balances[sharerId].shouldPay += shareAmount;
                        }
                    });
                }
            });

            // è¨ˆç®—æ·¨çµé¤˜
            Object.values(balances).forEach(b => {
                b.net = parseFloat((b.paid - b.shouldPay).toFixed(2));
                b.paid = parseFloat(b.paid.toFixed(2));
                b.shouldPay = parseFloat(b.shouldPay.toFixed(2));
            });

            return balances;
        }
        
        function renderBalanceList(balances) {
            const balanceArray = Object.values(balances);

            if (balanceArray.length === 0) {
                return `<p class="text-gray-500 p-4 border rounded-lg text-center">æ²’æœ‰æˆå“¡æ•¸æ“šã€‚</p>`;
            }

            return balanceArray.map(b => {
                const isPositive = b.net > 0;
                const netAmount = Math.abs(b.net).toFixed(2);
                const colorClass = isPositive ? 'text-green-700 bg-green-50 border-green-400' : 
                                   (b.net < 0 ? 'text-red-700 bg-red-50 border-red-400' : 'text-gray-700 bg-gray-50 border-gray-400');
                const actionText = isPositive ? 'æ‡‰æ”¶å›' : (b.net < 0 ? 'æ‡‰æ”¯ä»˜' : 'å·²çµæ¸…');
                const icon = isPositive ? 'fa-arrow-up' : (b.net < 0 ? 'fa-arrow-down' : 'fa-check-circle');

                return `
                    <div class="p-4 rounded-lg shadow-sm border-l-4 ${colorClass}">
                        <p class="text-lg font-bold">${b.name}</p>
                        <p class="text-sm">ç¸½å…±æ”¯ä»˜: ${b.paid} ${data.baseCurrency}</p>
                        <p class="text-sm">æ‡‰åˆ†æ”¤: ${b.shouldPay} ${data.baseCurrency}</p>
                        <p class="text-base font-semibold mt-1">
                            <i class="fa-solid ${icon} mr-1"></i> æ·¨çµé¤˜: ${b.net} ${data.baseCurrency}
                            <span class="ml-2 font-bold">(${actionText}: ${netAmount} ${data.baseCurrency})</span>
                        </p>
                    </div>
                `;
            }).join('');
        }

        // 2. è¨ˆç®—è½‰å¸³è¨ˆç•« (è²ªå©ªæ¼”ç®—æ³•ï¼Œæ‰¾åˆ°æœ€å°‘äº¤æ˜“æ¬¡æ•¸çš„è§£)
        function calculateSettlement(balances) {
            let debtors = []; // è² å‚µè€… (net < 0)
            let creditors = []; // å‚µæ¬Šäºº (net > 0)
            const plan = [];

            Object.values(balances).forEach(b => {
                if (b.net < 0) {
                    debtors.push({ id: data.members.find(m => m.name === b.name)?.id, amount: -b.net, name: b.name });
                } else if (b.net > 0) {
                    creditors.push({ id: data.members.find(m => m.name === b.name)?.id, amount: b.net, name: b.name });
                }
            });

            // æ’åºï¼šè² å‚µè€…ç”±å°‘åˆ°å¤šï¼Œå‚µæ¬Šäººç”±å¤šåˆ°å°‘ï¼Œä»¥ä¾¿ç›¡å¿«çµæ¸…å°é¡
            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let i = 0; // å‚µæ¬Šäºº (creditors) ç´¢å¼•
            let j = 0; // è² å‚µè€… (debtors) ç´¢å¼•

            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];

                // æ‰¾å‡ºæœ€å°çš„äº¤æ˜“é‡‘é¡
                const transactionAmount = Math.min(creditor.amount, debtor.amount);

                if (transactionAmount > 0.01) { // å¿½ç•¥æ¥µå°çš„èª¤å·®
                    plan.push({
                        from: debtor.id,
                        to: creditor.id,
                        amount: parseFloat(transactionAmount.toFixed(2))
                    });

                    // æ›´æ–°å‰©é¤˜é‡‘é¡
                    creditor.amount -= transactionAmount;
                    debtor.amount -= transactionAmount;
                }

                // ç§»å‹•æŒ‡é‡
                if (creditor.amount <= 0.01) {
                    i++; // å‚µæ¬Šäººå·²æ”¶å›æ‰€æœ‰æ¬ æ¬¾
                }
                if (debtor.amount <= 0.01) {
                    j++; // è² å‚µäººå·²å„Ÿé‚„æ‰€æœ‰å‚µå‹™
                }
            }

            return { plan: plan, totalSpent: balances.totalSpent };
        }
        
        function renderSettlementPlan(settlement) {
            const container = document.getElementById('settlementPlan');
            if (!container) return;

            if (settlement.plan.length === 0) {
                return `<p class="text-green-600 font-semibold p-4 border border-green-300 rounded-lg text-center"><i class="fa-solid fa-check-circle mr-1"></i> å¸³ç›®å…¨éƒ¨çµæ¸…å›‰ï¼ä¸éœ€è¦ä»»ä½•è½‰å¸³ã€‚</p>`;
            }

            return settlement.plan.map((p, index) => {
                const fromName = data.members.find(m => m.id === p.from)?.name || 'æœªçŸ¥';
                const toName = data.members.find(m => m.id === p.to)?.name || 'æœªçŸ¥';
                
                return `
                    <div class="flex items-center p-3 bg-white border border-yellow-300 rounded-lg shadow-sm">
                        <span class="mr-3 text-lg font-bold text-yellow-700">${index + 1}.</span>
                        <p class="flex-1 text-base">
                            **${fromName}** è½‰å¸³çµ¦ **${toName}** <br class="sm:hidden">
                            <span class="font-bold text-xl text-red-600 ml-0 sm:ml-4">${p.amount.toFixed(2)} ${data.baseCurrency}</span>
                        </p>
                    </div>
                `;
            }).join('');
        }

        function copyReport() {
            if(!settlementResult) return showToast('å…ˆå»ã€Œç®—éŒ¢ã€é é¢å–”');
            
            let text = `ğŸ“… æ—…è¡Œçµç®—å ±å‘Š - ${data.tripName}\n`;
            text += `------------------------------------\n`;
            text += `ç¸½èŠ±è²» (åŸºæº–å¹£åˆ¥): ${data.bills.reduce((sum, b) => sum + b.baseAmount, 0).toFixed(2)} ${data.baseCurrency}\n\n`;

            if (settlementResult.plan.length === 0) {
                text += `ğŸ‰ å¸³ç›®å…¨éƒ¨çµæ¸…å›‰ï¼`;
            } else { 
                text += `ğŸ’¸ è«‹å¤§å®¶é€™æ¨£è½‰å¸³ï¼š\n\n`; 
                settlementResult.plan.forEach(p => { 
                    const f = data.members.find(m=>m.id===p.from)?.name; 
                    const t = data.members.find(m=>m.id===p.to)?.name; 
                    text += `ğŸ‘‰ ${f} çµ¦ ${t}ï¼š$${p.amount.toFixed(2)} ${data.baseCurrency}\n`; 
                }); 
            }
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            const ta = document.createElement('textarea'); 
            ta.value = text; 
            document.body.appendChild(ta); 
            ta.select(); 
            try { 
                document.execCommand('copy'); 
                showToast('âœ… çµç®—å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'); 
            } catch(e) { 
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹æ–‡å­—ï¼š\n\n' + text); 
            } 
            document.body.removeChild(ta);
        }

        // --- è¨­å®šé é¢ (Settings) ---
        function renderSettingsPage(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-amber-700"><i class="fa-solid fa-sliders mr-2"></i>æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>
                
                <div class="space-y-6">
                    <div class="p-4 border border-purple-300 bg-purple-50 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-purple-800 mb-3"><i class="fa-solid fa-list-check mr-2"></i>åŸºç¤è¨­å®š</h3>
                        
                        <div class="mb-4">
                            <label for="tripNameInput" class="block text-sm font-medium text-gray-700">æ—…è¡Œåç¨±</label>
                            <input type="text" id="tripNameInput" value="${data.tripName}" placeholder="ä¾‹å¦‚ï¼š2024 æ—¥æœ¬æ±äº¬ä¹‹æ—…" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <button onclick="updateTripName()" class="mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-4 rounded-md text-sm transition-colors">å„²å­˜åç¨±</button>
                        </div>
                        
                        <div class="mb-4">
                            <label for="baseCurrencySelect" class="block text-sm font-medium text-gray-700">åŸºæº–å¹£åˆ¥ (æ‰€æœ‰è¨ˆç®—éƒ½å°‡ä»¥æ­¤å¹£åˆ¥ç‚ºæº–)</label>
                            ${renderCurrencySelect('baseCurrencySelect', data.baseCurrency, 'mt-1 w-full')}
                            <button onclick="updateBaseCurrency()" class="mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-4 rounded-md text-sm transition-colors">è¨­å®šåŸºæº–å¹£åˆ¥</button>
                            <p class="text-xs text-red-500 mt-1">è®Šæ›´åŸºæº–å¹£åˆ¥æœƒå½±éŸ¿æ‰€æœ‰æ­·å²ç´€éŒ„çš„æ›ç®—çµæœï¼</p>
                        </div>
                    </div>
                    
                    <div class="p-4 border border-indigo-300 bg-indigo-50 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-indigo-800 mb-3"><i class="fa-solid fa-arrow-right-arrow-left mr-2"></i>åŒ¯ç‡è¨­å®š (å…Œ ${data.baseCurrency})</h3>
                        <div id="exchangeRateList" class="space-y-2 mb-4">
                            ${renderExchangeRates()}
                        </div>
                        
                        <div class="flex space-x-2">
                            <select id="newCurrencyCode" class="flex-1 p-2 border rounded-md shadow-sm">
                                ${Object.keys(CURRENCIES).sort().filter(code => code !== data.baseCurrency && !data.exchangeRates[code]).map(code => 
                                    `<option value="${code}">${code}</option>`
                                ).join('')}
                            </select>
                            <button onclick="addExchangeRate()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">æ–°å¢</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">æç¤ºï¼šåŒ¯ç‡è¨­å®šç‚º 1 ${data.baseCurrency} = [è¼¸å…¥å€¼] å¤–éƒ¨å¹£åˆ¥ã€‚</p>
                    </div>

                    <div class="p-4 border border-red-300 bg-red-50 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-red-800 mb-3"><i class="fa-solid fa-database mr-2"></i>è³‡æ–™ç®¡ç†</h3>
                        
                        <div class="flex space-x-2 mb-3">
                            <button onclick="exportData()" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-md transition-colors">
                                <i class="fa-solid fa-file-export mr-1"></i>å‚™ä»½è³‡æ–™ (.json)
                            </button>
                            <button onclick="document.getElementById('importFileInput').click()" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-md transition-colors">
                                <i class="fa-solid fa-file-import mr-1"></i>é‚„åŸè³‡æ–™
                            </button>
                        </div>
                        <input type="file" id="importFileInput" class="hidden" accept=".json" onchange="importData(event)">
                        
                        <button onclick="confirmResetAll()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition-colors mt-3">
                            <i class="fa-solid fa-bomb mr-1"></i>æ¸…é™¤æ‰€æœ‰æ•¸æ“š (é‡æ–°é–‹å§‹)
                        </button>
                    </div>

                    <p class="text-center text-sm text-gray-500 mt-4">
                        æ—…è¡Œè¨˜å¸³æœ¬ ${APP_VERSION} | æœ€å¾Œå„²å­˜: ${new Date().toLocaleString()}
                    </p>
                </div>
            `;
            // ç¢ºä¿è¨­å®šé é¢è¼‰å…¥æ™‚ï¼ŒåŸºæº–å¹£åˆ¥ä¸‹æ‹‰é¸å–®æ˜¯æ­£ç¢ºé¸ä¸­çš„
            document.getElementById('baseCurrencySelect').value = data.baseCurrency;
        }

        function updateTripName() {
            const newName = document.getElementById('tripNameInput').value.trim();
            if (!newName) {
                return showToast('âŒ æ—…è¡Œåç¨±ä¸èƒ½ç‚ºç©ºï¼');
            }
            data.tripName = newName;
            saveData();
            // é‡æ–°æ¸²æŸ“ Tabs ä»¥æ›´æ–°æ¨™é¡Œ
            renderTabs(); 
            // é‡æ–°æ¸²æŸ“è¨­å®šé é¢ä»¥æ›´æ–°åº•éƒ¨çš„ç‰ˆæœ¬è³‡è¨Š
            renderSettingsPage(document.getElementById('content'));
            showToast('âœ… æ—…è¡Œåç¨±å·²æ›´æ–°ï¼');
        }

        function updateBaseCurrency() {
            const newBaseCurrency = document.getElementById('baseCurrencySelect').value;
            
            if (newBaseCurrency === data.baseCurrency) {
                return showToast('âœ¨ åŸºæº–å¹£åˆ¥æ²’æœ‰è®Šæ›´ã€‚');
            }
            
            if (!confirm(`ç¢ºå®šè¦å°‡åŸºæº–å¹£åˆ¥å¾ ${data.baseCurrency} è®Šæ›´ç‚º ${newBaseCurrency} å—ï¼Ÿ\n\né€™å°‡æœƒå½±éŸ¿æ‰€æœ‰æ­·å²èŠ±è²»çš„æ›ç®—çµæœï¼`)) {
                // å–æ¶ˆè®Šæ›´ï¼Œå°‡ä¸‹æ‹‰é¸å–®çš„å€¼æ”¹å›åŸä¾†çš„
                document.getElementById('baseCurrencySelect').value = data.baseCurrency; 
                return;
            }

            const oldBaseCurrency = data.baseCurrency;
            
            // 1. æ›´æ–°è³‡æ–™ä¸­çš„åŸºæº–å¹£åˆ¥
            data.baseCurrency = newBaseCurrency;

            // 2. æ›´æ–°åŒ¯ç‡è¡¨ï¼š
            // èˆŠåŸºæº–å¹£åˆ¥çš„åŒ¯ç‡è®Šæˆæ–°çš„å°æ‡‰å€¼ (1 / èˆŠåŸºæº–å¹£åˆ¥çš„èˆŠåŒ¯ç‡ï¼Œç›¸å°æ–¼æ–°åŸºæº–å¹£åˆ¥)
            const oldRateInNewBase = data.exchangeRates[oldBaseCurrency] || 1;
            
            // å°‡æ‰€æœ‰ç¾æœ‰åŒ¯ç‡é‡æ–°ä»¥æ–°åŸºæº–å¹£åˆ¥è¨ˆç®—
            const newRates = {};
            // æ–°åŸºæº–å¹£åˆ¥å°è‡ªå·±çš„åŒ¯ç‡æ°¸é æ˜¯ 1
            newRates[newBaseCurrency] = 1;

            // é‡æ–°è¨ˆç®—æ‰€æœ‰èˆŠå¹£åˆ¥ç›¸å°æ–¼æ–°åŸºæº–å¹£åˆ¥çš„åŒ¯ç‡
            Object.keys(data.exchangeRates).forEach(code => {
                if (code !== newBaseCurrency) {
                    // (èˆŠå¹£åˆ¥å…ŒèˆŠåŸºæº–å¹£åˆ¥çš„åŒ¯ç‡) / (æ–°åŸºæº–å¹£åˆ¥å…ŒèˆŠåŸºæº–å¹£åˆ¥çš„åŒ¯ç‡)
                    newRates[code] = parseFloat((data.exchangeRates[code] / oldRateInNewBase).toFixed(4));
                }
            });
            data.exchangeRates = newRates;
            
            // 3. é‡æ–°è¨ˆç®—æ‰€æœ‰è¨˜å¸³çš„ baseAmount
            data.bills.forEach(bill => {
                bill.baseAmount = convertToBase(bill.amount, bill.currency);
            });

            saveData();
            // åˆ·æ–°é é¢ï¼Œç¢ºä¿æ‰€æœ‰åœ°æ–¹éƒ½ä½¿ç”¨æ–°çš„åŸºæº–å¹£åˆ¥
            switchTab('settings');
            showToast(`âœ… åŸºæº–å¹£åˆ¥å·²æˆåŠŸè®Šæ›´ç‚º ${newBaseCurrency}ï¼`);
        }


        function renderExchangeRates() {
            const base = data.baseCurrency;
            const ratesHtml = Object.keys(data.exchangeRates).sort().map(code => {
                if (code === base) return ''; // åŸºæº–å¹£åˆ¥ä¸é¡¯ç¤º

                return `
                    <div class="flex space-x-2 items-center">
                        <span class="w-1/4 text-gray-700 font-medium">${code} (1 ${base} = )</span>
                        <input type="number" step="0.0001" id="rate-${code}" value="${data.exchangeRates[code]}" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm">
                        <button onclick="updateExchangeRate('${code}')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm">æ›´æ–°</button>
                        <button onclick="removeExchangeRate('${code}')" class="text-red-500 hover:text-red-700" title="ç§»é™¤"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            }).join('');
            
            return ratesHtml || '<p class="text-gray-500">ç›®å‰æ²’æœ‰å…¶ä»–å¹£åˆ¥åŒ¯ç‡ã€‚</p>';
        }

        function addExchangeRate() {
            const code = document.getElementById('newCurrencyCode').value;
            if (code && !data.exchangeRates[code]) {
                data.exchangeRates[code] = 1; // é è¨­ç‚º 1:1
                saveData();
                renderSettingsPage(document.getElementById('content'));
                showToast(`âœ… å·²æ–°å¢ ${code}ï¼Œè«‹è¼¸å…¥æ­£ç¢ºåŒ¯ç‡ï¼`);
            }
        }

        function updateExchangeRate(code) {
            const newRate = parseFloat(document.getElementById(`rate-${code}`).value);
            if (isNaN(newRate) || newRate <= 0) {
                return showToast('âŒ åŒ¯ç‡å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ­£æ•¸ï¼');
            }
            
            data.exchangeRates[code] = newRate;
            
            // é‡æ–°è¨ˆç®—æ‰€æœ‰è¨˜å¸³çš„ baseAmount (åªé‡æ–°è¨ˆç®—æ¶‰åŠè©²å¹£åˆ¥çš„å¸³ç›®)
            data.bills.forEach(bill => {
                if (bill.currency === code) {
                    bill.baseAmount = convertToBase(bill.amount, bill.currency);
                }
            });

            saveData();
            showToast(`âœ… ${code} åŒ¯ç‡å·²æ›´æ–°ï¼`);
        }

        function removeExchangeRate(code) {
            if (data.bills.some(b => b.currency === code)) {
                 return showToast(`âŒ ç„¡æ³•ç§»é™¤ï¼Œä»æœ‰è¨˜å¸³ä½¿ç”¨ ${code} ä½œç‚ºå¹£åˆ¥ï¼`);
            }
            if (confirm(`ç¢ºå®šè¦ç§»é™¤ ${code} çš„åŒ¯ç‡è¨­å®šå—ï¼Ÿ`)) {
                delete data.exchangeRates[code];
                saveData();
                renderSettingsPage(document.getElementById('content'));
                showToast(`ğŸ—‘ï¸ ${code} åŒ¯ç‡å·²ç§»é™¤ï¼`);
            }
        }
        
        function exportData() {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // å–å¾—æ—¥æœŸæ™‚é–“ä½œç‚ºæª”å
            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            
            a.href = url;
            a.download = `æ—…è¡Œè¨˜å¸³æœ¬_å‚™ä»½_${data.tripName}_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ğŸ’¾ è³‡æ–™å·²å‚™ä»½ï¼');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // åŸ·è¡ŒåŸºæœ¬æª¢æŸ¥ç¢ºä¿æ˜¯æœ¬æ‡‰ç”¨ç¨‹å¼çš„è³‡æ–™æ ¼å¼
                    if (!importedData.members || !importedData.bills || !importedData.tripName) {
                        return showToast('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿åŒ¯å…¥çš„æ˜¯æ­£ç¢ºçš„å‚™ä»½ JSON æª”æ¡ˆã€‚');
                    }
                    
                    if (confirm('ç¢ºå®šè¦è¦†è“‹ç•¶å‰æ‰€æœ‰æ•¸æ“šä¸¦é‚„åŸå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) {
                        // åŸ·è¡Œé‚„åŸ
                        data = importedData;
                        saveData();
                        
                        // ç¢ºä¿åŒ¯ç‡è¡¨æœ‰åŸºæº–å¹£åˆ¥
                        data.exchangeRates[data.baseCurrency] = 1;

                        // é‡æ–°è¨ˆç®—æ‰€æœ‰ baseAmount (ç¢ºä¿åŒ¯ç‡æ­£ç¢ºå¾Œï¼Œæ•¸æ“šèƒ½ä¿æŒä¸€è‡´æ€§)
                        data.bills.forEach(bill => {
                            bill.baseAmount = convertToBase(bill.amount, bill.currency);
                        });
                        
                        showToast('ğŸ‰ è³‡æ–™é‚„åŸæˆåŠŸï¼æ­£åœ¨é‡æ–°è¼‰å…¥...');
                        // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰UI
                        initApp();
                    }
                } catch (error) {
                    console.error('åŒ¯å…¥æ•¸æ“šè§£æéŒ¯èª¤:', error);
                    showToast('âŒ åŒ¯å…¥æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚');
                }
            };
            reader.readAsText(file);
            // æ¸…ç©º file input çš„å€¼ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸å–åŒä¸€å€‹æª”æ¡ˆ
            event.target.value = ''; 
        }

        function confirmResetAll() {
            if (confirm('âš ï¸ è­¦å‘Šï¼ç¢ºå®šè¦ã€Œæ¸…é™¤æ‰€æœ‰æ•¸æ“šã€ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰ç´€éŒ„ï¼Œç„¡æ³•é‚„åŸï¼')) {
                if (prompt('è«‹è¼¸å…¥ã€Œæ¸…é™¤æ‰€æœ‰ã€ä»¥ç¢ºèªåŸ·è¡Œ:') === 'æ¸…é™¤æ‰€æœ‰') {
                    localStorage.removeItem(STORAGE_KEY);
                    data = initializeData();
                    initApp();
                    showToast('ğŸ’£ æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼Œå·²é‡è¨­ç‚ºåˆå§‹ç‹€æ…‹ï¼');
                } else {
                    showToast('æ“ä½œå·²å–æ¶ˆã€‚');
                }
            }
        }
        
        // --- æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ---
        function initApp() {
            loadData();
            // å¦‚æœæ²’æœ‰æˆå“¡ï¼Œå‰‡æ–°å¢ä¸€å€‹é è¨­æˆå“¡
            if (data.members.length === 0) {
                 const initialMember = initializeData().members[0];
                 data.members.push(initialMember);
                 data.nextMemberId = 2;
                 saveData();
            }
            renderTabs();
            // é è¨­å°èˆªåˆ°è¨˜å¸³é é¢
            switchTab('account'); 
        }

        // å•Ÿå‹•æ‡‰ç”¨
        initApp();
        
    </script>
</body>
</html>
